<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="google-site-verification" content="IDYUPnBNhdnU8o9LRNKZ1RSt14tIxTI0rLeMrBtswXw"><title> Iterators 与 for-of 循环 · Fish</title><meta name="description" content="Iterators 与 for-of 循环 - Fish"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/posts/favicon.png"><link rel="stylesheet" href="/posts/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://icyfish.github.io/posts/atom.xml" title="Fish"><meta name="generator" content="Hexo 7.0.0-rc1"></head><body><div class="wrap"><header><a href="/posts/" class="logo-link"><img src="/posts/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/posts/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/posts/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/posts/about/" target="_self" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="http://twitter.com/icyfish_" target="_blank" class="nav-list-link">TWITTER</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Iterators 与 for-of 循环</h1><div class="post-info">Jan 2, 2018</div><div class="post-content"><p>Iterators 与 for-of 循环</p>
<a id="more"></a>
<h2 id="循环遍历数组的几种方式"><a href="#循环遍历数组的几种方式" class="headerlink" title="循环遍历数组的几种方式"></a>循环遍历数组的几种方式</h2><h3 id="for循环"><a href="#for循环" class="headerlink" title="for循环"></a>for循环</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> myArray = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> index = <span class="number">0</span>; index &lt; myArray.length; index++) &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(myArray[index]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ES5-forEach"><a href="#ES5-forEach" class="headerlink" title="ES5 forEach"></a>ES5 forEach</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> myArray = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line">myArray.forEach(<span class="function"><span class="keyword">function</span> (<span class="params">value</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(value);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>forEach的内部函数<strong>无法使用 <code>break</code> 或 <code>return</code></strong>(?)</p>
<h2 id="for-in"><a href="#for-in" class="headerlink" title="for-in"></a>for-in</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> myArray = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> index <span class="keyword">in</span> myArray) &#123;  </span><br><span class="line">  <span class="built_in">console</span>.log(myArray[index]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>用<code>for–in</code>循环遍历数组不可取: </p>
<ul>
<li><p>index是字符串而不是数字: <code>&quot;0&quot;</code>, <code>&quot;1&quot;</code>, <code>&quot;2&quot;</code>等</p>
</li>
<li><p>有时候不以正常的顺序循环遍历</p>
</li>
<li><p>无法正常遍历某些数组, 如: </p>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = [] </span><br><span class="line">a[<span class="number">5</span>] = <span class="number">3</span> </span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; a.length; i++) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(a[i]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* 正常for循环结果:</span></span><br><span class="line"><span class="comment">   undefined</span></span><br><span class="line"><span class="comment">   undefined</span></span><br><span class="line"><span class="comment">   undefined</span></span><br><span class="line"><span class="comment">   undefined</span></span><br><span class="line"><span class="comment">   undefined</span></span><br><span class="line"><span class="comment">   3</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = []</span><br><span class="line">a[<span class="number">5</span>] = <span class="number">3</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> x <span class="keyword">in</span> a) &#123;</span><br><span class="line">    <span class="comment">// 忽略了数组元素中的前5个元素, 只有3被输出</span></span><br><span class="line">    <span class="built_in">console</span>.log(a[x])</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* for-in结果:</span></span><br><span class="line"><span class="comment">   3</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<ul>
<li>数组中若有<strong>可枚举属性(enumerable property)?</strong>,也会被遍历</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Array</span>.prototype.foo = <span class="number">1</span></span><br><span class="line"><span class="keyword">var</span> a = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> x <span class="keyword">in</span> a)&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(x)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* 输出:</span></span><br><span class="line"><span class="comment">   0</span></span><br><span class="line"><span class="comment">   1</span></span><br><span class="line"><span class="comment">   2</span></span><br><span class="line"><span class="comment">   3</span></span><br><span class="line"><span class="comment">   4</span></span><br><span class="line"><span class="comment">   foo</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<h3 id="for-of"><a href="#for-of" class="headerlink" title="for-of"></a>for-of</h3><ul>
<li>遍历数组最简单直接的方式</li>
<li>没有 <code>for-in</code>, <code>forEach</code>存在的那些缺陷</li>
<li><p>与<code>for-in</code>的区别:<br><code>for-in</code>循环遍历对象属性<br><code>for–of</code>循环遍历数据(如数组中的各个元素)</p>
</li>
<li><p><code>for-of</code>还可以循环遍历其它类型的集合, 如类数组对象: NodeLists, 字符串等:</p>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> chr <span class="keyword">of</span> <span class="string">"😺😲"</span>) &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(chr)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>也可以用于遍历<code>Set</code>和<code>Map</code>对象:</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> words = [<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>]</span><br><span class="line"><span class="keyword">var</span> uniqueWords = <span class="keyword">new</span> <span class="built_in">Set</span>(words)</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">var</span> word <span class="keyword">in</span> uniqueWords)&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(word)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>  对于<code>Map</code>对象, 需要先解构再遍历: </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> [key, value] <span class="keyword">of</span> phoneBookMap) &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(key + <span class="string">"'s phone number is: "</span> + value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>不过<code>for-of</code>不可直接用于遍历一般的对象(plain object), 如果想要遍历这种对象的属性, 应该借助<code>for-in</code>或者<code>Object.keys()</code>:</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> someObject = &#123; <span class="number">0</span>: <span class="string">'a'</span>, <span class="number">1</span>: <span class="string">'b'</span>, <span class="number">2</span>: <span class="string">'c'</span>, <span class="string">'hello'</span>: <span class="string">'world'</span> &#125;;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> key <span class="keyword">of</span> <span class="built_in">Object</span>.keys(someObject)) &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(key + <span class="string">": "</span> + someObject[key]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="for-of的原理"><a href="#for-of的原理" class="headerlink" title="for-of的原理"></a><code>for-of</code>的原理</h4><p><code>for-of</code>通过调用对象方法起作用, <code>Array</code>, <code>Map</code>, <code>Set</code>等可遍历的对象都有个共同特点, 它们有<strong>遍历器(iterator)</strong>方法. </p>
<p><code>for-of</code>无法遍历一般的对象是因为一般对象的属性中没有遍历器方法, 不过我们可以手动在对象原型中添加该方法<code>myObject[Symbol.iterator]()</code>, 就能够使该对象可以被<code>for-of</code>循环遍历:</p>
<p>使用<code>for–of</code>循环遍历对象, 首先调用了<code>[Symbol.iterator]()</code>方法, 调用后的结果是返回一个新的可遍历的对象, 这个对象的属性中有个<code>next()</code>方法, <code>for-of</code>在每一次循环中都会调用一次该方法. 以下是一个简单的可遍历对象的例子:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> zeroesForeverIterator = &#123;</span><br><span class="line">  [<span class="built_in">Symbol</span>.iterator]: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">  &#125;,</span><br><span class="line">  next: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="attr">done</span>: <span class="literal">false</span>, <span class="attr">value</span>: <span class="number">0</span>&#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于以上的对象, 每次<code>next()</code>被调用, 都会返回同样的结果, 告诉<code>for-of</code>循环: 1).遍历还未结束; 2). 下一个值是0.<br>此时,<code>for (value of zeroesForeverIterator) {}</code>就是个无限循环.</p>
<p>含有遍历器方法的对象还实现了可选的<code>.return()</code>方法和<code>.throw(exc)</code>方法. 如果循环由于抛出异常或<code>break</code>或<code>return</code>声明过早退出, <code>for-of</code>会调用<code>.return()</code>. 不过大部分情况下, 不需要用到<code>.return()</code>方法, <code>.throw(exc)</code>更特殊, <code>for-of</code>从不调用该方法. (more about it?)</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (VAR <span class="keyword">of</span> ITERABLE) &#123;</span><br><span class="line">  STATEMENTS</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上<code>for-of</code>循环, 实际上执行的操作是(简单版本): </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> $iterator = ITERABLE[<span class="built_in">Symbol</span>.iterator]();</span><br><span class="line"><span class="keyword">var</span> $result = $iterator.next();</span><br><span class="line"><span class="keyword">while</span> (!$result.done) &#123;</span><br><span class="line">  VAR = $result.value;</span><br><span class="line">  STATEMENTS</span><br><span class="line">  $result = $iterator.next();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上只是简单的版本, 大致体现了<code>for-of</code>是如何实现的, 实际上更复杂, 但对于理解上并没有太大的帮助, 因此省略某些方法的实现(例如是如何处理<code>return()</code>的). <code>for-of</code>很好用, 但是底层的实现比较复杂.</p>
<h4 id="使用for-of"><a href="#使用for-of" class="headerlink" title="使用for-of"></a>使用<code>for-of</code></h4><p>截至原文完成的时间<strong>(2015-04-29)</strong>, 某些浏览器还不支持<code>for-of</code>, 在Chrome中, 可打开<code>chrome://flags</code>找到“Experimental JavaScript”并进行启用. 在服务端想要使用该特性, 在执行Node指令时加上<code>--harmony</code>选项. </p>
<h2 id="Resources"><a href="#Resources" class="headerlink" title="Resources"></a>Resources</h2><ul>
<li><a href="https://hacks.mozilla.org/2015/04/es6-in-depth-iterators-and-the-for-of-loop/" target="_blank" rel="noopener">Iterators and the for-of loop</a></li>
</ul>
<p>Next articles will be: </p>
<ul>
<li><p><a href="https://hacks.mozilla.org/2015/05/es6-in-depth-generators/" target="_blank" rel="noopener">Generators</a> in <a href="https://hacks.mozilla.org/author/jorendorffmozillacom/page/2/" target="_blank" rel="noopener">ES6 In Depth</a>.</p>
</li>
<li><p>CSS Modules </p>
</li>
</ul>
<p>Questions In This Article: <code>cmd + f</code> + <code>?</code></p>
</div></article></div></main><footer><div class="paginator"><a href="/posts/2018/01/18/react-ref/" class="prev">PREV</a><a href="/posts/2017/12/25/script-error/" class="next">NEXT</a></div><div class="copyright"><p>© 2019 - 2023 <a href="https://icyfish.github.io/posts">Fish</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>