<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="google-site-verification" content="IDYUPnBNhdnU8o9LRNKZ1RSt14tIxTI0rLeMrBtswXw"><title> CORS · Fish</title><meta name="description" content="CORS - Fish"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/posts/favicon.png"><link rel="stylesheet" href="/posts/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://icyfish.github.io/posts/atom.xml" title="Fish"><meta name="generator" content="Hexo 7.0.0-rc1"></head><body><div class="wrap"><header><a href="/posts/" class="logo-link"><img src="/posts/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/posts/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/posts/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/posts/about/" target="_self" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="http://twitter.com/icyfish_" target="_blank" class="nav-list-link">TWITTER</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">CORS</h1><div class="post-info">Aug 11, 2017</div><div class="post-content"><p>CORS(Cross-Origin Resource Sharing 跨域资源共享)</p>
<a id="more"></a>
<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>实现跨域请求有多种方式, 如使用<a href="https://en.wikipedia.org/wiki/JSONP" target="_blank" rel="noopener">JSONP</a>, 但由于安全原因, JSONP在使用上有很大限制, 还能通过设置代理, 但这种方式在实现上很繁琐, 而且难以维护. </p>
<p><a href="https://www.w3.org/TR/cors/" target="_blank" rel="noopener">CORS</a>标准是实现跨域请求比较好的一种方式, 基于<code>XMLHttpRequest</code>对象实现. 想要做出CORS请求, 需要客户端和服务器端合作进行配置. </p>
<h2 id="做出CORS请求"><a href="#做出CORS请求" class="headerlink" title="做出CORS请求"></a>做出CORS请求</h2><p>使用JavaScript作出跨域请求:</p>
<h3 id="创建XMLHttpRequest对象"><a href="#创建XMLHttpRequest对象" class="headerlink" title="创建XMLHttpRequest对象"></a>创建XMLHttpRequest对象</h3><p><a href="http://caniuse.com/#search=cors" target="_blank" rel="noopener">点击查看支持CORS的浏览器列表</a>, Chrome, Firefox, Opera 和 Safari使用<a href="https://www.html5rocks.com/en/tutorials/file/xhr2/" target="_blank" rel="noopener">XMLHttpRequest2</a>对象, IE使用相类似的<code>XDomainRequest</code>对象, 工作原理基本相似, 不过额外添加了一些<a href="http://blogs.msdn.com/b/ieinternals/archive/2010/05/13/xdomainrequest-restrictions-limitations-and-workarounds.aspx" target="_blank" rel="noopener">安全措施</a>.</p>
<p>首先创建请求对象, Nicholas Zakas 实现了<a href="https://www.nczonline.net/blog/2010/05/25/cross-domain-ajax-with-cross-origin-resource-sharing/" target="_blank" rel="noopener">一个简单的辅助函数</a>以区分浏览器的差异:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createCORSRequest</span>(<span class="params">method, url</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> xhr = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">  <span class="keyword">if</span> (<span class="string">"withCredentials"</span> <span class="keyword">in</span> xhr) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check if the XMLHttpRequest object has a "withCredentials" property.</span></span><br><span class="line">    <span class="comment">// 检查 XMLHttpRequest 对象含有 withCredentials 属性</span></span><br><span class="line">    <span class="comment">// withCredentials 属性只存在于 XMLHTTPRequest2 对象中</span></span><br><span class="line">    </span><br><span class="line">    xhr.open(method, url, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> XDomainRequest != <span class="string">"undefined"</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// XDomainRequest 对象只存在于 IE 浏览器</span></span><br><span class="line">    xhr = <span class="keyword">new</span> XDomainRequest();</span><br><span class="line">    xhr.open(method, url);</span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 该浏览器不支持 CORS </span></span><br><span class="line">    xhr = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> xhr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> xhr = createCORSRequest(<span class="string">'GET'</span>, url);</span><br><span class="line"><span class="keyword">if</span> (!xhr) &#123;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'CORS not supported'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="事件处理器"><a href="#事件处理器" class="headerlink" title="事件处理器"></a>事件处理器</h3><p>原始的<code>XMLHttpRequest</code>对象只存在一个事件处理器: <code>onreadystatechange</code>, 会处理所有的响应. 现在<code>onreadystatechange</code>依然可用, 不过<code>XMLHttpRequest2</code>对象引入了许多新的事件处理器. 以下是完整列表:</p>
<table>
<thead>
<tr>
<th><strong>Event Handler</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>onloadstart*</td>
<td>When the request starts.</td>
</tr>
<tr>
<td>onprogress</td>
<td>While loading and sending data.</td>
</tr>
<tr>
<td>onabort*</td>
<td>When the request has been aborted. For instance, by invoking the abort() method.</td>
</tr>
<tr>
<td>onerror</td>
<td>When the request has failed.</td>
</tr>
<tr>
<td>onload</td>
<td>When the request has successfully completed.</td>
</tr>
<tr>
<td>ontimeout</td>
<td>When the author specified timeout has passed before the request could complete.</td>
</tr>
<tr>
<td>onloadend*</td>
<td>When the request has completed (either in success or failure).</td>
</tr>
</tbody>
</table>
<p><code>*</code>星号表示XDomainRequest不支持, 具体见: <a href="https://www.w3.org/TR/XMLHttpRequest2/#events" target="_blank" rel="noopener">来源</a></p>
<h3 id="withCredentials"><a href="#withCredentials" class="headerlink" title="withCredentials"></a>withCredentials</h3><p>一般来说, CORS请求默认不发送/设置任何cookie. 前端使用<code>xhr.withCredentials = true;</code>以配置包含cookie. 同时服务器这样配置: <code>Access-Control-Allow-Credentials: true</code>.</p>
<p>The .withCredentials property will include any cookies from the remote domain in the request, and it will also set any cookies from the remote domain. 这些cookie仍然遵循同源策略, JS代码无法通过<code>document.cookie</code>或响应头部获取这些cookie. 只能由 remote domain 控制. </p>
<h3 id="发送请求"><a href="#发送请求" class="headerlink" title="发送请求"></a>发送请求</h3><p>配置好后就可以发出请求. 使用: <code>xhr.send()</code>, 如果包含请求体, 可在参数中声明<code></code>xhr.send(body)`.</p>
<h3 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Create the XHR object.</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createCORSRequest</span>(<span class="params">method, url</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> xhr = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">  <span class="keyword">if</span> (<span class="string">"withCredentials"</span> <span class="keyword">in</span> xhr) &#123;</span><br><span class="line">    <span class="comment">// XHR for Chrome/Firefox/Opera/Safari.</span></span><br><span class="line">    xhr.open(method, url, <span class="literal">true</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> XDomainRequest != <span class="string">"undefined"</span>) &#123;</span><br><span class="line">    <span class="comment">// XDomainRequest for IE.</span></span><br><span class="line">    xhr = <span class="keyword">new</span> XDomainRequest();</span><br><span class="line">    xhr.open(method, url);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// CORS not supported.</span></span><br><span class="line">    xhr = <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> xhr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Helper method to parse the title tag from the response.</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getTitle</span>(<span class="params">text</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> text.match(<span class="string">'&lt;title&gt;(.*)?&lt;/title&gt;'</span>)[<span class="number">1</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Make the actual CORS request.</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">makeCorsRequest</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// This is a sample server that supports CORS.</span></span><br><span class="line">  <span class="keyword">var</span> url = <span class="string">'http://html5rocks-cors.s3-website-us-east-1.amazonaws.com/index.html'</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> xhr = createCORSRequest(<span class="string">'GET'</span>, url);</span><br><span class="line">  <span class="keyword">if</span> (!xhr) &#123;</span><br><span class="line">    alert(<span class="string">'CORS not supported'</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Response handlers.</span></span><br><span class="line">  xhr.onload = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> text = xhr.responseText;</span><br><span class="line">    <span class="keyword">var</span> title = getTitle(text);</span><br><span class="line">    alert(<span class="string">'Response from CORS request to '</span> + url + <span class="string">': '</span> + title);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  xhr.onerror = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    alert(<span class="string">'Woops, there was an error making the request.'</span>);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  xhr.send();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="服务器添加跨域支持"><a href="#服务器添加跨域支持" class="headerlink" title="服务器添加跨域支持"></a>服务器添加跨域支持</h2><p>浏览器有时候会添加额外的首部做出额外的请求, 客户端无法知道这些额外的请求, 但是可以使用类似<a href="https://www.wireshark.org/" target="_blank" rel="noopener">Wireshark</a> 的 packet 分析器发现这些请求. 这些请求是Preflight request(以下译为预先请求).</p>
<p><img src="/posts/images/cors_flow.png" alt="cors_flow"></p>
<h3 id="Preflight-request"><a href="#Preflight-request" class="headerlink" title="Preflight request"></a>Preflight request</h3><p>做出正式CORS请求之前的预先请求, 作用是检查CORS协议是否被理解. </p>
<p>预先请求属于HTTP OPTIONS请求, OPTIONS请求服务器告知其支持的各种功能, 可以询问服务器通常支持哪些方法, 或者对某些特殊资源支持哪些方法. (有些服务器可能只支持对一些特殊类型的对象使用特定的操作). 预先请求首部包括 <code>Access-Control-Request-Method</code>, <code>Access-Control-Request-Headers</code> 以及 <code>Origin</code>. </p>
<p>浏览器会在必要时发出预先请求, 一般情况下, 前端开发者无需在代码中手动添加预先请求. </p>
<p>比如浏览器会在发出<code>DELETE</code>请求之前发出预先请求, 事先检测服务器是否允许<code>DELETE</code>请求, 请求首部内容如下:</p>
<figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">OPTIONS /resource/foo </span><br><span class="line">Access-Control-Request-<span class="function"><span class="keyword">Method</span>:</span> DELETE </span><br><span class="line">Access-Control-Request-Headers: origin, x-requested-<span class="keyword">with</span></span><br><span class="line">Origin: https:<span class="comment">//foo.bar.org</span></span><br></pre></td></tr></table></figure>
<p>如果服务器允许<code>DELETE</code>请求, 会对预先请求做出如下的响应, <code>Access-Control-Allow-Methods</code>的值就会包含<code>DELETE</code>方法:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">HTTP/1.1</span> <span class="number">200</span> <span class="string">OK</span></span><br><span class="line"><span class="attr">Content-Length:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">Connection:</span> <span class="string">keep-alive</span></span><br><span class="line"><span class="attr">Access-Control-Allow-Origin:</span> <span class="string">https://foo.bar.org</span></span><br><span class="line"><span class="attr">Access-Control-Allow-Methods:</span> <span class="string">POST,</span> <span class="string">GET,</span> <span class="string">OPTIONS,</span> <span class="string">DELETE</span></span><br><span class="line"><span class="attr">Access-Control-Max-Age:</span> <span class="number">86400</span></span><br></pre></td></tr></table></figure>
<p><strong>CORS Preflight request 示例</strong></p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">OPTIONS <span class="regexp">/resources/</span>post-here<span class="regexp">/ HTTP/</span><span class="number">1.1</span> </span><br><span class="line"><span class="string">Host:</span> bar.other </span><br><span class="line"><span class="string">Accept:</span> text<span class="regexp">/html,application/</span>xhtml+xml,application<span class="regexp">/xml;q=0.9,*/</span>*;q=<span class="number">0.8</span> </span><br><span class="line">Accept-<span class="string">Language:</span> en-us,en;q=<span class="number">0.5</span> </span><br><span class="line">Accept-<span class="string">Encoding:</span> gzip,deflate </span><br><span class="line">Accept-<span class="string">Charset:</span> ISO<span class="number">-8859</span><span class="number">-1</span>,utf<span class="number">-8</span>;q=<span class="number">0.7</span>,*;q=<span class="number">0.7</span> </span><br><span class="line"><span class="string">Connection:</span> keep-alive </span><br><span class="line"><span class="string">Origin:</span> <span class="string">http:</span><span class="comment">//foo.example </span></span><br><span class="line">Access-Control-Request-<span class="string">Method:</span> POST </span><br><span class="line">Access-Control-Request-<span class="string">Headers:</span> X-PINGOTHER, Content-Type</span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">HTTP/1.1</span> <span class="number">200</span> <span class="string">OK</span></span><br><span class="line"><span class="attr">Date:</span> <span class="string">Mon,</span> <span class="number">01</span> <span class="string">Dec</span> <span class="number">2008</span> <span class="number">01</span><span class="string">:15:39</span> <span class="string">GMT</span> </span><br><span class="line"><span class="attr">Server:</span> <span class="string">Apache/2.0.61</span> <span class="string">(Unix)</span> </span><br><span class="line"><span class="attr">Access-Control-Allow-Origin:</span> <span class="string">http://foo.example</span> </span><br><span class="line"><span class="attr">Access-Control-Allow-Methods:</span> <span class="string">POST,</span> <span class="string">GET,</span> <span class="string">OPTIONS</span> </span><br><span class="line"><span class="attr">Access-Control-Allow-Headers:</span> <span class="string">X-PINGOTHER,</span> <span class="string">Content-Type</span> </span><br><span class="line"><span class="attr">Access-Control-Max-Age:</span> <span class="number">86400</span> </span><br><span class="line"><span class="attr">Vary:</span> <span class="string">Accept-Encoding,</span> <span class="string">Origin</span> </span><br><span class="line"><span class="attr">Content-Encoding:</span> <span class="string">gzip</span> </span><br><span class="line"><span class="attr">Content-Length:</span> <span class="number">0</span> </span><br><span class="line"><span class="attr">Keep-Alive:</span> <span class="string">timeout=2,</span> <span class="string">max=100</span> </span><br><span class="line"><span class="attr">Connection:</span> <span class="string">Keep-Alive</span> </span><br><span class="line"><span class="attr">Content-Type:</span> <span class="string">text/plain</span></span><br></pre></td></tr></table></figure>
<h3 id="跨域请求类型"><a href="#跨域请求类型" class="headerlink" title="跨域请求类型"></a>跨域请求类型</h3><p>跨域请求有两种类型:</p>
<ul>
<li>简单跨域请求</li>
<li>复杂跨域请求</li>
</ul>
<h4 id="处理简单跨域请求"><a href="#处理简单跨域请求" class="headerlink" title="处理简单跨域请求"></a>处理简单跨域请求</h4><p>简单跨域请求遵循以下规则:</p>
<ul>
<li><p>HTTP方法匹配以下任意一个(大小写敏感):</p>
<ul>
<li>HEAD</li>
<li>GET</li>
<li>POST</li>
</ul>
</li>
<li><p>HTTP首部匹配以下内容:</p>
<ul>
<li>Accept</li>
<li>Accept-Language</li>
<li>Content-Language</li>
<li>Last-Event-ID</li>
<li>Content-Type(值必须为以下其中一个)<ul>
<li>application/x-www-form-urlencoded</li>
<li>multipart/form-data</li>
<li>text/plain</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>之所以叫简单跨域请求, 是因为这些请求不使用CORS机制也可完成. JSONP请求就属于简单跨域请求(GET). 表单提交也属于简单跨域请求(POST).</p>
<p>观察客户端发出的一个简单请求, 以下是相关JS代码:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> url = <span class="string">'http://api.alice.com/cors'</span>;</span><br><span class="line"><span class="keyword">var</span> xhr = createCORSRequest(<span class="string">'GET'</span>, url);</span><br><span class="line">xhr.send();</span><br></pre></td></tr></table></figure>
<p>以下是浏览器发出的HTTP请求, 与CORS相关的首部使用<code>**</code>标记:</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET <span class="regexp">/cors HTTP/</span><span class="number">1.1</span></span><br><span class="line">**<span class="string">Origin:</span> <span class="string">http:</span><span class="comment">//api.bob.com**</span></span><br><span class="line"><span class="string">Host:</span> api.alice.com</span><br><span class="line">Accept-<span class="string">Language:</span> en-US</span><br><span class="line"><span class="string">Connection:</span> keep-alive</span><br><span class="line">User-<span class="string">Agent:</span> Mozilla/<span class="number">5.0</span>...</span><br></pre></td></tr></table></figure>
<p>合法的跨域请求<strong>总是</strong>包含<code>Origin</code>头部, 由浏览器自动添加, 用户可以对其进行修改. </p>
<p>所有跨域请求一定都包含<code>Origin</code>首部, 但是并非所有包含<code>Origin</code>首部的请求都是跨域请求, 某些同源请求也会有<code>Origin</code>首部. Firefox浏览器不会对同源请求添加<code>Origin</code>首部, 而Chrome和Safari则会对同源的POST/PUT/DELETE请求添加该首部(同源GET请求没有该首部). 以下是包含<code>Origin</code>首部的一个同源请求例子:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/cors</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Origin</span>: http://api.bob.com</span><br><span class="line"><span class="attribute">Host</span>: api.bob.com</span><br></pre></td></tr></table></figure>
<p>不管响应是否包含跨域相关的首部, 同源请求的响应都会直接发送给客户端. 尽管如此, 如果<code>Origin</code>的值与所允许的不匹配, 服务器端的代码就会返回错误, 因此要确保允许请求的来源的<code>Origin</code>. </p>
<p>以下是个合法的服务器响应:</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">**Access-Control-Allow-<span class="string">Origin:</span> <span class="string">http:</span><span class="comment">//api.bob.com**</span></span><br><span class="line">**Access-Control-Allow-<span class="string">Credentials:</span> <span class="literal">true</span>**</span><br><span class="line">**Access-Control-Expose-<span class="string">Headers:</span> FooBar**</span><br><span class="line">Content-<span class="string">Type:</span> text/html; charset=utf<span class="number">-8</span></span><br></pre></td></tr></table></figure>
<p>所有CORS相关的首部前缀均为: <code>&quot;Access-Control-&quot;</code>. 以下是各个首部的详细内容:</p>
<p><code>Access-Control-Allow-Origin</code>(必需) - 所有合法的跨域请求都必须包含该首部, 省略该首部会导致跨域请求失败. 该首部的值可以是HTTP请求中<code>Origin</code>首部的值, 也可以是<code>*</code>以表示允许来自所有origin的请求. </p>
<p><code>Access-Control-Allow-Credentials</code>(可选) - 默认情况下, 跨域请求不包含cookie. 该首部值若为true, 则请求中就需要包含cookie. 首部唯一合法的值也是true. 如果不需要包含cookie, 正确方式是不要加上这个首部, 而不是将其值设为false.</p>
<p><code>Access-Control-Allow-Credentials</code>首部和XMLHttpRequest2对象的属性<code>withCredentials</code>结合工作, 如果<code>withCredentials</code>为true, 而响应中不含<code>Access-Control-Allow-Credentials: true</code>首部, 那么该跨域请求则会失败. 反之亦然. 推荐做法是如果不需要cookie, 就不要设置该首部. </p>
<p><code>Access-Control-Expose-Headers</code>(可选) -  XMLHttpRequest 2 对象有一个<code>getResponseHeader()</code>方法, 返回特定的响应首部值. 在执行CORS请求过程中, <code>getResponseHeader()</code>方法只能获取简单响应首部的值, 简单响应首部包括以下几项:</p>
<ul>
<li>Cache-Control</li>
<li>Content-Language</li>
<li>Content-Type</li>
<li>Expires</li>
<li>Last-Modified</li>
<li>Pragma</li>
</ul>
<p>如果希望客户端能够获取到其他响应首部的值, 就要使用<code>Access-Control-Expose-Headers</code> - 该首部的值为以逗号分隔的一系列首部名.</p>
<h4 id="处理复杂跨域请求"><a href="#处理复杂跨域请求" class="headerlink" title="处理复杂跨域请求"></a>处理复杂跨域请求</h4><p>以上方式处理了简单的GET请求, 但是如果想要处理其他例如PUT, DELETE等请求, 或者希望<code>Content-Type</code>首部的值支持<code>application/json</code>, 就需要处理复杂跨域请求. </p>
<p>复杂跨域请求看似只发送了一个请求, 但是实际上包含两类请求. 浏览器首先发出预先请求, 咨询服务器是否允许发送正式请求, 浏览器会处理这两类请求的具体细节. 预先请求会被缓存, 因此不需要在每一个请求前都发送.</p>
<p>以下是复杂跨域请求的一个例子: </p>
<p><strong>JavaScript:</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> url = <span class="string">'http://api.alice.com/cors'</span>;</span><br><span class="line"><span class="keyword">var</span> xhr = createCORSRequest(<span class="string">'PUT'</span>, url);</span><br><span class="line">xhr.setRequestHeader(</span><br><span class="line">    <span class="string">'X-Custom-Header'</span>, <span class="string">'value'</span>);</span><br><span class="line">xhr.send();</span><br></pre></td></tr></table></figure>
<p><strong>Preflight Request:</strong></p>
<figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">OPTIONS /cors HTTP/<span class="number">1.1</span></span><br><span class="line">**Origin: http:<span class="comment">//api.bob.com**</span></span><br><span class="line">**Access-Control-Request-<span class="function"><span class="keyword">Method</span>:</span> PUT**</span><br><span class="line">**Access-Control-Request-Headers: X-Custom-Header**</span><br><span class="line">Host: api.alice.com</span><br><span class="line">Accept-Language: en-US</span><br><span class="line">Connection: keep-alive</span><br><span class="line">User-Agent: Mozilla/<span class="number">5.0</span>...</span><br></pre></td></tr></table></figure>
<p>和简单请求一样, 浏览器会在每一个请求中添加<code>Origin</code>首部, 包括预先请求. 预先请求是HTTP OPTIONS请求(因此要确保服务器能够对该HTTP请求做出响应). OPTIONS也包含几个额外的首部:</p>
<p><code>Access-Control-Request-Method</code> - 实际HTTP请求的方法, 该首部始终会包含在请求的请求首部, 即使是之前定义的简单HTTP请求(GET, POST, HEAD).</p>
<p><code>Access-Control-Request-Headers</code> - 该首部的值为以逗号分隔的一系列非简单首部名.</p>
<p>预先请求的作用是检测正式请求是否能够成功被发送. 服务器需要检视这两种请求以确保首部的合法性. </p>
<p>如果HTTP方法和首部都合法, 服务器的请求和响应应如下所示:</p>
<p><strong>Preflight Request:</strong></p>
<figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">OPTIONS /cors HTTP/<span class="number">1.1</span></span><br><span class="line">**Origin: http:<span class="comment">//api.bob.com**</span></span><br><span class="line">**Access-Control-Request-<span class="function"><span class="keyword">Method</span>:</span> PUT**</span><br><span class="line">**Access-Control-Request-Headers: X-Custom-Header**</span><br><span class="line">Host: api.alice.com</span><br><span class="line">Accept-Language: en-US</span><br><span class="line">Connection: keep-alive</span><br><span class="line">User-Agent: Mozilla/<span class="number">5.0</span>...</span><br></pre></td></tr></table></figure>
<p><strong>Preflight Response:</strong></p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">**<span class="keyword">Access</span>-Control-Allow-Origin: http://api.bob.com**</span><br><span class="line">**<span class="keyword">Access</span>-Control-Allow-Methods: <span class="keyword">GET</span>, POST, PUT**</span><br><span class="line">**<span class="keyword">Access</span>-Control-Allow-Headers: X-Custom-<span class="keyword">Header</span>**</span><br><span class="line">Content-<span class="keyword">Type</span>: <span class="type">text</span>/html; charset=utf<span class="number">-8</span></span><br></pre></td></tr></table></figure>
<p><code>Access-Control-Allow-Origin</code>(必需) - 与简单响应一样, 预先响应必须包含该首部. </p>
<p><code>Access-Control-Allow-Methods</code>(必需) - 以逗号分隔的所支持的HTTP方法. 尽管预先请求只是获取许可的一个简单HTTP请求, 但响应首部中必须要列出所有支持的HTTP方法. 这个首部有很大用处, 因为预先请求的响应会存入缓存中, 因此预先响应中可以包含多个请求类型的细节信息. </p>
<p><code>Access-Control-Allow-Headers</code>(如果请求中包含<code>Access-Control-Request-Headers</code>首部, 则该响应首部必需) - 以逗号分隔的所支持的请求首部, 与<code>Access-Control-Allow-Methods</code>首部的形式很相似, 会列出所有服务器支持的首部(不仅仅是预先请求中所请求的首部).</p>
<p><code>Access-Control-Allow-Credentials</code>(可选) - 见简单请求.</p>
<p><code>Access-Control-Max-Age</code>(可选) - 表示预先请求的返回结果（即 Access-Control-Allow-Methods和Access-Control-Allow-Headers提供的信息)可以被缓存多久。</p>
<p>一旦预先请求获取服务器许可, 浏览器就会做出正式请求, 正式请求与简单请求很相似, 响应的处理方式也一样.</p>
<p>正式请求:</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">PUT <span class="regexp">/cors HTTP/</span><span class="number">1.1</span></span><br><span class="line">**<span class="string">Origin:</span> <span class="string">http:</span><span class="comment">//api.bob.com**</span></span><br><span class="line"><span class="string">Host:</span> api.alice.com</span><br><span class="line">**X-Custom-<span class="string">Header:</span> value**</span><br><span class="line">Accept-<span class="string">Language:</span> en-US</span><br><span class="line"><span class="string">Connection:</span> keep-alive</span><br><span class="line">User-<span class="string">Agent:</span> Mozilla/<span class="number">5.0</span>...</span><br></pre></td></tr></table></figure>
<p>正式响应:</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">**Access-Control-Allow-<span class="string">Origin:</span> <span class="string">http:</span><span class="comment">//api.bob.com**</span></span><br><span class="line">Content-<span class="string">Type:</span> text/html; charset=utf<span class="number">-8</span></span><br></pre></td></tr></table></figure>
<p>如果服务器拒绝CORS请求, 则会返回类似HTTP 200的响应, 同时没有任何CORS首部. 如果预先请求中的HTTP方法或首部不合法, 服务器也会拒绝该请求. 如果响应中没有CORS专属的首部, 浏览器会假定该请求不合法, 不发送正式请求:</p>
<p><strong>Preflight Request:</strong></p>
<figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">OPTIONS /cors HTTP/<span class="number">1.1</span></span><br><span class="line">**Origin: http:<span class="comment">//api.bob.com**</span></span><br><span class="line">**Access-Control-Request-<span class="function"><span class="keyword">Method</span>:</span> PUT**</span><br><span class="line">**Access-Control-Request-Headers: X-Custom-Header**</span><br><span class="line">Host: api.alice.com</span><br><span class="line">Accept-Language: en-US</span><br><span class="line">Connection: keep-alive</span><br><span class="line">User-Agent: Mozilla/<span class="number">5.0</span>...</span><br></pre></td></tr></table></figure>
<p><strong>Preflight Response:</strong></p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// ERROR - <span class="keyword">No</span> CORS headers, this <span class="keyword">is</span> an invalid request!</span><br><span class="line">Content-<span class="keyword">Type</span>: <span class="type">text</span>/html; charset=utf<span class="number">-8</span></span><br></pre></td></tr></table></figure>
<p>如果CORS请求有错误, 浏览器会执行<code>onerror</code>处理器. 在控制台报出如下错误:</p>
<p><strong>XMLHttpRequest cannot load <a href="http://api.alice.com" target="_blank" rel="noopener">http://api.alice.com</a>. Origin <a href="http://api.bob.com" target="_blank" rel="noopener">http://api.bob.com</a> is not allowed by Access-Control-Allow-Origin.</strong></p>
<p>但浏览器不会报出更详细的错误信息. </p>
<p>CORS请求图示:</p>
<p><img src="/posts/images/cors_server_flowchart.png" alt="cors_server_flowchart"></p>
<h2 id="Chrome插件跨域"><a href="#Chrome插件跨域" class="headerlink" title="Chrome插件跨域"></a>Chrome插件跨域</h2><p>如果希望Chrome插件支持跨域请求, 可以用以下两种方式:</p>
<ol>
<li>在<code>manifest.json</code>文件中添加如下值:</li>
</ol>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">"permissions": [ "http://*.html5rocks.com"]</span><br></pre></td></tr></table></figure>
<p>服务器不需要添加额外CORS首部或者执行任何其他操作. </p>
<ol start="2">
<li>如果域名没有在<code>manifest.json</code>文件中声明, 插件就会做出一般的CORS请求, <code>Origin</code>首部的值为<code>&quot;chrome-extension://[CHROME EXTENSION ID]&quot;</code>. 此时想要执行跨域请求, 就需要使用如前所述的一般方式. </li>
</ol>
<h2 id="CORS-w-Images"><a href="#CORS-w-Images" class="headerlink" title="CORS w/ Images"></a>CORS w/ Images</h2><p>在Canvas或者WebGL下, 跨域请求图片会引起很大的问题, 可以在<img>中添加<code>crossOrigin</code>属性以解决大部分问题. 具体可以阅读<a href="https://blog.chromium.org/2011/07/using-cross-domain-images-in-webgl-and.html" target="_blank" rel="noopener">Chromium Blog: Using Cross-domain images in WebGL</a>和<a href="https://hacks.mozilla.org/2011/11/using-cors-to-load-webgl-textures-from-cross-domain-images/" target="_blank" rel="noopener">Mozilla Hacks: Using CORS to load WebGL textures from cross-domain images</a>. 阅读<a href="https://developer.mozilla.org/en-US/docs/HTML/CORS_Enabled_Image" target="_blank" rel="noopener">CORS enabled image</a>了解其实现方式. </p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="https://www.html5rocks.com/en/tutorials/cors/" target="_blank" rel="noopener">Using CORS</a></li>
<li><a href="https://developer.mozilla.org/en-US/docs/Glossary/Preflight_request" target="_blank" rel="noopener">Preflight request</a></li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Methods/OPTIONS" target="_blank" rel="noopener">OPTIONS</a></li>
</ul>
</div></article></div></main><footer><div class="paginator"><a href="/posts/2017/08/11/300-ms-delay/" class="prev">PREV</a><a href="/posts/2017/07/21/js-inheritance-by-example/" class="next">NEXT</a></div><div class="copyright"><p>© 2019 - 2023 <a href="https://icyfish.github.io/posts">Fish</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>