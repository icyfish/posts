---
title: ç†è§£ useEffect
date: 2021-07-02
permalink: "a-complete-guide-to-useeffect"
---

åŸæ–‡: [A Complete Guide to useEffect](https://overreacted.io/a-complete-guide-to-useeffect/)

- [ ] å®Œå–„ä¸€äº›ä¸å¥½ç¿»è¯‘çš„æ®µè½(æ©™è‰²é«˜äº®æ ‡æ³¨)
- [ ] TLDRéƒ¨åˆ†
## æ­£æ–‡
### æ¯æ¬¡æ¸²æŸ“éƒ½æœ‰è‡ªå·±çš„ Props å’Œ State

å¼€å§‹èŠ effect ä¹‹å‰, æˆ‘ä»¬å…ˆå¼€å§‹èŠä¸€èŠç»„ä»¶çš„æ¸²æŸ“.

ä»¥ä¸‹æ˜¯ä¸€ä¸ªè®¡æ—¶å™¨ç»„ä»¶. å…³æ³¨å…¶ä¸­é«˜äº®çš„éƒ¨åˆ†:

```jsx
function Counter() {
  const [count, setCount] = useState(0)

  return (
    <div>
      // highlight-next-line
      <p>You clicked {count} times</p>
      <button onClick={() => setCount(count + 1)}>Click me</button>
    </div>
  )
}
```

ä»¥ä¸Šçš„ä»£ç å®é™…ä¸Šå‘ç”Ÿäº†ä»€ä¹ˆå‘¢? `count` æ˜¯ä¸æ˜¯åœ¨æ—¶åˆ»å…³æ³¨æˆ‘ä»¬çš„çŠ¶æ€(state)å˜åŒ–, ç„¶åæ ¹æ®è¿™ä¸ªå˜åŒ–è‡ªåŠ¨æ›´æ–°å‘¢? è¿™ä¸ªçŒœæµ‹ååˆ†ç¬¦åˆç›´è§‰, å¦‚æœä½ æ˜¯ React åˆå­¦è€…, è¿™ä¸ªæƒ³æ³•å¯èƒ½ä¼šä¸ºä½ ç†è§£ React å¸¦æ¥æ¯”è¾ƒå¤§çš„å¸®åŠ©. ä½†æ˜¯å®é™…ä¸Š, è¿™ä¸ªç†è§£å¹¶ä¸å‡†ç¡®. æˆ‘å†™è¿‡ä¸€ç¯‡å…³äºè¿™ä¸ªè¯é¢˜çš„æ–‡ç« , è¿™æ‰æ˜¯[å‡†ç¡®çš„å¿ƒæ™ºæ¨¡å‹](https://overreacted.io/react-as-a-ui-runtime/)

**åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­, `count` ä»…ä»…æ˜¯ä¸ªæ•°å­—è€Œå·².** å†…éƒ¨å¹¶æ²¡æœ‰"æ•°æ®ç»‘å®š", "è§‚å¯Ÿè€…", "ä»£ç†"ç­‰ç­‰çš„é€»è¾‘. å°±åƒä¸‹é¢çš„ä»£ç ç¤ºä¾‹ä¸€æ ·, å®ƒä»…ä»…åªæ˜¯ä¸€ä¸ªæ•°å­—:

```jsx
const count = 42
// ...
<p>You clicked {count} times</p>
// ...
```

å½“ç»„ä»¶ç¬¬ä¸€æ¬¡æ¸²æŸ“çš„æ—¶å€™, ä» `useState()` ä¸­è¯»å–åˆ°çš„ `count` æ˜¯ `0`. å½“æˆ‘ä»¬è°ƒç”¨äº† `setCount(1)` ä¹‹å, React ä¼šé‡æ–°è°ƒç”¨æˆ‘ä»¬çš„ç»„ä»¶. è¿™ä¸€æ¬¡ `count` å€¼å°†ä¼šæ˜¯ `1`, ä»¥æ­¤ç±»æ¨:

```jsx
// é¦–æ¬¡æ¸²æŸ“
function Counter() {
  // highlight-next-line
  const count = 0 // useState() è¿”å›çš„å†…å®¹
  // ...
  ;<p>You clicked {count} times</p>
  // ...
}

// ç‚¹å‡»äº‹ä»¶ä¹‹å, å‡½æ•° (Counterç»„ä»¶) å†æ¬¡è¢«è°ƒç”¨
function Counter() {
  // highlight-next-line
  const count = 1 // useState() è¿”å›çš„å†…å®¹
  // ...
  <p>You clicked {count} times</p>
  // ...
}

// ç¬¬äºŒæ¬¡ç‚¹å‡»äº‹ä»¶ä¹‹å, å‡½æ•° (Counterç»„ä»¶) å†æ¬¡è¢«è°ƒç”¨
function Counter() {
  // highlight-next-line
  const count = 2 // useState() è¿”å›çš„å†…å®¹
  // ...
  <p>You clicked {count} times</p>
  // ...
}
```

**æ— è®ºä½•æ—¶, çŠ¶æ€æ›´æ–°ä¹‹å, React éƒ½ä¼šé‡æ–°è°ƒç”¨æˆ‘ä»¬çš„ç»„ä»¶. æ¯ä¸€æ¬¡æ¸²æŸ“çš„ç»“æœéƒ½ä¼š"çœ‹åˆ°"ç»„ä»¶å†…éƒ¨çš„ `count` çŠ¶æ€å€¼, è€Œè¿™ä¸ªå€¼åœ¨å‡½æ•°ä¸­å®é™…ä¸Šæ˜¯ä¸€ä¸ª*å¸¸é‡*.**

æ‰€ä»¥è¯´ä»¥ä¸‹è¿™ä¸€è¡Œä»£ç å¹¶æ²¡æœ‰ä»»ä½•ç‰¹æ®Šçš„æ•°æ®ç»‘å®šé€»è¾‘:

```jsx
<p>You clicked {count} times</p>
```

**å®ƒä»…ä»…åªæ˜¯å°†æ•°å­—çš„å€¼æ·»åŠ åˆ°æ¸²æŸ“ç»“æœä¸­è€Œå·².** è¿™ä¸ªæ•°å­—ç”± React æä¾›. å½“æˆ‘ä»¬è°ƒç”¨ `setCount` çš„æ—¶å€™, React ä¼šç”¨ä¸€ä¸ªæœ€æ–°çš„ `count` å€¼æ¥é‡æ–°è°ƒç”¨æˆ‘ä»¬çš„ç»„ä»¶. ç„¶å React æ›´æ–° DOM, ä»¥åŒ¹é…æœ€æ–°çš„æ¸²æŸ“ç»“æœ.

è¿™é‡Œçš„å…³é”®ç‚¹æ˜¯: `count` å€¼åœ¨æ¯æ¬¡æ¸²æŸ“çš„è¿‡ç¨‹ä¸­, éƒ½æ˜¯ä¸€ä¸ªå›ºå®šçš„å¸¸é‡. åªæœ‰ç»„ä»¶è¢«é‡æ–°è°ƒç”¨, æ¯ä¸€æ¬¡æ¸²æŸ“éƒ½"çœ‹åˆ°äº†"å¯¹åº”çš„ `count` å€¼, åŒæ—¶æ¯ä¸€æ¬¡æ¸²æŸ“çš„ `count` éƒ½äº’ä¸å…³è”.

_(æƒ³è¦æ›´æ·±å…¥åœ°äº†è§£å…·ä½“çš„æ¸²æŸ“æµç¨‹, å¯ä»¥æŸ¥çœ‹è¿™ç¯‡æ–‡ç« : [React ä½œä¸º UI è¿è¡Œæ—¶](https://overreacted.io/react-as-a-ui-runtime/))_

### æ¯æ¬¡æ¸²æŸ“éƒ½æœ‰è‡ªå·±çš„äº‹ä»¶å¤„ç†å™¨

æ¥ä¸‹æ¥å¼€å§‹çœ‹äº‹ä»¶å¤„ç†å™¨.

æŸ¥çœ‹ä¸‹é¢çš„ç¤ºä¾‹. æˆ‘ä»¬è®¾ç½®äº†ä¸€ä¸ª 3 ç§’çš„å®šæ—¶å™¨, 3 ç§’ä¹‹åå¼¹å‡º `count` å€¼:

```jsx
function Counter() {
  const [count, setCount] = useState(0)
  // highlight-start
  function handleAlertClick() {
    setTimeout(() => {
      alert("You clicked on: " + count)
    }, 3000)
  }
  // highlight-end

  return (
    <div>
      <p>You clicked {count} times</p>
      <button onClick={() => setCount(count + 1)}>Click me</button>
      // highlight-next-line
      <button onClick={handleAlertClick}>Show alert</button>
    </div>
  )
}
```

ç°åœ¨æˆ‘æŒ‰æ­¥éª¤åšäº†ä»¥ä¸‹å‡ ä»¶äº‹æƒ…:

- å°†è®¡æ—¶å™¨çš„å€¼**å¢åŠ **åˆ° 3
- **ç‚¹å‡»**"Show alert"
- åœ¨å®šæ—¶å™¨çš„å›è°ƒ(`alert`å‡½æ•°)æ‰§è¡Œä¹‹å‰å°†è®¡æ—¶å™¨çš„å€¼**å¢åŠ **åˆ° 5

![counter](/posts/images/counter.gif)

ä½ è®¤ä¸º `alert` çš„ç»“æœä¼šæ˜¯ä»€ä¹ˆå‘¢? æ˜¯ `alert` æ—¶çš„ state å€¼ 5, è¿˜æ˜¯ç‚¹å‡»æ—¶çš„ state å€¼ 3?

---

_å‰§é€:_

---

å¯ä»¥åœ¨[è¿™é‡Œ](https://codesandbox.io/s/w2wxl3yo0l)è‡ªå·±è¯•ä¸€è¯•!

å¦‚æœè¿™ä¸ªç¤ºä¾‹å¯¹ä½ æ¥è¯´å¾ˆè´¹è§£, å¯ä»¥æƒ³è±¡ä¸€ä¸ªæ›´å®é™…çš„ä¾‹å­: å‡è®¾ç°åœ¨æœ‰ä¸€ä¸ªèŠå¤©åº”ç”¨, æˆ‘ä»¬å°† count ç±»æ¯”ä¸ºå½“å‰æ¥å—çš„æ¶ˆæ¯å¯¹åº”çš„ ID, å­˜å‚¨åœ¨ state ä¸­, å°†æŒ‰é’®ç±»æ¯”ä¸ºå‘é€æ¶ˆæ¯çš„æŒ‰é’®, è¿™æ ·å¯èƒ½ä¼šæ›´å®¹æ˜“ç†è§£. 

[è¿™ç¯‡æ–‡ç« ](https://overreacted.io/how-are-function-components-different-from-classes/)è¯¦ç»†è§£é‡Šäº†å‡ºç°ä¸Šè¿°ç»“æœçš„åŸå› , æ­£ç¡®ç­”æ¡ˆæ˜¯ 3.

`alert` ä¼š"æ•æ‰"ç‚¹å‡»å½“æ—¶ state çš„å€¼.

(_å½“ç„¶, æˆ‘ä»¬å¯ä»¥ä¿®æ”¹ä»£ç ä»¥å®ç°å…¶ä»–çš„è¡Œä¸º, ä½†æ˜¯ç›®å‰æˆ‘åªå…³æ³¨é»˜è®¤åœºæ™¯. å½“æˆ‘ä»¬åœ¨å»ºç«‹ä¸€ä¸ªå…¨æ–°å¿ƒæ™ºæ¨¡å‹çš„æ—¶å€™, è¦å°½å¯èƒ½é€‰æ‹©æœ€ç®€å•çš„æ–¹å¼, è¿™æ ·èƒ½å¸®åŠ©æˆ‘ä»¬æ›´å®¹æ˜“åœ°å»ºç«‹å…¨æ–°çš„å¿ƒæ™ºæ¨¡å‹._)

---

é‚£ä¹ˆå…¶ä¸­çš„åŸç†æ˜¯ä»€ä¹ˆå‘¢?

æˆ‘ä»¬å…ˆå‰æåˆ°è¿‡, `count` å€¼åœ¨æ¯æ¬¡è¢«è°ƒç”¨æ—¶éƒ½æ˜¯ä¸€ä¸ªå¸¸é‡. æœ‰å¿…è¦é‡ç‚¹æŒ‡å‡ºçš„æ˜¯ -- **æˆ‘ä»¬çš„å‡½æ•°(ç»„ä»¶)ä¼šè¢«è°ƒç”¨å¤šæ¬¡(æ¯æ¬¡æ¸²æŸ“è¢«è°ƒç”¨ä¸€æ¬¡), æ¯ä¸€æ¬¡è¢«è°ƒç”¨æ—¶, è¿™ä¸ª count éƒ½æ˜¯ç”± useState æ§åˆ¶çš„ä¸€ä¸ªç‰¹å®šå€¼.**

è¿™ä¸ªç‰¹æ€§å¹¶é React ç‹¬æœ‰ -- æ™®é€šçš„å‡½æ•°ä¹Ÿæ˜¯è¿™æ ·å·¥ä½œçš„:

```js
function sayHi(person) {
  // highlight-next-line
  const name = person.name
  setTimeout(() => {
    alert("Hello, " + name)
  }, 3000)
}

let someone = { name: "Dan" }
sayHi(someone)

someone = { name: "Yuzhi" }
sayHi(someone)

someone = { name: "Dominic" }
sayHi(someone)
```

åœ¨è¿™ä¸ª[ç¤ºä¾‹](https://codesandbox.io/s/mm6ww11lk8)ä¸­, å¤–éƒ¨çš„ `someone` å˜é‡è¢«å¤šæ¬¡é‡æ–°èµ‹å€¼. (å°±åƒåœ¨ React ä¸­, å½“å‰ç»„ä»¶çš„ state ä¸æ–­å˜åŒ–ä¸€æ ·. ) **åœ¨ `sayHi` å†…éƒ¨, æœ‰ä¸€ä¸ªå˜é‡ `name`, å®ƒä¼šè¯»å– `person` çš„ `name` å±æ€§.** è¿™ä¸ªå˜é‡åœ¨å‡½æ•°å†…éƒ¨, æ¯æ¬¡è°ƒç”¨ä¹‹é—´éƒ½æ˜¯ç‹¬ç«‹çš„. å› æ­¤, å½“å®šæ—¶å™¨çš„å›è°ƒè¢«è°ƒç”¨çš„æ—¶å€™, æ¯æ¬¡ alert éƒ½ä¼š"è®°ä½"å½“æ—¶çš„ `name`.

è¿™ä¹Ÿè§£é‡Šäº†æˆ‘ä»¬çš„äº‹ä»¶å¤„ç†å™¨æ˜¯å¦‚ä½•åœ¨ç‚¹å‡»çš„å½“ä¸‹"æ•æ‰" `count` å€¼çš„. åŒç†, æ¯æ¬¡æ¸²æŸ“éƒ½èƒ½"çœ‹åˆ°"è‡ªå·±çš„ `count`:

```jsx
// é¦–æ¬¡æ¸²æŸ“
function Counter() {
  // highlight-next-line
  const count = 0 // useState() è¿”å›çš„å†…å®¹
  // ...
  function handleAlertClick() {
    setTimeout(() => {
      alert("You clicked on: " + count)
    }, 3000)
  }
  // ...
}

// ç‚¹å‡»äº‹ä»¶ä¹‹åå‡½æ•°è¢«é‡æ–°è°ƒç”¨
function Counter() {
  // highlight-next-line
  const count = 1 // useState() è¿”å›çš„å†…å®¹
  // ...
  function handleAlertClick() {
    setTimeout(() => {
      alert("You clicked on: " + count)
    }, 3000)
  }
  // ...
}

// åˆä¸€æ¬¡ç‚¹å‡»äº‹ä»¶, å‡½æ•°è¢«é‡æ–°è°ƒç”¨
function Counter() {
  // highlight-next-line
  const count = 2 // useState() è¿”å›çš„å†…å®¹
  // ...
  function handleAlertClick() {
    setTimeout(() => {
      alert("You clicked on: " + count)
    }, 3000)
  }
  // ...
}
```

æ¯ä¸€æ¬¡æ¸²æŸ“, éƒ½ä¼šè¿”å›å„è‡ªç‰ˆæœ¬çš„ `handleAlertClick`, å¹¶ä¸”æœ‰å„è‡ªçš„ `count`:

```jsx
// é¦–æ¬¡æ¸²æŸ“
function Counter() {
  // ...
  function handleAlertClick() {
    setTimeout(() => {
      // highlight-next-line
      alert("You clicked on: " + 0)
    }, 3000)
  }
  // ...
  // highlight-next-line
  <button onClick={handleAlertClick} /> // å†…éƒ¨å€¼ä¸º 0 çš„ç‰ˆæœ¬
  // ...
}

// ç‚¹å‡»äº‹ä»¶ä¹‹åå‡½æ•°è¢«é‡æ–°è°ƒç”¨
function Counter() {
  // ...
  function handleAlertClick() {
    setTimeout(() => {
      // highlight-next-line
      alert("You clicked on: " + 1)
    }, 3000)
  }
  // ...
  // highlight-next-line
  <button onClick={handleAlertClick} /> // å†…éƒ¨å€¼ä¸º 1 çš„ç‰ˆæœ¬
  // ...
}

// åˆä¸€æ¬¡ç‚¹å‡»äº‹ä»¶, å‡½æ•°è¢«é‡æ–°è°ƒç”¨
function Counter() {
  // ...
  function handleAlertClick() {
    setTimeout(() => {
      // highlight-next-line
      alert("You clicked on: " + 2)
    }, 3000)
  }
  // ...
  // highlight-next-line
  <button onClick={handleAlertClick} /> // å†…éƒ¨å€¼ä¸º 2 çš„ç‰ˆæœ¬
  // ...
}
```

è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ, åœ¨è¿™é‡Œçš„[ç¤ºä¾‹](https://codesandbox.io/s/w2wxl3yo0l)ä¸­, äº‹ä»¶å¤„ç†å™¨"å±äº"å„è‡ªçš„æ¸²æŸ“, å½“ç”¨æˆ·ç‚¹å‡»çš„æ—¶å€™, ä¼šä½¿ç”¨é‚£æ¬¡æ¸²æŸ“çš„ `count` å€¼.

**å¯¹äºæ¯ä¸€æ¬¡æ¸²æŸ“, å†…éƒ¨çš„ props å’Œ state å§‹ç»ˆä¿æŒä¸å˜, å¹¶ä¸”æ¯æ¬¡æ¸²æŸ“éƒ½æ˜¯ç‹¬ç«‹çš„.** æ—¢ç„¶æ¯æ¬¡æ¸²æŸ“çš„ props å’Œ state å„è‡ªç‹¬ç«‹, æ¶ˆè´¹å®ƒä»¬çš„éƒ¨åˆ†(åŒ…æ‹¬äº‹ä»¶å¤„ç†å™¨), åœ¨æ¸²æŸ“é—´ä¹Ÿå„è‡ªç‹¬ç«‹, éƒ½ä»å±äºç‰¹å®šçš„æ¸²æŸ“. å› æ­¤äº‹ä»¶å¤„ç†å™¨å†…éƒ¨çš„å¼‚æ­¥å‡½æ•°ä¹Ÿä¼š"çœ‹åˆ°"åŒæ ·çš„ `count` å€¼.

_è¾¹æ³¨: æˆ‘åœ¨ `handleAlertClick` ä¸­ç›´æ¥ä½¿ç”¨äº† `count` å€¼. è¿™æ ·çš„æ›¿æ¢æ˜¯å®‰å…¨çš„, å› ä¸ºåœ¨ä¸€æ¬¡æ¸²æŸ“æµç¨‹ä¸­, `count` å€¼ä¸å¯èƒ½æœ‰å˜åŒ–. å®ƒè¢«å£°æ˜ä¸º `const`, ä¸”æ˜¯ä¸€ä¸ªä¸å¯å˜çš„æ•°å­—. åŒæ ·çš„åŸåˆ™åœ¨å¯¹è±¡ä¸­ä»ç„¶é€‚ç”¨, ä¸è¿‡æˆ‘ä»¬å¿…é¡»è¦ç¡®ä¿é¿å…æ”¹å˜(mutate)çŠ¶æ€çš„å€¼. åšæ³•æ˜¯ç”¨ä¸€ä¸ªæ–°åˆ›å»ºçš„å¯¹è±¡å»è°ƒç”¨ `setSomething(newObj)`, è€Œä¸æ”¹å˜è¿™ä¸ªå¯¹è±¡. è¿™æ ·çš„è¯, å‰ä¸€æ¬¡æ¸²æŸ“çš„çŠ¶æ€(state)å€¼å°±èƒ½å¤Ÿä¿æŒä¸è¢«ä¸‹ä¸€æ¬¡æ¸²æŸ“ä¿®æ”¹._

### æ¯æ¬¡æ¸²æŸ“éƒ½æœ‰è‡ªå·±çš„å‰¯ä½œç”¨

è¿™ç¯‡æ–‡ç« çš„ä¸»è¦å†…å®¹æœ¬è¯¥æ˜¯å…³äºå‰¯ä½œç”¨å‡½æ•°(effect)çš„, ç°åœ¨æˆ‘ä»¬ä¼šå¼€å§‹è¯¦ç»†ä»‹ç»å®ƒ. å…¶å®, å‰¯ä½œç”¨å’Œä»¥ä¸Šä¸¤éƒ¨åˆ†çš„è¡Œä¸ºç±»ä¼¼, æ¯æ¬¡æ¸²æŸ“éƒ½æœ‰è‡ªå·±çš„å‰¯ä½œç”¨å‡½æ•°.

æˆ‘ä»¬å›åˆ° React [æ–‡æ¡£](https://reactjs.org/docs/hooks-effect.html)ä¸­çš„ä¾‹å­:

```jsx
function Counter() {
  const [count, setCount] = useState(0)
  // highlight-start
  useEffect(() => {
    document.title = `You clicked ${count} times`
  })
  // highlight-end

  return (
    <div>
      <p>You clicked {count} times</p>
      <button onClick={() => setCount(count + 1)}>Click me</button>
    </div>
  )
}
```

**ç°åœ¨æœ‰ä¸€ä¸ªé—®é¢˜: effect æ˜¯å¦‚ä½•è¯»å–åˆ° `count` çš„æœ€æ–°å€¼çš„?**

åœ¨ effect å‡½æ•°çš„å†…éƒ¨æœ‰ä¸€äº›æ•°æ®ç»‘å®šæˆ–è€…è®¢é˜…çš„é€»è¾‘, ä½¿å¾— effect å‡½æ•°æ¯æ¬¡éƒ½èƒ½è¯»å–åˆ° `count` çš„æœ€æ–°å€¼? è¿˜æ˜¯ `count` æ˜¯ä¸€ä¸ªå¯å˜çš„å€¼, React åœ¨ç»„ä»¶çš„å†…éƒ¨ç»´æŠ¤äº†è¿™ä¸ªå€¼, å› æ­¤æˆ‘ä»¬çš„ effect å‡½æ•°èƒ½å¤Ÿè¯»å–åˆ°æœ€æ–°å€¼?

éƒ½ä¸æ˜¯çš„.

å…ˆå‰æˆ‘ä»¬å·²ç»çŸ¥é“, `count` åœ¨æ¯æ¬¡ç‰¹å®šçš„ç»„ä»¶æ¸²æŸ“æµç¨‹ä¸­, éƒ½æ˜¯ä¸€ä¸ªå¸¸é‡. äº‹ä»¶å¤„ç†å™¨ä»å®ƒæ‰€å±çš„æ¸²æŸ“æµç¨‹ä¸­è¯»å–åˆ°äº†å¯¹åº”çš„ `count` å€¼, å› ä¸º `count` æ˜¯å¤„äºå¯¹åº”ä½œç”¨åŸŸçš„å˜é‡. åœ¨ effect å‡½æ•°ä¸­ä¹Ÿä¸ä¾‹å¤–!

**å¹¶ä¸æ˜¯åœ¨ä¸€ä¸ª"ä¸ä¼šå˜åŒ–"çš„å‰¯ä½œç”¨æ–¹æ³•ä¸­, `count` å˜é‡å€¼æ—¶åˆ»å˜åŒ–. è€Œæ˜¯æ¯ä¸€æ¬¡æ¸²æŸ“, å‰¯ä½œç”¨å‡½æ•°æœ¬èº«éƒ½ä¸ä¸€æ ·.**

åŒæ ·åœ°, æ¯ä¸ªç‰ˆæœ¬çš„å‰¯ä½œç”¨æ–¹æ³•è¯»å–åˆ°çš„éƒ½æ˜¯å½“æ¬¡æ¸²æŸ“å†…çš„ `count` å€¼:

```jsx
// é¦–æ¬¡æ¸²æŸ“
function Counter() {
  // ...
  useEffect(
    // highlight-start
    // é¦–æ¬¡æ¸²æŸ“çš„å‰¯ä½œç”¨å‡½æ•°
    () => {
      document.title = `You clicked ${0} times`
    }
    // highlight-end
  )
  // ...
}

// ç‚¹å‡»äº‹ä»¶ä¹‹åå‡½æ•°è¢«é‡æ–°è°ƒç”¨
function Counter() {
  // ...
  useEffect(
    // highlight-start
    // ç¬¬äºŒæ¬¡æ¸²æŸ“çš„å‰¯ä½œç”¨å‡½æ•°
    () => {
      document.title = `You clicked ${1} times`
    }
    // highlight-end
  )
  // ...
}

// åˆä¸€æ¬¡ç‚¹å‡»äº‹ä»¶, å‡½æ•°è¢«é‡æ–°è°ƒç”¨
function Counter() {
  // ...
  // highlight-start
  useEffect(
    // ç¬¬ä¸‰æ¬¡æ¸²æŸ“çš„å‰¯ä½œç”¨å‡½æ•°
    () => {
      document.title = `You clicked ${2} times`
    }
    // highlight-end
  )
  // ..
}
```

React ä¼šè®°ä½æ¯ä¸€æ¬¡ä½ æ‰€æä¾›çš„å‰¯ä½œç”¨æ–¹æ³•, åœ¨å½“æ¬¡æ¸²æŸ“æµç¨‹ç»“æŸ, UI å‘ˆç°å‡ºå¯¹åº”å˜åŒ–ä¹‹å, è°ƒç”¨è¿™ä¸ªå‰¯ä½œç”¨æ–¹æ³•.

å°½ç®¡æ¯ä¸€æ¬¡æ¸²æŸ“çš„å‰¯ä½œç”¨æ–¹æ³•çœ‹èµ·æ¥æ²¡æœ‰å·®åˆ«(åŠŸèƒ½éƒ½æ˜¯æ›´æ–°æ–‡æ¡£çš„æ ‡é¢˜), ä½†æ˜¯å®é™…ä¸Šæ¯ä¸€æ¬¡æ¸²æŸ“è¿™ä¸ªæ–¹æ³•éƒ½æ˜¯ä¸ä¸€æ ·çš„ -- å¹¶ä¸”æ¯ä¸€ä¸ªå‰¯ä½œç”¨æ–¹æ³•éƒ½ä¼šçœ‹åˆ°"æ¸²æŸ“"å½“æ¬¡çš„ props å’Œ state.

**ä¸ºäº†ä¾¿äºç†è§£, ä½ å¯ä»¥æŠŠå‰¯ä½œç”¨æ–¹æ³•å½“åšæ˜¯æ¯æ¬¡æ¸²æŸ“çš„ç»“æœ.**

ä½†ä¸¥æ ¼æ¥è¯´, å®ƒä»¬å¹¶ä¸æ˜¯æ¸²æŸ“ç»“æœ(React ä¸å°†å‰¯ä½œç”¨å‡½æ•°è®¾è®¡ä¸ºæ¸²æŸ“ç»“æœçš„åŸå› æ˜¯: èƒ½å¤Ÿé€šè¿‡ç®€å•çš„è¯­æ³•[å®ç° Hooks çš„ç»„åˆ](https://overreacted.io/why-do-hooks-rely-on-call-order/), å‡å°‘è¿è¡Œæ—¶çš„å¼€é”€). ä½†æ˜¯è€ƒè™‘åˆ°æˆ‘ä»¬ç°åœ¨çš„ç›®çš„æ˜¯å»ºç«‹å…¨æ–°çš„å¿ƒæ™ºæ¨¡å‹, å¯ä»¥åœ¨æ¦‚å¿µä¸Šè®¤ä¸ºå‰¯ä½œç”¨å‡½æ•°æ˜¯æŸä¸€æ¬¡æ¸²æŸ“çš„ç»“æœ.

---

ç°åœ¨æ¥å·©å›ºä»¥ä¸Šçš„å†…å®¹, é¦–å…ˆå›é¡¾é¦–æ¬¡æ¸²æŸ“:

- **React:** å½“ state å€¼ä¸º `0` çš„æ—¶å€™, ç»™æˆ‘ä½ å¸Œæœ›æ¸²æŸ“çš„ UI å†…å®¹.
- **ç»„ä»¶:**
  - è¿™æ˜¯æˆ‘è¦æ¸²æŸ“çš„å†…å®¹: `<p>You clicked 0 times</p>`.
  - æ¸²æŸ“ç»“æŸä¹‹åè¯·æ‰§è¡Œè¿™ä¸ªå‰¯ä½œç”¨æ–¹æ³•: `() => { document.title = 'You clicked 0 times' }`.
- **React:** å¥½çš„, æ›´æ–° UI. Hey, æµè§ˆå™¨, æˆ‘æƒ³è¦åœ¨ DOM ä¸­æ·»åŠ ä¸€äº›å†…å®¹.
- **æµè§ˆå™¨:** å¥½çš„, æˆ‘æŠŠå®ƒä»¬ç»˜åˆ¶åˆ°å±å¹•ä¸­.
- **React:** å¥½çš„, æˆ‘å‡†å¤‡å¼€å§‹æ‰§è¡Œå‰¯ä½œç”¨æ–¹æ³•äº†.
  - æ‰§è¡Œ `() => { document.title = 'You clicked 0 times' }`.

---

ç„¶åå›é¡¾ç‚¹å‡»ä¹‹åçš„æ¸²æŸ“æµç¨‹:

- **ç»„ä»¶:** Hey, React, æŠŠæˆ‘çŠ¶æ€(state)ä¸­çš„ `count` å€¼è®¾ç½®ä¸º `1`.
- **React:** å½“ `count` æ›´æ–°ä¸º `1` çš„æ—¶å€™, æŠŠå¯¹åº”çš„ UI è¿”å›ç»™æˆ‘å§.
- **ç»„ä»¶:**
  - è¿™æ˜¯æ¸²æŸ“çš„ç»“æœ: `<p>You clicked 1 times</p>`.
  - è®°å¾—æ‰§è¡Œè¿™ä¸ªå‰¯ä½œç”¨æ–¹æ³•: `() => { document.title = 'You clicked 1 times' }`.
- **React:** å¥½çš„, æ›´æ–° UI. Hey, æµè§ˆå™¨, æˆ‘å·²ç»ä¿®æ”¹å¥½ DOM äº†.
- **æµè§ˆå™¨:** å¥½çš„, æˆ‘æŠŠå®ƒä»¬ç»˜åˆ¶åˆ°å±å¹•ä¸­.
- **React:** OK, æˆ‘ç°åœ¨å¼€å§‹æ‰§è¡Œå‰¯ä½œç”¨æ–¹æ³•.
  - æ‰§è¡Œ `() => { document.title = 'You clicked 1 times' }`.

---

### æ¯æ¬¡æ¸²æŸ“çš„æ‰€æœ‰å€¼éƒ½å±äºå½“æ¬¡æ¸²æŸ“

**æˆ‘ä»¬çŸ¥é“äº†, å‰¯ä½œç”¨æ–¹æ³•åœ¨æ¯æ¬¡æ¸²æŸ“ä¹‹åéƒ½ä¼šæ‰§è¡Œ, ä»æ¦‚å¿µä¸Šå¯ä»¥å°†å‰¯ä½œç”¨æ–¹æ³•ç†è§£ä¸ºç»„ä»¶è¾“å‡ºå†…å®¹çš„ä¸€éƒ¨åˆ†, å¹¶ä¸”å‰¯ä½œç”¨æ–¹æ³•èƒ½å¤Ÿ"çœ‹åˆ°"å½“æ¬¡æ¸²æŸ“çš„ props å’Œ state.**

ç°åœ¨æˆ‘ä»¬æ¥åšä¸€æ¬¡å®éªŒ. æŸ¥çœ‹ä¸‹é¢çš„ä»£ç :

```jsx
function Counter() {
  const [count, setCount] = useState(0)
  // highlight-start
  useEffect(() => {
    setTimeout(() => {
      console.log(`You clicked ${count} times`)
    }, 3000)
  })
  // highlight-end
  return (
    <div>
      <p>You clicked {count} times</p>
      <button onClick={() => setCount(count + 1)}>Click me</button>
    </div>
  )
}
```

å¦‚æœæˆ‘åœ¨æ¯æ¬¡å»¶è¿Ÿçš„æ—¶é—´æ®µå†…ç‚¹å‡»å¤šæ¬¡, æœ€ç»ˆè¾“å‡ºçš„å€¼ä¼šæ˜¯æ€æ ·çš„å‘¢?

---

_å‰§é€_

---

ä½ å¯èƒ½ä¼šè®¤ä¸ºè¿™æ˜¯ä¸ªç³Šå¼„ä½ çš„é¢˜ç›®, æœ€ç»ˆçš„ç»“æœä¼šå¾ˆå‡ºäººæ„æ–™. å…¶å®å¹¶ä¸æ˜¯! æˆ‘ä»¬æ¥çœ‹è¿™ä¸€ç³»åˆ—çš„è¾“å‡º -- æ¯ä¸€ä¸ªè¾“å‡ºéƒ½å±äºç‰¹å®šçš„æ¸²æŸ“, å› æ­¤æ¯ä¸€æ¬¡è¾“å‡ºéƒ½æ˜¯è‡ªå·±çš„ `count` å€¼. å¯ä»¥åœ¨[è¿™é‡Œ](https://codesandbox.io/s/lyx20m1ol)è‡ªå·±å°è¯•ä¸€ä¸‹.

![timeout_counter](/posts/images/timeout_counter.gif)

ä½ å¯èƒ½ä¼šè§‰å¾—: "å½“ç„¶æ˜¯è¿™æ ·è¾“å‡ºçš„, å¦åˆ™æ˜¯æ€æ ·çš„å‘¢?"

ä¸è¿‡, `this.state` åœ¨ç±»ç»„ä»¶ä¸­çš„è¡Œä¸ºå¹¶ä¸æ˜¯è¿™æ ·. å¾ˆå¤šäººä¼šæŠŠ `useEffect` çœ‹ä½œæ˜¯å’Œ[ç±»ç»„ä»¶æ¦‚å¿µä¸­](https://codesandbox.io/s/kkymzwjqz3) `componentDidUpdate` å¯¹åº”çš„æ–¹æ³•:

```jsx
  componentDidUpdate() {
    setTimeout(() => {
      console.log(`You clicked ${this.state.count} times`);
    }, 3000);
  }
```

å®é™…ä¸Šå¹¶ä¸æ˜¯è¿™æ ·, `this.state.count` å§‹ç»ˆæ˜¯æœ€æ–°çš„ `count` å€¼, ä½†æ˜¯ `useEffect` ä¸­çš„åˆ™æ˜¯å½“æ¬¡æ¸²æŸ“çš„å€¼, å› æ­¤ä»¥ä¸Šä»£ç çš„ç»“æœ, è¾“å‡ºçš„ä¼šæ˜¯ `5`:

![timeout_counter_class](/posts/images/timeout_counter_class.gif)

<mark>I think itâ€™s ironic that Hooks rely so much on JavaScript closures, and yet itâ€™s the class implementation that suffers from the canonical wrong-value-in-a-timeout confusion thatâ€™s often associated with closures. This is because the actual source of the confusion in this example is the mutation (React mutates this.state in classes to point to the latest state) and not closures themselves. (æˆ‘è§‰å¾—å¾ˆæœ‰æ„æ€çš„æ˜¯, Hooks çš„å®ç°ååˆ†ä¾èµ– JavaScript ä¸­çš„é—­åŒ…)</mark>

**å½“æˆ‘ä»¬éœ€è¦é”å®šä¸€ä¸ªæ°¸è¿œä¸ä¼šå˜åŒ–çš„å€¼çš„æ—¶å€™, ä½¿ç”¨é—­åŒ…æ˜¯æœ€åˆé€‚çš„æ‰‹æ®µ. è¿™ä½¿å¾—æˆ‘ä»¬å¾ˆå®¹æ˜“èƒ½å¤Ÿæ¨å‡ºæ­£ç¡®ç­”æ¡ˆ, å› ä¸ºä½ æ­£åœ¨è¯»å–çš„å€¼å§‹ç»ˆæ˜¯ä¸€ä¸ªå¸¸é‡.** æ—¢ç„¶æˆ‘ä»¬ç°åœ¨å·²ç»çŸ¥é“äº†å¦‚ä½•ç»´æŒæ¸²æŸ“æ—¶çš„ props å’Œ state, å¯ä»¥å¼€å§‹å°è¯•[ä½¿ç”¨é—­åŒ…](https://codesandbox.io/s/w7vjo07055)å¯¹ class ç‰ˆæœ¬çš„ä»£ç è¿›è¡Œæ”¹é€ .

### é€†æµè€Œä¸Š

æ­¤åˆ»æˆ‘ä»¬å·²ç»å¾—åˆ°äº†ä¸€ä¸ªå…±è¯†: å‡½æ•°å¼ç»„ä»¶åœ¨æ¸²æŸ“æ—¶, å†…éƒ¨çš„æ¯ä¸€é¡¹(åŒ…æ‹¬äº‹ä»¶å¤„ç†å™¨, å‰¯ä½œç”¨æ–¹æ³•, timeout å›è°ƒ, API è°ƒç”¨ç­‰)éƒ½ä¼š"æ•æ‰"æ¸²æŸ“å½“æ—¶çš„ props å’Œ state.

å› æ­¤ä»¥ä¸‹ä¸¤ä¸ªä¾‹å­å…¶å®æ˜¯ä¸€è‡´çš„:

```jsx
function Example(props) {
  useEffect(() => {
    setTimeout(() => {
      // highlight-next-line
      console.log(props.counter)
    }, 1000)
  })
  // ...
}
```

```jsx
function Example(props) {
  // highlight-next-line
  const counter = props.counter
  useEffect(() => {
    setTimeout(() => {
      // highlight-next-line
      console.log(counter)
    }, 1000)
  })
  // ...
}
```

**ä»ä¸Šé¢çš„ä»£ç å¯ä»¥çœ‹å‡º, ä¸ç®¡æˆ‘ä»¬æ˜¯å¦åœ¨ç»„ä»¶ä¸­æå‰è¯»å–äº† state æˆ–è€… props çš„å€¼, å¯¹å‰¯ä½œç”¨å‡½æ•°ä¸­è¯»å–åˆ°çš„ç»“æœéƒ½æ²¡æœ‰å½±å“.** åœ¨å•æ¬¡æ¸²æŸ“çš„ä½œç”¨åŸŸå†…, props å’Œ state å§‹ç»ˆä¼šä¿æŒä¸å˜. (å°† props è§£æ„èƒ½å¤Ÿä½¿å¾—è¿™ä¸ªè¡Œä¸ºæ›´å®¹æ˜“ç†è§£.)

åœ¨æŸäº›åœºæ™¯ä¸‹, æˆ‘ä»¬å¯èƒ½ä¼šå¸Œæœ›èƒ½å¤Ÿåœ¨å‰¯ä½œç”¨å‡½æ•°çš„å›è°ƒä¸­è¯»å–åˆ°æœ€æ–°çš„å€¼è€Œä¸æ˜¯æ¸²æŸ“å½“æ—¶çš„å€¼. æœ€ç®€å•çš„æ–¹å¼æ˜¯ä½¿ç”¨ `ref`, åœ¨è¿™ç¯‡[æ–‡ç« ](https://overreacted.io/how-are-function-components-different-from-classes/)çš„æœ€åä¸€éƒ¨åˆ†æˆ‘ä»¬æœ‰æåˆ°è¿™ä¸€ç‚¹.

æœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„çš„æ˜¯, å½“æˆ‘ä»¬å¸Œæœ›åœ¨è¿‡å»çš„æ¸²æŸ“ä¸­è¯»å–åˆ°æœªæ¥çš„ props å’Œ state æ—¶, å®é™…ä¸Šåœ¨é€†æµå‰è¿›. è¿™å½“ç„¶æ²¡æœ‰é”™(åœ¨æŸäº›æƒ…å†µä¸‹ç”šè‡³æ˜¯å¿…è¦çš„), ä¸è¿‡è¿™æ ·çš„è¡Œä¸ºçœ‹èµ·æ¥æ¯”è¾ƒ"ä¸å¹²å‡€", è¿èƒŒäº†æ­£å¸¸çš„æ¨¡å¼. ä¸è¿‡å…¶å® React å›¢é˜Ÿæ˜¯åˆ»æ„æŠŠå‡½æ•°å¼ç»„ä»¶çš„è¡Œä¸ºè®¾è®¡æˆè¿™æ ·çš„, è¿™æ ·ä¸€æ¥, ç”¨æˆ·å°±èƒ½å¤Ÿå¾ˆæ˜æ˜¾åœ°å‘ç°ä»£ç ä¸­çš„ç¼ºé™·. åœ¨ç±»å¼ç»„ä»¶ä¸­, å‘ç°è¿™ç±»ç¼ºé™·å°±æ¯”è¾ƒå›°éš¾.

è¿™é‡Œæœ‰[å¦ä¸€ä¸ªç‰ˆæœ¬è®¡æ—¶å™¨çš„ä¾‹å­](https://codesandbox.io/s/rm7z22qnlp), æ¨¡æ‹Ÿäº†åœ¨ç±»å¼ç»„ä»¶çš„å¯¹åº”è¡Œä¸º:

```jsx
function Example() {
  const [count, setCount] = useState(0);
  // highlight-next-line
  const latestCount = useRef(count);

  useEffect(() => {
  // highlight-start
    // è®¾ç½®å¯å˜çš„æœ€æ–°å€¼
    latestCount.current = count;
  // highlight-end
    setTimeout(() => {
    // highlight-start
      // è¯»å–å¯å˜çš„æœ€æ–°å€¼
      console.log(`You clicked ${latestCount.current} times`);
    // highlight-end
    }, 3000);
  });
  // ...
```

![timeout_counter_refs](/posts/images/timeout_counter_refs.gif)

åœ¨ React ä¸­ä¿®æ”¹(mutate)æŸäº›å€¼æˆ–è®¸çœ‹èµ·æ¥å¾ˆå¥‡æ€ª. ä½†æ˜¯å…¶å®åœ¨ç±»å¼ç»„ä»¶ä¸­, React å°±æ˜¯è¿™æ ·ä¸º `this.state` èµ‹å€¼çš„. ä¸è·å–æ¸²æŸ“å½“æ—¶çš„ props å’Œ state ä¸åŒçš„æ˜¯, ç±»å¼ç»„ä»¶è¯»å– `latestCount.current` çš„å€¼, å®ƒè·å–åˆ°çš„ç»“æœæ— æ³•å¾—åˆ°ä»»ä½•çš„ä¿è¯, åœ¨æŸä¸€æ¬¡å›è°ƒä¸­æ˜¯è¿™æ ·çš„ç»“æœ, åˆ°äº†ä¸‹ä¸€æ¬¡æˆ–è®¸åˆä¸ä¸€æ ·äº†, å› ä¸ºå®ƒçš„å€¼æ˜¯å¯å˜çš„. è¿™ä¹Ÿæ˜¯æˆ‘ä»¬ä¸æ„¿æ„å°†è¿™ç§è¡Œä¸ºè®¾ç½®æˆé»˜è®¤è¡Œä¸ºçš„åŸå› .

### æ¸…é™¤å‰¯ä½œç”¨çš„å‡½æ•°

[æ–‡æ¡£ä¸­æåˆ°](https://reactjs.org/docs/hooks-effect.html#effects-with-cleanup), æŸäº›å‰¯ä½œç”¨è¿˜éœ€è¦å­˜åœ¨å¯¹åº”çš„æ¸…é™¤å‰¯ä½œç”¨çš„é˜¶æ®µ. æœ¬è´¨ä¸Šæ¥è¯´, åœ¨è¿™ä¸ªé˜¶æ®µä¸­æˆ‘ä»¬åšçš„äº‹æƒ…, å°±æ˜¯æ’¤é”€å‰¯ä½œç”¨(æ¯”å¦‚å–æ¶ˆè®¢é˜…äº‹ä»¶.)

æŸ¥çœ‹ä¸‹é¢çš„ä»£ç :

```jsx
useEffect(() => {
  ChatAPI.subscribeToFriendStatus(props.id, handleStatusChange)
  return () => {
    ChatAPI.unsubscribeFromFriendStatus(props.id, handleStatusChange)
  }
})
```

å‡å¦‚åœ¨é¦–æ¬¡æ¸²æŸ“æ—¶, `props` çš„å€¼ä¸º `{id: 10}`, ç¬¬äºŒæ¬¡æ¸²æŸ“æ—¶, å€¼ä¸º `{id: 20}`. ä½ æˆ–è®¸ä¼šè®¤ä¸ºæ¸²æŸ“æµç¨‹æ˜¯è¿™æ ·å‘ç”Ÿçš„:

- React æ¸…é™¤ props ä¸º `{id: 10}` æ—¶çš„å‰¯ä½œç”¨.
- React ä¸º `{id: 20}` æ¸²æŸ“å¯¹åº”çš„ UI.
- React ä¸º `{id: 20}` æ‰§è¡Œå¯¹åº”çš„å‰¯ä½œç”¨æ–¹æ³•.

(ä½†æ˜¯å®é™…æƒ…å†µå¹¶ä¸æ˜¯è¿™æ ·çš„.)

å¦‚æœä½ å»ºç«‹äº†ä»¥ä¸Šçš„å¿ƒæ™ºæ¨¡å‹, å°±ä¼šè®¤ä¸ºæ¸…é™¤å‰¯ä½œç”¨çš„å‡½æ•°"çœ‹åˆ°äº†"æ—§çš„ props, å› ä¸ºè¿™ä¸ªå‡½æ•°æ˜¯åœ¨é‡æ–°æ¸²æŸ“ä¹‹å‰æ‰§è¡Œçš„, ç„¶åæ–°çš„å‰¯ä½œç”¨å‡½æ•°"çœ‹åˆ°äº†"æ–°çš„ props. è¿™ä¸ªå¿ƒæ™ºæ¨¡å‹å¯¹äºç±»å¼ç»„ä»¶æ¥è¯´, æ˜¯å®Œå…¨æ­£ç¡®çš„, **ä½†æ˜¯å¯¹äºå‡½æ•°å¼ç»„ä»¶, æƒ…å†µå¹¶ä¸æ˜¯è¿™æ ·**. æˆ‘ä»¬æ¥çœ‹çœ‹åŸå› æ˜¯ä»€ä¹ˆ.

React æ‰§è¡Œå‰¯ä½œç”¨æ–¹æ³•çš„æ—¶æœºæ˜¯[æµè§ˆå™¨ç»˜åˆ¶éœ€è¦æ¸²æŸ“çš„å†…å®¹ä¹‹å](https://medium.com/@dan_abramov/this-benchmark-is-indeed-flawed-c3d6b5b6f97f). è¿™æ ·èƒ½å¤Ÿä½¿å¾—æˆ‘ä»¬çš„åº”ç”¨ä½“éªŒæ›´ä½³, ä¸é˜»å¡æµè§ˆå™¨çš„æ¸²æŸ“. æ¸…é™¤å‰¯ä½œç”¨çš„æ–¹æ³•åŒæ—¶ä¹Ÿä¼šå»¶è¿Ÿ. **å‰ä¸€æ¬¡æ¸²æŸ“çš„å‰¯ä½œç”¨ç›´åˆ°ä½¿ç”¨æ–°çš„ props å¼€å§‹é‡æ–°æ¸²æŸ“, æ‰ä¼šè¢«æ¸…é™¤:**

- React ä¸º `{id: 20}` æ¸²æŸ“å¯¹åº”çš„ UI.
- æµè§ˆå™¨ç»˜åˆ¶å†…å®¹, æˆ‘ä»¬çœ‹åˆ° `{id: 20}` å¯¹åº”çš„ UI.
- React æ¸…é™¤ props ä¸º `{id: 10}` æ—¶çš„å‰¯ä½œç”¨.
- React ä¸º `{id: 20}` æ‰§è¡Œå¯¹åº”çš„å‰¯ä½œç”¨æ–¹æ³•.

ä½ æˆ–è®¸ä¼šè§‰å¾—å¥‡æ€ª, ä¸ºä»€ä¹ˆå‰ä¸€æ¬¡æ¸²æŸ“çš„å‰¯ä½œç”¨æ–¹æ³•è¯»å–åˆ°çš„æ˜¯å‰ä¸€æ¬¡æ¸²æŸ“çš„ props å€¼, è€Œä¸æ˜¯æ­¤åˆ»çš„ `{id: 20}`?

æˆ‘ä»¬ä¹‹å‰å·²ç»æè¿‡è¿™ä¸ªè¯é¢˜...... ğŸ¤”

![deja_vu](/posts/images/deja_vu.gif)

å…ˆå‰ç« èŠ‚çš„æ‘˜å½•:

> ç»„ä»¶æ¸²æŸ“æ—¶å†…éƒ¨çš„æ¯ä¸€ä¸ªå‡½æ•°(åŒ…æ‹¬äº‹ä»¶å¤„ç†å™¨, å‰¯ä½œç”¨å‡½æ•°, timeout å›è°ƒ, API è°ƒç”¨ç­‰), éƒ½ä¼š"æ•æ‰"å½“æ—¶çš„ props å’Œ state.

è¿™æ ·ä¸€æ¥, ç­”æ¡ˆå°±å¾ˆæ˜æ˜¾äº†. æ¸…é™¤å‰¯ä½œç”¨çš„å‡½æ•°æ²¡æœ‰è¯»å–æœ€æ–°çš„ props, å®ƒå§‹ç»ˆä¼šè¯»å–æ¸²æŸ“å½“æ—¶å®šä¹‰çš„ props å’Œ state:

```jsx
// é¦–æ¬¡æ¸²æŸ“ props æ˜¯ {id: 10}
function Example() {
  // ...
  useEffect(
    // é¦–æ¬¡æ¸²æŸ“çš„å‰¯ä½œç”¨å‡½æ•°
    () => {
      ChatAPI.subscribeToFriendStatus(10, handleStatusChange)
      // highlight-start
      // é¦–æ¬¡æ¸²æŸ“çš„æ¸…é™¤å‰¯ä½œç”¨å‡½æ•°
      return () => {
        ChatAPI.unsubscribeFromFriendStatus(10, handleStatusChange)
      }
      // highlight-end
    }
  )
  // ...
}
// ç¬¬äºŒæ¬¡æ¸²æŸ“ props æ˜¯ {id: 20}
function Example() {
  // ...
  useEffect(
    // ç¬¬äºŒæ¬¡æ¸²æŸ“çš„å‰¯ä½œç”¨å‡½æ•°
    () => {
      ChatAPI.subscribeToFriendStatus(20, handleStatusChange)
      // ç¬¬äºŒæ¬¡æ¸²æŸ“çš„æ¸…é™¤å‰¯ä½œç”¨å‡½æ•°
      return () => {
        ChatAPI.unsubscribeFromFriendStatus(20, handleStatusChange)
      }
    }
  )
  // ...
}
```

é¦–æ¬¡æ¸²æŸ“çš„æ¸…é™¤å‡½æ•°, "çœ‹åˆ°"çš„ props ä¸€å®šæ˜¯ `{id: 10}`, ä¸å¯èƒ½æ˜¯å…¶ä»–å€¼.

è¿™ç§å½¢å¼ä½¿å¾— React èƒ½å¤Ÿåœ¨æ‰§è¡Œç»˜åˆ¶ä¹‹åç›´æ¥å¤„ç†å‰¯ä½œç”¨å‡½æ•°, æå‡åº”ç”¨æ€§èƒ½. æ—§çš„ props å§‹ç»ˆå­˜åœ¨, å½“ä»£ç éœ€è¦å®ƒçš„æ—¶å€™, æˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨å®ƒä»¬.
### åŒæ­¥ è€Œä¸æ˜¯ç”Ÿå‘½å‘¨æœŸ

æˆ‘å–œæ¬¢ React çš„åŸå› ä¹‹ä¸€æ˜¯, å®ƒç»Ÿä¸€æè¿°äº†é¦–æ¬¡æ¸²æŸ“çš„ç»“æœå’Œåç»­çš„æ›´æ–°. è¿™ç§æ¨¡å¼èƒ½å¤Ÿ[å‡å°‘ç¨‹åºçš„ç†µ](https://overreacted.io/the-bug-o-notation/).

ä¸¾ä¸ªä¾‹å­, å¦‚æœæˆ‘çš„ç»„ä»¶æ˜¯ä¸‹é¢è¿™æ ·çš„:

```jsx
function Greeting({ name }) {
  return <h1 className="Greeting">Hello, {name}</h1>
}
```

ä¸ç®¡æ˜¯å…ˆæ¸²æŸ“ `<Greeting name="Dan" />`, ç„¶åæ¸²æŸ“ `<Greeting name="Yuzhi" />`, è¿˜æ˜¯ç›´æ¥æ¸²æŸ“ `<Greeting name="Yuzhi" />`. æœ€åçš„ç»“æœéƒ½æ˜¯çœ‹åˆ°å±å¹•ä¸­å‘ˆç°: "Hello, Yuzhi".

äººä»¬å¸¸è¯´: é‡è¦çš„æ˜¯æ—…ç¨‹è€Œä¸æ˜¯ç›®çš„åœ°. ä½†æ˜¯åœ¨ React ä¸­, æƒ…å†µå°±ä¸æ˜¯è¿™æ ·. **React åªå…³æ³¨ç»“æœ, è€Œéè¿‡ç¨‹.** ä¸¾ä¸ªä¾‹å­, åœ¨ jQuery ä¸­, æˆ‘ä»¬å…³æ³¨è¿‡ç¨‹, æ¯”å¦‚è¯´ä½¿ç”¨ `$.addClass` å’Œ `$.removeClass` æ¥æ“æ§æ ‡ç­¾çš„ `className`, å°±æ˜¯é’ˆå¯¹è¿‡ç¨‹çš„æ“ä½œ, è€Œåœ¨ React ä¸­, æˆ‘ä»¬ä¼šç›´æ¥å£°æ˜ `className` åº”è¯¥æ˜¯ä»€ä¹ˆæ ·å­çš„(å…³æ³¨ç»“æœ).

**React ä¼šæ ¹æ®å½“å‰çš„ props å’Œ state åŒæ­¥ DOM çš„å†…å®¹.** åœ¨æ¸²æŸ“æ—¶, æŒ‚è½½å’Œæ›´æ–°åšçš„ DOM åŒæ­¥æ“ä½œå…¶å®æ²¡æœ‰ä»€ä¹ˆåŒºåˆ«.

æˆ‘ä»¬å¯ä»¥ç”¨åŒæ ·çš„è§’åº¦æ€è€ƒå‰¯ä½œç”¨å‡½æ•°. **`useEffect` å‡½æ•°ä½¿å¾—æˆ‘ä»¬èƒ½å¤Ÿæ ¹æ® props å’Œ state åŒæ­¥ React æ ‘ä¹‹å¤–çš„å†…å®¹.**

```jsx
function Greeting({ name }) {
  // highlight-start
  useEffect(() => {
    document.title = "Hello, " + name
  })
  // highlight-end
  return <h1 className="Greeting">Hello, {name}</h1>
}
```

è¿™æ ·çš„å¿ƒæ™ºæ¨¡å‹å’Œæˆ‘ä»¬æ‰€ç†Ÿæ‚‰çš„ _æŒ‚è½½/æ›´æ–°/å¸è½½_ æœ‰ä¸€ç‚¹åŒºåˆ«. äº†è§£è¿™ä¸ªæ¨¡å‹å¾ˆé‡è¦. **å¦‚æœä½ å®ç°çš„å‰¯ä½œç”¨å‡½æ•°, ä¼šæ ¹æ®æ˜¯ç¬¬ä¸€æ¬¡æ¸²æŸ“, è¿˜æ˜¯åç»­çš„æ¸²æŸ“æœ‰ä¸åŒçš„è¡Œä¸º, é‚£ä¹ˆå°±å’Œæˆ‘ä»¬çš„è®¾è®¡ç†å¿µèƒŒé“è€Œé©°äº†!** å¦‚æœæˆ‘ä»¬çš„ç»“æœä¾èµ–çš„æ˜¯"è¿‡ç¨‹"è€Œé"ç›®çš„åœ°", å°±æ˜¯ä¸€æ¬¡å¤±è´¥çš„åŒæ­¥.

ä¸ç®¡æˆ‘ä»¬æ˜¯æŒ‰ç…§å±æ€§(A, B, C)çš„é¡ºåºè¿›è¡Œæ¸²æŸ“, è¿˜æ˜¯ç›´æ¥ç”¨å±æ€§ C è¿›è¡Œæ¸²æŸ“, å…¶å®åŸºæœ¬ä¸Šæ²¡æœ‰ä»€ä¹ˆå·®åˆ«. å³ä½¿å­˜åœ¨å·®åˆ«, ä¹Ÿåªæ˜¯æš‚æ—¶æ€§çš„(æ¯”å¦‚æˆ‘ä»¬åœ¨è¯·æ±‚æ•°æ®çš„æ—¶å€™, ä¼šæœ‰ä¸€äº›ç»†å¾®çš„å·®åˆ«), ä½†æ˜¯æœ€ç»ˆçš„ç»“æœå§‹ç»ˆæ˜¯ä¸€è‡´çš„.

æœ‰ä¸€ä¸ªæ¯‹åº¸ç½®ç–‘çš„ç‚¹æ˜¯: æ¯ä¸€æ¬¡æ¸²æŸ“éƒ½æ‰§è¡Œæ‰€æœ‰çš„å‰¯ä½œç”¨å…¶å®å¾ˆå½±å“æ•ˆç‡. (åœ¨æŸäº›æƒ…å†µä¸‹, ç”šè‡³ä¼šå¯¼è‡´æ— é™å¾ªç¯.)

é‚£ä¹ˆæˆ‘ä»¬æ€ä¹ˆä¿®å¤è¿™ä¸ªé—®é¢˜å‘¢?

### å‘Šè¯‰ React å¦‚ä½•åŒºåˆ«å‰¯ä½œç”¨å‡½æ•°çš„å˜åŒ–

æˆ‘ä»¬å·²ç»çŸ¥é“äº† React å¦‚ä½• diff DOM, React å¹¶æ²¡æœ‰åœ¨æ¯æ¬¡æ¸²æŸ“çš„æ—¶å€™æ›´æ–°æ‰€æœ‰çš„ DOM, è€Œæ˜¯æ›´æ–°æœ‰ä¿®æ”¹çš„éƒ¨åˆ†.

å½“ä½ æ›´æ–°ä»¥ä¸‹ç»„ä»¶

```jsx
<h1 className="Greeting">Hello, Dan</h1>
```

ä¸º:

```jsx
<h1 className="Greeting">Hello, Yuzhi</h1>
```

çš„æ—¶å€™, React çœ‹åˆ°çš„æ˜¯è¿™æ ·ä¸¤ä¸ªå¯¹è±¡:

```jsx
const oldProps = { className: "Greeting", children: "Hello, Dan" }
const newProps = { className: "Greeting", children: "Hello, Yuzhi" }
```

å¯¹äºä»¥ä¸Šç¤ºä¾‹, React ä¼šæ£€æŸ¥æ¯ä¸€ä¸ª props, ç„¶ååˆ¤æ–­å‡º `children` æœ‰å˜åŒ–, ä¼šå»æ›´æ–° DOM, `className` æ²¡æœ‰å˜åŒ–, å› æ­¤ä¸éœ€è¦æ›´æ–°. æ‰€ä»¥ React åªéœ€è¦è¿™æ ·å¤„ç†å³å¯:

```jsx
domNode.innerText = "Hello, Yuzhi"
// ä¸éœ€è¦å¤„ç† domNode.className
```

**é‚£ä¹ˆé’ˆå¯¹å‰¯ä½œç”¨å‡½æ•°, æ˜¯å¦ä¹Ÿèƒ½å¤Ÿåªåœ¨å¿…è¦çš„æ—¶å€™æ›´æ–°å‘¢?**

ä¸¾ä¸ªä¾‹å­, åœ¨ä»¥ä¸‹å‡½æ•°ä¸­, ç»„ä»¶ä¼šå› ä¸º state çš„æ›´æ–°è€Œé‡æ–°æ¸²æŸ“:

```jsx
function Greeting({ name }) {
  const [counter, setCounter] = useState(0)

  useEffect(() => {
    document.title = "Hello, " + name
  })

  return (
    <h1 className="Greeting">
      Hello, {name}
      // highlight-next-line
      <button onClick={() => setCounter(count + 1)}>Increment</button>
    </h1>
  )
}
```

ä½†æ˜¯æˆ‘ä»¬çš„å‰¯ä½œç”¨å‡½æ•°å¹¶æ²¡æœ‰ç”¨åˆ° `counter` çš„å€¼. **å‰¯ä½œç”¨å‡½æ•°åªä¼šæ ¹æ® `name` çš„å±æ€§å€¼æ›´æ–° `document.title`, ä½†æ˜¯ `name` å±æ€§å€¼å§‹ç»ˆæ˜¯ä¸€è‡´çš„.** å› æ­¤åœ¨æ¯æ¬¡ `counter` å€¼å˜åŒ–çš„æ—¶å€™ç»™ `document.title` é‡æ–°èµ‹å€¼æ˜¯å®Œå…¨æ²¡æœ‰å¿…è¦çš„.

é‚£ä¹ˆ React å¦‚ä½•åˆ†è¾¨å‰¯ä½œç”¨å‡½æ•°æ˜¯å¦éœ€è¦å˜åŒ–å‘¢?

```jsx
let oldEffect = () => {
  document.title = "Hello, Dan"
}
let newEffect = () => {
  document.title = "Hello, Dan"
}
// React èƒ½å¤Ÿçœ‹å‡ºè¿™ä¸¤ä¸ªå‡½æ•°åšäº†åŒæ ·çš„äº‹æƒ…å—?
```

å¹¶ä¸èƒ½, React åœ¨è°ƒç”¨å‡½æ•°ä¹‹å‰, æ˜¯æ— æ³•åˆ†æå‡ºè¿™ä¸ªå‡½æ•°æ‰€åšçš„äº‹æƒ…çš„. æºä»£ç å’Œä¸Šè¿°ä¾‹å­çš„åŒºåˆ«å°±æ˜¯: æºä»£ç å¹¶ä¸åŒ…å«å…·ä½“å€¼, è€Œåªæ˜¯ä¸€ä¸ª `name` å±æ€§.

å› æ­¤, æˆ‘ä»¬è¦é¿å…åœ¨ä¸å¿…è¦çš„æƒ…å†µä¸‹æ‰§è¡Œå‰¯ä½œç”¨å‡½æ•°, æ–¹å¼æ˜¯ä¼ å…¥ä¸€ä¸ªä¾èµ–æ•°ç»„å‚æ•°åˆ° `useEffect` æ–¹æ³•ä¸­, åªæœ‰å½“ä¾èµ–æ•°ç»„ä¸­çš„å€¼å˜åŒ–çš„æ—¶å€™, å‰¯ä½œç”¨å‡½æ•°æ‰ä¼šé‡æ–°æ‰§è¡Œ.

```jsx
useEffect(() => {
  document.title = "Hello, " + name
  // highlight-next-line
}, [name]) // ä¾èµ–æ•°ç»„å‚æ•°
```

**ä»¥ä¸Šçš„åœºæ™¯å°±å¥½åƒæ˜¯æˆ‘ä»¬åœ¨å‘Šè¯‰ React: "Hey React, æˆ‘çŸ¥é“ä½ ä¸èƒ½çœ‹åˆ°å‡½æ•°å†…éƒ¨çš„å†…å®¹, ä½†æ˜¯æˆ‘å¯ä»¥ç¡®ä¿å‡½æ•°å†…éƒ¨ä½¿ç”¨åˆ°çš„æ¸²æŸ“ç›¸å…³çš„å‚æ•°åªæœ‰ `name`. "**

å¦‚æœå‰ä¸€æ¬¡å‰¯ä½œç”¨å‡½æ•°æ‰§è¡Œæ—¶ `name` çš„å€¼ä¸è¿™ä¸€æ¬¡æ‰§è¡Œæ—¶ä¸€è‡´çš„è¯, é‚£ä¹ˆå°±å¯ä»¥è·³è¿‡æ­¤æ¬¡å‰¯ä½œç”¨å‡½æ•°çš„æ‰§è¡Œ:

```jsx
const oldEffect = () => {
  document.title = "Hello, Dan"
}
const oldDeps = ["Dan"]

const newEffect = () => {
  document.title = "Hello, Dan"
}
const newDeps = ["Dan"]

// React æ— æ³•çœ‹åˆ°å‡½æ•°å†…éƒ¨çš„æƒ…å†µ, ä½†æ˜¯å®ƒå¯ä»¥å¯¹æ¯”è¿™äº›ä¾èµ–å‚æ•°
// ç”±äºä¾èµ–å‚æ•°çš„å€¼å‰åå§‹ç»ˆä¸€è‡´, å°±ä¸éœ€è¦æ‰§è¡Œæ–°çš„å‰¯ä½œç”¨å‡½æ•°
```

å¦‚æœä¾èµ–æ•°ç»„ä¸­çš„æŸä¸ªå€¼åœ¨æ¸²æŸ“å‰åæœ‰æ‰€å·®å¼‚, é‚£ä¹ˆè¿™ä¸ªå‰¯ä½œç”¨å‡½æ•°å°±å¿…é¡»æ‰§è¡Œ. åŒæ­¥æ‰€æœ‰å€¼.

### è¦ç¡®ä¿ä¾èµ–æ•°ç»„ä¸­å‚æ•°çš„å‡†ç¡®æ€§ ä¸è¦æ¬ºéª— React

æ¬ºéª— React å…³äºä¾èµ–æ•°ç»„ä¸­çš„å†…å®¹ä¼šå¸¦æ¥æ¯”è¾ƒä¸å¥½çš„åæœ. <mark>Intuitively, this makes sense, but Iâ€™ve seen pretty much everyone who tries useEffect with a mental model from classes try to cheat the rules. (And I did that too at first!)</mark>

```jsx
function SearchResults() {
  async function fetchData() {
    // ...
  }

  useEffect(() => {
    fetchData()
  }, []) //  è¿™æ ·çš„å†™æ³•æ˜¯åˆç†çš„å—? åœ¨æŸäº›åœºæ™¯ä¸‹ä¸åˆç†, æˆ‘ä»¬å¯ä»¥æœ‰æ›´å¥½çš„æ–¹å¼æ¥ç¼–å†™è¿™éƒ¨åˆ†ä»£ç 

  // ...
}
```

_(å…³äº [Hooks çš„å¸¸è§é—®é¢˜](https://reactjs.org/docs/hooks-faq.html#is-it-safe-to-omit-functions-from-the-list-of-dependencies)ä¸­, å·²ç»è¯¦ç»†è¯´æ˜äº†æ›´åˆé€‚çš„åšæ³•. æˆ‘ä»¬å›åˆ°ç°åœ¨çš„ä¾‹å­:)_

ä½ æˆ–è®¸ä¼šè¿™æ ·è¯´: "ä½†æ˜¯æˆ‘åªå¸Œæœ›åœ¨ç»„ä»¶æŒ‚è½½çš„æ—¶å€™æ‰§è¡Œè¿™ä¸ªæ–¹æ³•!". æˆ‘ä»¬è¦è®°ä½è¿™æ ·ä¸€ä¸ªåŸåˆ™: å¦‚æœä½ å£°æ˜äº†ä¾èµ–å‚æ•°, **æ‰€æœ‰ç»„ä»¶å†…éƒ¨çš„å€¼, åªè¦è¢«å‰¯ä½œç”¨å‡½æ•°ä½¿ç”¨, å°±ä¸€å®šè¦æ·»åŠ åˆ°ä¾èµ–å‚æ•°æ•°ç»„ä¸­.** åŒ…æ‹¬ props, state, å‡½æ•°ç­‰ä»»ä½•åœ¨ç»„ä»¶å†…éƒ¨ä½¿ç”¨çš„å€¼.

ä½†æ˜¯æœ‰æ—¶å€™æˆ‘ä»¬å¯èƒ½ä¼šé‡åˆ°ä¸€äº›é—®é¢˜. æ¯”å¦‚å¾ªç¯è¯·æ±‚çš„æƒ…å†µ, æˆ–è€…æ˜¯æŸä¸ª socket ä¸æ–­è¢«é‡æ–°åˆ›å»ºçš„æƒ…å†µ. **é’ˆå¯¹è¿™äº›é—®é¢˜çš„å¤„ç†æ–¹å¼å¹¶ä¸æ˜¯åˆ é™¤è¿™ä¸ªä¾èµ–.** åé¢æˆ‘ä»¬ä¼šè°ˆåˆ°å¦‚ä½•è§£å†³è¿™äº›é—®é¢˜.

åœ¨æˆ‘ä»¬æŸ¥çœ‹è§£å†³æ–¹æ¡ˆä¹‹å‰, å…ˆæ·±å…¥äº†è§£ä¸€ä¸‹æˆ‘ä»¬çš„é—®é¢˜.
### å½“ä½ å¯¹ React æ’’è° ä¼ å…¥äº†é”™è¯¯çš„ä¾èµ–å‚æ•°ä¼šå‘ç”Ÿä»€ä¹ˆ

å¦‚æœä¾èµ–æ•°ç»„ä¸­åŒ…å«äº†æ‰€æœ‰å‰¯ä½œç”¨å‡½æ•°ä¼šç”¨åˆ°çš„å€¼, React å°±èƒ½å¤ŸçŸ¥é“ä½•æ—¶éœ€è¦é‡æ–°æ‰§è¡Œå‰¯ä½œç”¨å‡½æ•°:

```jsx
useEffect(() => {
  document.title = "Hello, " + name
  // highlight-next-line
}, [name])
```

![](/posts/images/deps-compare-correct.gif)

_(ä¾èµ–æ•°ç»„ä¸­çš„å€¼åœ¨æ¸²æŸ“å‰åæœ‰æ‰€å·®å¼‚, å› æ­¤æˆ‘ä»¬éœ€è¦é‡æ–°æ‰§è¡Œå‰¯ä½œç”¨å‡½æ•°.)_

å¦‚æœæˆ‘ä»¬åœ¨ä¾èµ–æ•°ç»„ä¸­ä¼ å…¥ç©ºæ•°ç»„`[]`, æ–°çš„å‰¯ä½œç”¨å‡½æ•°å°±ä¸ä¼šè¢«é‡æ–°æ‰§è¡Œ:

```jsx
useEffect(() => {
  document.title = "Hello, " + name
  // highlight-next-line
}, []) // ç¼ºå°‘äº† name å‚æ•°
```

![](/posts/images/deps-compare-wrong.gif)

_(ä¾èµ–æ•°ç»„å‰åä¸€è‡´, å› æ­¤è·³è¿‡è¿™æ¬¡å‰¯ä½œç”¨å‡½æ•°çš„æ‰§è¡Œ)_

é€šè¿‡ä»¥ä¸Šçš„åœºæ™¯å¯¹æ¯”, é—®é¢˜å°±å¾ˆæ˜æ˜¾åœ°ä½“ç°å‡ºæ¥äº†. <mark>But the intuition can fool you in other cases where a class solution â€œjumps outâ€ from your memory.</mark>

ä¸¾ä¸ªä¾‹å­, æ¯”å¦‚æˆ‘ä»¬æƒ³è¦å®ç°ä¸€ä¸ªè®¡æ•°å™¨, æ¯éš”ä¸€ç§’æ•°å­—åŠ  1. å¦‚æœæ˜¯ç±»å¼ç»„ä»¶çš„è¯, æˆ‘ä»¬ä¼šè¿™æ ·å®ç°å®ƒ: åœ¨ç»„ä»¶æŒ‚è½½çš„æ—¶å€™è®¾ç½®è®¡æ—¶å™¨å‡½æ•°, ç»„ä»¶å¸è½½çš„æ—¶å€™æ¸…é™¤.

è¿™æ˜¯å…·ä½“çš„[ä»£ç ç¤ºä¾‹](https://codesandbox.io/s/n5mjzjy9kl). å½“æˆ‘ä»¬æƒ³è¦æŠŠç±»å¼ç»„ä»¶è½¬æ¢æˆå‡½æ•°å¼ç»„ä»¶çš„æ—¶å€™, ä¼šä¹ æƒ¯æ€§åœ°ä½¿ç”¨ `useEffect`, è®¾ç½®ä¾èµ–å‚æ•°ä¸º `[]`, è¡¨ç¤ºå¸Œæœ›å‰¯ä½œç”¨å‡½æ•°åªæ‰§è¡Œä¸€æ¬¡.

```jsx
function Counter() {
  const [count, setCount] = useState(0)

  useEffect(() => {
    const id = setInterval(() => {
      setCount(count + 1)
    }, 1000)
    return () => clearInterval(id)
    // highlight-next-line
  }, [])

  return <h1>{count}</h1>
}
```

ä½†æ˜¯çœŸæ­£æ‰§è¡Œäº†ä¼šå‘ç°, ç»“æœå¹¶ä¸æ˜¯æˆ‘ä»¬æ‰€é¢„æœŸçš„é‚£æ ·. [ç¤ºä¾‹ä»£ç ](https://codesandbox.io/s/91n5z8jo7r).

å¦‚æœä½ çš„å¿ƒæ™ºæ¨¡å‹æ˜¯è¿™æ ·çš„: "ä¾èµ–çš„ä½œç”¨æ˜¯è®©æˆ‘å£°æ˜ä»€ä¹ˆæ—¶å€™éœ€è¦é‡æ–°è§¦å‘å‰¯ä½œç”¨å‡½æ•°çš„æ‰§è¡Œ", é‚£ä¹ˆä½ å†™å‡ºæ¥çš„ä»£ç å°±ä¼šå¾ˆå±é™©, å°±åƒä¸Šé¢çš„ä¾‹å­ä¸€æ ·. ä½†æ˜¯é—®é¢˜æ˜¯, ä½ å¸Œæœ›åªè§¦å‘ä¸€æ¬¡å‰¯ä½œç”¨æ–¹æ³•, å› ä¸ºè¿™æ˜¯ä¸€ä¸ªé—´éš”æ‰§è¡Œçš„ API, å®é™…ä¸Šå¹¶æ²¡æœ‰é”™, ä½†æ˜¯ä¸ºä»€ä¹ˆä¼šå¸¦æ¥é—®é¢˜å‘¢?

ä¹‹å‰å·²ç»æåˆ°è¿‡, å‰¯ä½œç”¨å‡½æ•°ä¸­ä½¿ç”¨åˆ°çš„*æ‰€æœ‰*å€¼, æˆ‘ä»¬éƒ½è¦åœ¨ä¾èµ–å‚æ•°æ•°ç»„ä¸­å£°æ˜. ç”±äºå†…éƒ¨ä½¿ç”¨åˆ°äº† `count`, ä½†æ˜¯æˆ‘ä»¬å¹¶æ²¡æœ‰åœ¨ä¾èµ–å‚æ•°æ•°ç»„ä¸­å£°æ˜, å¼•èµ· bug åªæ˜¯æ—¶é—´çš„é—®é¢˜.

åœ¨é¦–æ¬¡æ¸²æŸ“çš„æ—¶å€™, `count` çš„å€¼æ˜¯ `0`. `setCount(count + 1)` åœ¨é¦–æ¬¡æ¸²æŸ“æ—¶å®é™…æ‰§è¡Œçš„æ˜¯ `setCount(0 + 1)`. **ä½†æ˜¯å› ä¸ºæˆ‘ä»¬å£°æ˜çš„ä¾èµ–æ•°ç»„å‚æ•°ä¸­æ•°ç»„å€¼ä¸º `[]`, å› æ­¤å‰¯ä½œç”¨å‡½æ•°ä¸ä¼šå˜åŒ–, æ¯éš”ä¸€ç§’æ‰§è¡Œçš„å‡½æ•°éƒ½æ˜¯ `setCount(0 + 1)`**:

```jsx
// é¦–æ¬¡æ¸²æŸ“, state æ˜¯ 0
function Counter() {
  // ...
  useEffect(
    // é¦–æ¬¡æ¸²æŸ“çš„å‰¯ä½œç”¨å‡½æ•°
    () => {
      const id = setInterval(() => {
        // highlight-next-line
        setCount(0 + 1) // å§‹ç»ˆæ˜¯ setCount(1)
      }, 1000)
      return () => clearInterval(id)
    },
    // highlight-next-line
    [] // å§‹ç»ˆä¸ä¼šé‡æ–°æ‰§è¡Œ
  )
  // ...
}

// ä¸‹ä¸€æ¬¡æ¸²æŸ“, state æ˜¯ 1
function Counter() {
  // ...
  useEffect(
    // highlight-next-line
    // å‰¯ä½œç”¨å‡½æ•°è¢«å¿½ç•¥äº†, å› ä¸ºæˆ‘ä»¬çš„ä¾èµ–å‚æ•°ä¼ é€’é”™è¯¯.
    () => {
      const id = setInterval(() => {
        setCount(1 + 1)
      }, 1000)
      return () => clearInterval(id)
    },
    []
  )
  // ...
}
```

ç”±äºåœ¨ä¾èµ–å‚æ•°ä¸­ä¼ é€’äº†ä¸€ä¸ªç©ºæ•°ç»„, è¡¨æ˜äº†æˆ‘ä»¬çš„å‰¯ä½œç”¨å‡½æ•°ä¸ä¾èµ–ä»»ä½•å€¼. ä½†æ˜¯å®é™…ä¸Šå‰¯ä½œç”¨å‡½æ•°ä¸­å­˜åœ¨ä¾èµ–å…¶ä»–å€¼çš„éƒ¨åˆ†.

æˆ‘ä»¬çš„å‰¯ä½œç”¨å‡½æ•°ä½¿ç”¨åˆ°äº† `count`, è¿™ä¸ªå€¼å£°æ˜äºç»„ä»¶ä¹‹å†…, å‰¯ä½œç”¨å‡½æ•°ä¹‹å¤–:

```jsx
// highlight-next-line
const count = useEffect(() => {
  // ...
  const id = setInterval(() => {
    // highlight-next-line
    setCount(count + 1)
  }, 1000)
  return () => clearInterval(id)
}, [])
```

å› æ­¤, å°†ä¾èµ–å‚æ•°è®¾ç½®ä¸º `[]` ä¼šå¼•èµ· bug. React ä¼šå¯¹æ¯”ä¾èµ–é¡¹æ•°ç»„ä¸­çš„å†…å®¹, ç„¶åè·³è¿‡å‰¯ä½œç”¨å‡½æ•°çš„æ›´æ–°:

![](/posts/images/interval-wrong.gif)

_(ä¾èµ–é¡¹ä¸­çš„å†…å®¹å§‹ç»ˆæ²¡æœ‰åŒºåˆ«, å› æ­¤è·³è¿‡å‰¯ä½œç”¨å‡½æ•°çš„æ›´æ–°)_

è¿™æ ·çš„é—®é¢˜æ¯”è¾ƒéš¾å®šä½. å› æ­¤, æˆ‘å»ºè®®å¤§å®¶åœ¨ä¼ é€’ä¾èµ–é¡¹å‚æ•°çš„æ—¶å€™å¯¹ React ä¿æŒè¯šå®, å£°æ˜æ‰€æœ‰ä¾èµ–å‚æ•°. (æˆ‘ä»¬æä¾›äº†ä¸€ä¸ª [lint è§„åˆ™æ’ä»¶](https://github.com/facebook/react/issues/14920) ä»¥ä¾›ç”¨æˆ·åœ¨å¼€å‘é˜¶æ®µä½¿ç”¨.)

### ä¸¤ç§å¯¹ä¾èµ–é¡¹ä¿æŒè¯šå®çš„æ–¹å¼

å¯¹ä¾èµ–é¡¹ä¿æŒè¯šå®çš„æ–¹å¼æœ‰ä¸¤ç§, æˆ‘ä»¬ä¼˜å…ˆä½¿ç”¨ç¬¬ä¸€ç§æ–¹å¼, åœ¨å¿…è¦æƒ…å†µä¸‹ä½¿ç”¨ç¬¬äºŒç§æ–¹å¼.

**ç¬¬ä¸€ç§æ–¹å¼æ˜¯åœ¨ä¾èµ–é¡¹æ•°ç»„ä¸­å£°æ˜å‰¯ä½œç”¨å‡½æ•°çš„æ‰€æœ‰ä¾èµ–**, é’ˆå¯¹ä»¥ä¸Šçš„ä»£ç , æˆ‘ä»¬åŠ ä¸Š `count` ä½œä¸ºä¾èµ–é¡¹:

```jsx
useEffect(() => {
  const id = setInterval(() => {
    // highlight-next-line
    setCount(count + 1);
  }, 1000);
  return () => clearInterval(id);
    // highlight-next-line
}, [count]);
```

è¿™æ ·ä¸€æ¥, ä¾èµ–é¡¹æ•°ç»„çš„å£°æ˜å°±æ˜¯æ­£ç¡®çš„. è¿™å¹¶ä¸æ˜¯ _ç†æƒ³_ çš„è§£å†³æ–¹æ¡ˆ, ä½†æ˜¯è‡³å°‘è§£å†³äº†é—®é¢˜. ç°åœ¨åªè¦ `count` å‘ç”Ÿå˜åŒ–, å‰¯ä½œç”¨å‡½æ•°å°±ä¼šé‡æ–°æ‰§è¡Œ, å‰¯ä½œç”¨å‡½æ•°ä¸­è¯»å– `count` å€¼çš„éƒ¨åˆ†(`setCount(count + 1)`)ä¹Ÿä¼šå¯¹åº”åœ°å‘ç”Ÿå˜åŒ–:

```jsx
// é¦–æ¬¡æ¸²æŸ“, state å€¼ä¸º 0
function Counter() {
  // ...
  useEffect(
    // é¦–æ¬¡æ¸²æŸ“çš„å‰¯ä½œç”¨å‡½æ•°
    () => {
      const id = setInterval(() => {
        // highlight-next-line
        setCount(0 + 1); // setCount(count + 1)
      }, 1000);
      return () => clearInterval(id);
    },
    // highlight-next-line
    [0] // [count]
  );
  // ...
}

// ç¬¬äºŒæ¬¡æ¸²æŸ“, state å€¼ä¸º 1
function Counter() {
  // ...
  useEffect(
    // ç¬¬äºŒæ¬¡æ¸²æŸ“æ—¶çš„å‰¯ä½œç”¨å‡½æ•°
    () => {
      const id = setInterval(() => {
        // highlight-next-line
        setCount(1 + 1); // setCount(count + 1)
      }, 1000);
      return () => clearInterval(id);
    },
    // highlight-next-line
    [1] // [count]
  );
  // ...
}
```

è¿™æ ·ä¿®æ”¹ä¹‹å, [é—®é¢˜è§£å†³äº†](https://codesandbox.io/s/0x0mnlyq8l), ä½†æ˜¯åªè¦ `count` ä¸€å‘ç”Ÿå˜åŒ–, æˆ‘ä»¬çš„é—´éš”å‡½æ•°ä¼šä¸æ–­è¢«é”€æ¯é‡å»º. è¿™å¹¶ä¸æ˜¯æˆ‘ä»¬æ‰€é¢„æœŸçš„è¡Œä¸º:


![](/posts/images/interval-rightish.gif)


_(ä¾èµ–é¡¹å˜åŒ–äº†, å› æ­¤æˆ‘ä»¬é‡æ–°æ‰§è¡Œå‰¯ä½œç”¨å‡½æ•°.)_

---

**ç¬¬äºŒç§æ–¹å¼æ˜¯æ”¹å˜å‰¯ä½œç”¨å‡½æ•°æœ¬èº«, ä½¿å¾—å®ƒä¸ä¾èµ–å¤–éƒ¨ç»å¸¸ä¼šå˜åŒ–çš„å€¼.** æˆ‘ä»¬ä¸æƒ³è¦æ¬ºéª— React å…³äºä¾èµ–é¡¹çš„å†…å®¹, äºæ˜¯å°½å¯èƒ½å¾—å‡å°‘ä¾èµ–é¡¹çš„å†…å®¹.

ç°åœ¨æˆ‘ä»¬å¼€å§‹çœ‹çœ‹å‡å°‘ä¾èµ–é¡¹çš„å¸¸ç”¨æ–¹æ³•.

---

### ç”¨å‡½æ•°çš„æ–¹å¼æ›´æ–°çŠ¶æ€

ç°åœ¨æˆ‘ä»¬çš„è¯‰æ±‚æ˜¯å°† `count` ä¾èµ–ä»å‰¯ä½œç”¨æ–¹æ³•çš„ä¾èµ–ä¸­ç§»é™¤.

```jsx
  useEffect(() => {
    const id = setInterval(() => {
      // highlight-next-line
      setCount(count + 1);
    }, 1000);
    return () => clearInterval(id);
     // highlight-next-line
  }, [count]);
```

ä¸ºäº†è¾¾åˆ°æˆ‘ä»¬çš„ç›®çš„, é¦–å…ˆæ€è€ƒä¸€ä¸ªé—®é¢˜, **`count` çš„ä½œç”¨æ˜¯ä»€ä¹ˆå‘¢?** çœ‹èµ·æ¥åªæœ‰åœ¨ `setCount` å‡½æ•°ä¸­æ‰ä¼šç”¨åˆ°å®ƒ. è¿™æ ·åˆ†æä¸‹æ¥å‘ç°, æˆ‘ä»¬çš„å‰¯ä½œç”¨å‡½æ•°å†…å…¶å®å¯ä»¥ä¸ä¾èµ– `count`. å½“æˆ‘ä»¬éœ€è¦åŸºäºå‰ä¸€ä¸ªçŠ¶æ€æ›´æ–°å½“å‰çŠ¶æ€çš„æ—¶å€™, å¯ä»¥ç”¨ `setState` çš„[å‡½æ•°æ›´æ–°çš„æ–¹å¼](https://reactjs.org/docs/hooks-reference.html#functional-updates)æ›´æ–°çŠ¶æ€.

```jsx
  useEffect(() => {
    const id = setInterval(() => {
      // highlight-next-line
      setCount(c => c + 1);
    }, 1000);
    return () => clearInterval(id);
  }, []);
```

æˆ‘å€¾å‘äºå°†è¿™äº›æƒ…å†µçœ‹ä½œæ˜¯"é”™è¯¯çš„ä¾èµ–". å¦‚æœæˆ‘ä»¬çš„å‰¯ä½œç”¨å‡½æ•°çš„å†…å®¹æ˜¯ `setCount(count + 1)`, é‚£ä¹ˆ `count` å°±æ˜¯ä¸€ä¸ªå¿…è¦çš„ä¾èµ–é¡¹. å†ä»”ç»†è§‚å¯Ÿå¯ä»¥å‘ç°, æˆ‘ä»¬å…¶å®åªä¾èµ– `count` çš„å€¼ç”¨æ¥è®¡ç®— `count + 1`, ç„¶åå°†è®¡ç®—å¾—å‡ºçš„å€¼æŠ›ç»™ React. ä¸è¿‡, React å…¶å®æ—©å·²çŸ¥é“å½“å‰çš„ `count` å€¼. **é‚£ä¹ˆæˆ‘ä»¬åªéœ€è¦å‘Šè¯‰ React , å¦‚ä½•æ›´æ–°(+1) `count` å€¼, å°±å¯ä»¥äº†, ä¸ç®¡å½“å‰çš„ `count` å€¼æ˜¯å¤šå°‘, React éƒ½èƒ½å¤Ÿæ­£ç¡®è®¡ç®—æœ€ç»ˆçš„ç»“æœ.**

å…¶å®, `setCount(c => c + 1)` åšçš„å°±æ˜¯è¿™ä»¶äº‹æƒ…. ä½ å¯ä»¥è®¤ä¸ºå®ƒä¼ é€’äº†ä¸€ä¸ªæŒ‡ä»¤ç»™ React, å‘Šè¯‰ React åº”è¯¥å¦‚ä½•æ›´æ–°çŠ¶æ€çš„å€¼. è¿™ç§æ›´æ–°çŠ¶æ€çš„å½¢å¼åœ¨ä¸€äº›å…¶ä»–åœºæ™¯ä¸‹åŒæ ·èƒ½å¤Ÿå‘æŒ¥å¾ˆå¤§çš„ç”¨å¤„, æ¯”å¦‚å½“æˆ‘ä»¬éœ€è¦[åˆå¹¶çŠ¶æ€çš„æ›´æ–°](https://overreacted.io/react-as-a-ui-runtime/#batching)çš„æ—¶å€™.

**æ³¨æ„, æ­¤æ—¶æˆ‘ä»¬å°†ä¾èµ–ä»ä¾èµ–æ•°ç»„ä¸­åˆ é™¤, æ˜¯çœŸæ­£ä¸éœ€è¦è¿™ä¸ªä¾èµ–äº†, å¹¶æ²¡æœ‰æ¬ºéª— React, æˆ‘ä»¬çš„å‰¯ä½œç”¨å‡½æ•°ç¡®å®ä¸å†éœ€è¦è¯»å– `count` çš„å€¼äº†.**

![](/posts/images/interval-right.gif)

_(ä¾èµ–é¡¹å‰åä¸€è‡´, å› æ­¤æˆ‘ä»¬è·³è¿‡å‰¯ä½œç”¨æ–¹æ³•çš„æ‰§è¡Œ)_

å¯ä»¥åœ¨è¿™é‡Œ[è¯•ä¸€è¯•](https://codesandbox.io/s/q3181xz1pj).

å°½ç®¡å‰¯ä½œç”¨å‡½æ•°åªæ‰§è¡Œäº†ä¸€æ¬¡, å±äºç¬¬ä¸€æ¬¡æ¸²æŸ“ interval å›è°ƒå‡½æ•°ä¾ç„¶åœ¨æ¯æ¬¡æ‰§è¡Œçš„æ—¶å€™, å®Œç¾åœ°å°† `c => c + 1` çš„æ›´æ–°æŒ‡ä»¤ä¼ è¾¾ç»™äº† React . å‰¯ä½œç”¨å‡½æ•°ä¸å†ä¾èµ–å½“å‰çš„ `count` å€¼, å› ä¸º React å·²ç»çŸ¥é“å®ƒçš„å€¼äº†.
### å‡½æ•°å¼æ›´æ–°ä¸ Google Docs

è¿˜è®°å¾—æˆ‘ä»¬æåˆ°çš„, å‰¯ä½œç”¨çš„å¿ƒæ™ºæ¨¡å‹ä¸åŒæ­¥æœ‰å…³å—? å…³äºåŒæ­¥å¾ˆæœ‰æ„æ€çš„ä¸€ç‚¹æ˜¯, æˆ‘ä»¬é€šå¸¸å¸Œæœ›è§£è€¦ç³»ç»Ÿå’Œç³»ç»Ÿå†…éƒ¨çŠ¶æ€ä¹‹é—´çš„é€šä¿¡. ä¸¾ä¸ªä¾‹å­, å½“æˆ‘ä»¬åœ¨ Google Docs ä¸Šç¼–è¾‘ä¸€ä»½æ–‡æ¡£æ—¶, å¹¶æ²¡æœ‰å°†æ•´ä¸ªé¡µé¢å†…å®¹ä¼ ç»™æœåŠ¡å™¨, å› ä¸ºè¿™æ ·å°†ä¼šååˆ†ä½æ•ˆ. å–è€Œä»£ä¹‹ä¼ é€’çš„æ˜¯ç”¨æˆ·è¦åšçš„åŠ¨ä½œ.

å½“ç„¶æˆ‘ä»¬çš„åœºæ™¯å’Œ Google Docs å¹¶ä¸å®Œå…¨ç›¸åŒ, **ä¸è¿‡è¿™ç§å“²å­¦åœ¨ effect ä¸­åŒæ ·é€‚ç”¨. åªä¼ é€’å°½å¯èƒ½å°‘çš„å¿…éœ€çš„ä¿¡æ¯åˆ°ç»„ä»¶ä¸­.** æ›´æ–°çŠ¶æ€çš„å‡½æ•°å½¢å¼ `setCount(c => c + 1)` æ¯”èµ· `setCount(count + 1)` è¡¨è¾¾äº†æ›´å°‘çš„ä¿¡æ¯. å› ä¸º `setCount` ä¾èµ–äºå½“å‰ `count` çš„å€¼. è¦æŠŠ React å†™å¥½, æˆ‘ä»¬åº”è¯¥ç§‰æ‰¿è¿™æ ·ä¸€ä¸ªç†å¿µ: é€‰æ‹©å°½å¯èƒ½ç®€å•çš„ state å½¢å¼æ¥è¡¨è¾¾ UI. è¿™ç§ç†å¿µåœ¨çŠ¶æ€çš„æ›´æ–°ä¸­åŒæ ·é€‚ç”¨.

å¯¹ _æ„å›¾_ (è€Œä¸æ˜¯ç»“æœ)è¿›è¡Œç¼–ç , ä¸ Google Docs [è§£å†³ååŒç¼–è¾‘](https://medium.com/@srijancse/how-real-time-collaborative-editing-work-operational-transformation-ac4902d75682)çš„æ–¹æ¡ˆå¾ˆç›¸ä¼¼. åœ¨ React ä¸­ç”¨å‡½æ•°å½¢å¼æ›´æ–°çŠ¶æ€ä¹Ÿæ˜¯ç±»ä¼¼çš„å®è·µ. è¿™æ ·çš„æ–¹å¼ç¡®ä¿äº†, å³ä½¿æ›´æ–°æ¥è‡ªäºå¤šä¸ªæ¥æº(äº‹ä»¶å¤„ç†å™¨, å‰¯ä½œç”¨å‡½æ•°è®¢é˜…ç­‰), ä¹Ÿèƒ½å¤Ÿåœ¨ä¸€æ¬¡æ‰¹é‡æ“ä½œä¸­æ­£ç¡®åœ°æ‰§è¡Œ, å¹¶ä¸”èƒ½å¤Ÿé¢„æµ‹æ›´æ–°çš„ç»“æœ.

**ä¸è¿‡, `setCount(c => c + 1)` çš„æ›´æ–°æ–¹å¼å¹¶ä¸æ˜¯ç‰¹åˆ«å®Œç¾.** å› ä¸ºè¿™ç§å½¢å¼çœ‹èµ·æ¥æœ‰ç‚¹å¥‡æ€ª, å¹¶ä¸”åœ¨æŸç§ç¨‹åº¦ä¸Šé™åˆ¶äº†æˆ‘ä»¬çš„èƒ½åŠ›. æ¯”å¦‚è¯´, å½“æˆ‘ä»¬æœ‰ä¸¤ä¸ªçŠ¶æ€å˜é‡, ä¸”ä¸¤è€…äº’ç›¸ä¾èµ–, æˆ–è€…æ˜¯æˆ‘ä»¬éœ€è¦é€šè¿‡å±æ€§è®¡ç®—ä¸‹ä¸€æ¬¡æ¸²æŸ“çš„çŠ¶æ€å€¼æ—¶, å°±æ²¡åŠæ³•ä½¿ç”¨å‡½æ•°å¼çš„æ›´æ–°æ–¹å¼. ä¸è¿‡å¹¸è¿çš„æ˜¯, æˆ‘ä»¬è¿˜æœ‰ `useReducer`, å®ƒçš„æ›´æ–°æ–¹å¼ä¸å‡½æ•°å¼çš„æ›´æ–°æ–¹å¼ç±»ä¼¼, ä½†æ˜¯åŠŸèƒ½æ›´åŠ å¼ºå¤§.

### å°†çŠ¶æ€æ›´æ–°ä» actions ä¸­è§£è€¦

ç°åœ¨ä¿®æ”¹ä»¥ä¸Šçš„ç¤ºä¾‹, æ”¹ä¸ºå­˜åœ¨ä¸¤ä¸ªçŠ¶æ€ç›¸å…³çš„å˜é‡: `count` å’Œ `step`. æˆ‘ä»¬çš„é—´éš”æ‰§è¡Œå‡½æ•°ä¸æ˜¯æ¯ç§’åŠ  1, è€Œæ˜¯æ¯ç§’åŠ ä¸Š `step` å˜é‡æ‰€æŒ‡çš„å€¼:

```jsx
function Counter() {
  const [count, setCount] = useState(0)
  const [step, setStep] = useState(1)

  useEffect(() => {
    const id = setInterval(() => {
      // highlight-next-line
      setCount(c => c + step)
    }, 1000)
    return () => clearInterval(id)
    // highlight-next-line
  }, [step])

  return (
    <>
      <h1>{count}</h1>
      <input value={step} onChange={e => setStep(Number(e.target.value))} />
    </>
  )
}
```

(è¿™é‡Œæ˜¯[ä»£ç ç¤ºä¾‹](https://codesandbox.io/s/zxn70rnkx))

æ­¤åˆ»æˆ‘ä»¬**å¹¶æ²¡æœ‰æ¬ºéª—** React. å› ä¸ºåœ¨å‰¯ä½œç”¨å‡½æ•°ä¸­ä½¿ç”¨äº† `step` , æˆ‘ä»¬åœ¨ä¾èµ–å‚æ•°ä¸­ä¹ŸåŠ ä¸Šäº†å®ƒ, å› æ­¤å‡½æ•°æ‰§è¡Œçš„ç»“æœå§‹ç»ˆæ˜¯å‡†ç¡®çš„.

å¯¹äºä¸Šè¿°çš„ä¾‹å­, å¯ä»¥è¿™æ ·æè¿°å®ƒçš„è¡Œä¸º, ä¸€æ—¦ `step` çš„å€¼å‘ç”Ÿå˜åŒ–, å°±é‡æ–°å¼€å§‹æ‰§è¡Œè¿™ä¸ªé—´éš” (interval) å‡½æ•°(å› ä¸º `step` å­˜åœ¨äºä¾èµ–å‚æ•°æ•°ç»„ä¸­). å¤§å¤šæ•°æƒ…å†µä¸‹, è¿™å°±æ˜¯æˆ‘ä»¬æœŸå¾…çš„ç»“æœ: é”€æ¯å‰¯ä½œç”¨å‡½æ•°å¹¶åˆ›å»ºä¸€ä¸ªå…¨æ–°çš„å‰¯ä½œç”¨å‡½æ•°. è¿™æ˜¯ä¸€ä¸ªæ¯”è¾ƒåˆç†çš„æ¨¡å¼, æ­£å¸¸æƒ…å†µä¸‹, å®ƒä¹Ÿæ˜¯å”¯ä¸€å¯ä»¥é€‰æ‹©çš„æ›´æ–°æ–¹å¼.

ä¸è¿‡, å¦‚æœæˆ‘ä»¬æœŸå¾…çš„ç»“æœæ˜¯è¿™æ ·çš„, å¯èƒ½å°±æ²¡åŠæ³•é‡‡å–ä»¥ä¸Šæ¨¡å¼äº†: æˆ‘ä»¬ä¸å¸Œæœ› `step` å˜åŒ–å¼•èµ·å‰¯ä½œç”¨å‡½æ•°çš„é”€æ¯å’Œé‡æ–°åˆ›å»º, é‚£ä¹ˆåº”è¯¥æ€ä¹ˆæ ·æ‰èƒ½æŠŠ `step` ä»å‰¯ä½œç”¨å‡½æ•°çš„ä¾èµ–æ•°ç»„ä¸­åˆ é™¤å‘¢?

**å½“æˆ‘ä»¬é‡åˆ°è¿™æ ·çš„åœºæ™¯: state ä¸­çš„æŸä¸ªå€¼ä¾èµ– state ä¸­çš„å¦ä¸€ä¸ªå€¼, å¯ä»¥è€ƒè™‘ä½¿ç”¨ `useReducer` æ¥è¾¾åˆ°æ›´æ–°çŠ¶æ€çš„ç›®çš„.**

å½“ä½ å‘ç°ä½ å†™çš„è®¾ç½®çŠ¶æ€ç›¸å…³çš„ä»£ç å˜æˆå¦‚ä¸‹è¿™æ ·çš„æ—¶å€™: `setSomething(something => ...)`, å°±å¯ä»¥å¼€å§‹è€ƒè™‘ä½¿ç”¨ reducer äº†. reducer èƒ½å¤Ÿå¸®åŠ©æˆ‘ä»¬å°†ç»„ä»¶å†…éƒ¨è¡¨è¾¾ actions çš„é€»è¾‘å’ŒçŠ¶æ€æ›´æ–°çš„é€»è¾‘è¿›è¡Œè§£è€¦. 

ç°åœ¨ç”¨ `dispatch` ä¾èµ–æ¥æ›¿æ¢ä»£ç ä¸­çš„ `step` ä¾èµ–:

```jsx
// highlight-next-line
const [state, dispatch] = useReducer(reducer, initialState)
const { count, step } = state

useEffect(() => {
  const id = setInterval(() => {
    // highlight-next-line
    dispatch({ type: "tick" }) // Instead of setCount(c => c + step);
  }, 1000)
  return () => clearInterval(id)
  // highlight-next-line
}, [dispatch])
```

(è¿™é‡Œæ˜¯[ä»£ç ç¤ºä¾‹](https://codesandbox.io/s/xzr480k0np))

ä½ æˆ–è®¸ä¼šç–‘æƒ‘: "è¿™æ ·çš„æ–¹å¼ä¸ºä»€ä¹ˆæ›´å¥½å‘¢?" å› ä¸º **React ä¼šç¡®ä¿ `dispatch` å‡½æ•°åœ¨ç»„ä»¶è¢«åˆ›å»ºä¹‹å, åœ¨ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸé—´, å§‹ç»ˆæ˜¯ä¸€ä¸ªå¸¸é‡. å› æ­¤åœ¨ä»¥ä¸Šçš„ç¤ºä¾‹ä¸­, ä¸éœ€è¦å†é‡æ–°è®¢é˜… interval å‡½æ•°.**

è‡³æ­¤, å·²ç»è§£å†³äº†æˆ‘ä»¬çš„é—®é¢˜!

_(ä½ æˆ–è®¸ä¼šåœ¨ä¾èµ–æ•°ç»„ä¸­çœå» `dispatch`, `setState`, æˆ–è€… `useRef` è¿™äº›å‡½æ•°, å› ä¸ºå®ƒä»¬å§‹ç»ˆä¸ä¼šå˜åŒ–, ç¡®å®æ˜¯è¿™æ ·, æ˜¯å¦å°†å®ƒä»¬å†™å…¥ä¾èµ–æ•°ç»„ä¸­éƒ½æ— æ‰€è°“.)_

`dispatch` å‡½æ•°åšçš„äº‹æƒ…, å¹¶ä¸æ˜¯è¯»å–å‰¯ä½œç”¨å‡½æ•°å†…éƒ¨çš„ state, è€Œæ˜¯åˆ†å‘ä¸€ä¸ª action, æè¿°*å‘ç”Ÿäº†ä»€ä¹ˆ*. è¿™æ ·çš„æ–¹å¼ä½¿å¾—å‰¯ä½œç”¨å‡½æ•°èƒ½å¤Ÿå’Œ `step` çŠ¶æ€è§£è€¦. æˆ‘ä»¬çš„å‰¯ä½œç”¨å‡½æ•°å…¶å®å¹¶ä¸åœ¨æ„æˆ‘ä»¬å¦‚ä½•æ›´æ–°çŠ¶æ€. å®ƒåªæ˜¯å•çº¯åœ°å‘Šè¯‰æˆ‘ä»¬*å‘ç”Ÿäº†ä»€ä¹ˆ*. reducer å‡½æ•°, åˆ™åªå…³æ³¨çŠ¶æ€æ›´æ–°çš„é€»è¾‘:

```jsx
const initialState = {
  count: 0,
  step: 1,
}

function reducer(state, action) {
  const { count, step } = state
  // highlight-start
  if (action.type === "tick") {
    return { count: count + step, step }
    // highlight-end
  } else if (action.type === "step") {
    return { count, step: action.step }
  } else {
    throw new Error()
  }
}
```

è¿™é‡Œæ˜¯[ä»£ç ç¤ºä¾‹](https://codesandbox.io/s/xzr480k0np).

### ä¸ºä»€ä¹ˆ useReducer æ˜¯ Hooks çš„æ¬ºéª—æ¨¡å¼

æˆ‘ä»¬å·²ç»çŸ¥é“, å½“å‰¯ä½œç”¨å‡½æ•°ä¸­çŠ¶æ€çš„æ›´æ–°ä¾èµ–å‰ä¸€æ¬¡æ¸²æŸ“æ—¶çš„çŠ¶æ€å€¼, æˆ–è€…å¦ä¸€ä¸ªçŠ¶æ€å€¼çš„æ—¶å€™, åº”è¯¥é€šè¿‡ä»€ä¹ˆæ–¹å¼ç§»é™¤å‡½æ•°çš„ä¾èµ–é¡¹. **é‚£ä¹ˆå½“æˆ‘ä»¬ä¾èµ–å±æ€§ *props* çš„æ—¶å€™, åº”è¯¥æ€ä¹ˆå¤„ç†å‘¢?** ä¸¾ä¸ªä¾‹å­, å½“æˆ‘ä»¬çš„ API æ˜¯ `<Counter step={1}>`. æ­¤æ—¶, æˆ‘ä»¬æ˜¯å¦å¿…é¡»è¦åœ¨ä¾èµ–æ•°ç»„ä¸­å£°æ˜ `props.step` å‘¢?

æœ‰ä¸å¿…å£°æ˜çš„æ–¹æ³•! å¯ä»¥å°† reducer å‡½æ•°*æœ¬èº«*ç½®äºæˆ‘ä»¬çš„ç»„ä»¶å†…éƒ¨, è¿™æ · reducer å°±èƒ½å¤Ÿç›´æ¥è¯»å–å¯¹åº”çš„ props:

```jsx
// highlight-next-line
function Counter({ step }) {
  const [count, dispatch] = useReducer(reducer, 0)

  function reducer(state, action) {
    if (action.type === "tick") {
      // highlight-next-line
      return state + step
    } else {
      throw new Error()
    }
  }

  useEffect(() => {
    const id = setInterval(() => {
      dispatch({ type: "tick" })
    }, 1000)
    return () => clearInterval(id)
  }, [dispatch])

  return <h1>{count}</h1>
}
```

ä½†æ˜¯è¿™ç§æ¨¡å¼æœ‰ä¸ªé—®é¢˜, é‡‡å–è¿™ç§æ¨¡å¼ä¹‹å, æˆ‘ä»¬å°±æ— æ³•è¿›è¡Œä¸€äº›å¿…è¦çš„ä¼˜åŒ–. æ¯”è¾ƒå¥½çš„ä¸€ç‚¹æ˜¯, åœ¨å¿…è¦æƒ…å†µä¸‹, reducer å‡½æ•°ä¸­èƒ½å¤Ÿä»»æ„è¯»å–æ‰€éœ€çš„ props. (è¿™é‡Œæ˜¯[ä»£ç ç¤ºä¾‹](https://codesandbox.io/s/7ypm405o8q).)

**å³ä½¿æ˜¯åœ¨è¿™æ ·çš„æƒ…å†µä¸‹, æˆ‘ä»¬çš„ `dispatch` å‡½æ•°ä¾ç„¶èƒ½å¤Ÿä¿è¯åœ¨ç»„ä»¶å¤šæ¬¡æ¸²æŸ“çš„è¿‡ç¨‹ä¸­å§‹ç»ˆä¿æŒä¸å˜.** å› æ­¤åœ¨ä¾èµ–é¡¹æ•°ç»„ä¸­å¿½ç•¥è¿™ä¸ªå‡½æ•°æ˜¯å®Œå…¨åˆç†çš„, å®ƒä¸ä¼šå¼•èµ·å‰¯ä½œç”¨å‡½æ•°çš„é‡æ–°æ‰§è¡Œ.

ä½ æˆ–è®¸ä¼šå¯¹è¿™ç§æ¨¡å¼çš„åº•å±‚åŸç†æ„Ÿåˆ°å¥½å¥‡. å½“æˆ‘ä»¬åœ¨ä¸€ä¸ªå‰¯ä½œç”¨å‡½æ•°ä¸­ä½¿ç”¨ reducer çš„æ—¶å€™, å®ƒæ˜¯æ€ä¹ˆ"çŸ¥é“"å¦ä¸€æ¬¡æ¸²æŸ“æ—¶çš„ props çš„å‘¢? è¿™æ˜¯å› ä¸ºå½“ä½ è°ƒç”¨ `dispatch` çš„æ—¶å€™, React ä¼šè®°ä½è¿™ä¸ª action, ç„¶ååœ¨ä¸‹ä¸€æ¬¡æ¸²æŸ“çš„æ—¶å€™ _è°ƒç”¨_ reducer. æ­¤æ—¶, æœ€æ–°çš„ props å°±å¤„äºæ¸²æŸ“çš„ä½œç”¨åŸŸä¸­äº†, <mark>and you wonâ€™t be inside an effect. </mark>

**è¿™ä¹Ÿæ˜¯æˆ‘å€¾å‘äºå°† `useReducer` çœ‹ä½œ Hooks çš„"æ¬ºéª—æ¨¡å¼"çš„åŸå› . ä½¿ç”¨ `useReducer`, æˆ‘ä»¬èƒ½å¤Ÿå°†çŠ¶æ€æ›´æ–°çš„é€»è¾‘å’Œæè¿°å‘ç”Ÿäº†ä»€ä¹ˆçš„é€»è¾‘è¿›è¡Œè§£è€¦. åŒæ—¶å¸®åŠ©æˆ‘ä»¬åœ¨ä¾èµ–é¡¹æ•°ç»„ä¸­åˆ é™¤ä¸å¿…è¦çš„ä¾èµ–, é¿å…ä¸å¿…è¦çš„å‰¯ä½œç”¨é‡æ–°æ‰§è¡Œ, ä¼˜åŒ–åº”ç”¨çš„æ€§èƒ½.**

### å°†å‡½æ•°ç§»åŠ¨åˆ°å‰¯ä½œç”¨å†…éƒ¨

è¿˜æœ‰ä¸€ä¸ªæ¯”è¾ƒå¸¸è§çš„è¯¯åŒºæ˜¯è®¤ä¸ºå‡½æ•°ä¸åº”è¯¥æ˜¯å‰¯ä½œç”¨å‡½æ•°çš„ä¾èµ–, å®é™…ä¸Šå¹¶ä¸æ˜¯è¿™æ ·. ä¸¾ä¸ªä¾‹å­:

```jsx
function SearchResults() {
  const [data, setData] = useState({ hits: [] });

  async function fetchData() {
    const result = await axios(
      'https://hn.algolia.com/api/v1/search?query=react',
    );
    setData(result.data);
  }

  useEffect(() => {
    fetchData();
    // highlight-next-line
  }, []); // è¿™æ ·æ˜¯å¯ä»¥çš„å—

  // ...
```

([ä»£ç ç¤ºä¾‹](https://codesandbox.io/s/8j4ykjyv0) æ¥è‡ªäº _Robin Wieruch_ çš„[æ–‡ç« ](https://www.robinwieruch.de/react-hooks-fetch-data))

ä»£ç å®é™…ä¸Šæ˜¯æœ‰ä½œç”¨çš„. **ä½†é—®é¢˜æ˜¯, ç®€å•åœ°çœç•¥å†…éƒ¨å‡½æ•°ä¾èµ–, å½“ç»„ä»¶çš„è§„æ¨¡å˜å¤§ä¹‹å, æˆ‘ä»¬ä¼šå¾ˆéš¾å‘ç°ä»£ç æ˜¯å¦è¦†ç›–äº†æ‰€æœ‰æƒ…å†µ.**

å‡è®¾æˆ‘ä»¬çš„ä»£ç å˜æˆå¦‚ä¸‹è¿™æ ·, æ¯ä¸€ä¸ªå‡½æ•°å˜ä¸ºåŸæ¥çš„äº”å€è§„æ¨¡:

```jsx
function SearchResults() {
  // å‡è®¾è¿™æ˜¯ä¸ªå¾ˆé•¿çš„å‡½æ•°
  function getFetchUrl() {
    return "https://hn.algolia.com/api/v1/search?query=react"
  }

  // å‡è®¾è¿™ä¹Ÿæ˜¯ä¸ªå¾ˆé•¿çš„å‡½æ•°
  async function fetchData() {
    const result = await axios(getFetchUrl())
    setData(result.data)
  }

  useEffect(() => {
    fetchData()
  }, [])

  // ...
}
```

ç„¶åæˆ‘ä»¬åœ¨è¿™äº›å‡½æ•°ä¸­ä½¿ç”¨ä¸€äº› state æˆ– props:

```jsx
function SearchResults() {
  const [query, setQuery] = useState("react")

  // å‡è®¾è¿™æ˜¯ä¸ªå¾ˆé•¿çš„å‡½æ•°
  function getFetchUrl() {
    // highlight-next-line
    return "https://hn.algolia.com/api/v1/search?query=" + query
  }

  // å‡è®¾è¿™ä¹Ÿæ˜¯ä¸ªå¾ˆé•¿çš„å‡½æ•°
  async function fetchData() {
    const result = await axios(getFetchUrl())
    setData(result.data)
  }

  useEffect(() => {
    fetchData()
  }, [])

  // ...
}
```

å¦‚æœæˆ‘ä»¬å¿˜äº†æ›´æ–°æ•°ç»„çš„ä¾èµ–é¡¹, é—æ¼äº†æŸäº›æ–¹æ³•çš„è¯, å‰¯ä½œç”¨å‡½æ•°å°±å¾ˆå¯èƒ½æ— æ³•å‡†ç¡®åŒæ­¥ props å’Œ state ä¸­çš„æŸäº›å€¼. å¼•èµ·ä¸€äº› bug.

ä¸è¿‡å¹¸è¿çš„æ˜¯, æœ‰ä¸ªç®€å•çš„è§£å†³åŠæ³•. **å¦‚æœæˆ‘ä»¬åªåœ¨å‰¯ä½œç”¨å‡½æ•°å†…ç”¨åˆ°ç›¸å…³çš„å‡½æ•°, å¯ä»¥ç›´æ¥å°†å‡½æ•°ç§»åˆ°å‰¯ä½œç”¨å‡½æ•°å†…éƒ¨:**

```jsx
function SearchResults() {
  // ...
  useEffect(() => {
    // highlight-start
    // ç§»åŠ¨åˆ°å‰¯ä½œç”¨å‡½æ•°å†…éƒ¨
    function getFetchUrl() {
      return "https://hn.algolia.com/api/v1/search?query=react"
    }
    async function fetchData() {
      const result = await axios(getFetchUrl())
      setData(result.data)
    }
    // highlight-end

    fetchData()
  }, []) // âœ… ä¾èµ–å£°æ˜æ­£ç¡®
  // ...
}
```

(è¿™é‡Œæ˜¯ä»£ç [ç¤ºä¾‹](https://codesandbox.io/s/04kp3jwwql))

è¿™æ ·çš„æ–¹å¼æœ‰ä»€ä¹ˆå¥½å¤„å‘¢? æˆ‘ä»¬ä¸å†éœ€è¦è€ƒè™‘ <mark> â€œtransitive dependenciesâ€ </mark>. ä¾èµ–å‚æ•°æ•°ç»„ä¹Ÿä¸ä¼šå†æ¬ºéª— React: **å› ä¸ºæˆ‘ä»¬æ²¡æœ‰ä½¿ç”¨ä»»ä½•å‰¯ä½œç”¨å‡½æ•°å¤–éƒ¨çš„å€¼.**

å¦‚æœåç»­æ›´æ–° `getFetchUrl` æ–¹æ³•: å†…éƒ¨ä½¿ç”¨ `state` ä¸­çš„ `query` å€¼, å°±ä¼šæ³¨æ„åˆ°æˆ‘ä»¬æ­£åœ¨ç¼–è¾‘å‰¯ä½œç”¨å‡½æ•°*å†…éƒ¨*çš„å†…å®¹ä¾èµ–ä¸€ä¸ªå¤–éƒ¨çš„å€¼ -- å› æ­¤æˆ‘ä»¬éœ€è¦åœ¨ä¾èµ–å‚æ•°ä¸­æ·»åŠ  `query`:

```jsx
function SearchResults() {
  const [query, setQuery] = useState("react")

  useEffect(() => {
    function getFetchUrl() {
      // highlight-next-line
      return "https://hn.algolia.com/api/v1/search?query=" + query
    }

    async function fetchData() {
      const result = await axios(getFetchUrl())
      setData(result.data)
    }

    fetchData()
    // highlight-next-line
  }, [query]) // âœ… ä¾èµ–é¡¹å‡†ç¡®

  // ...
}
```

(ä»£ç [ç¤ºä¾‹](https://codesandbox.io/s/pwm32zx7z7))

æ·»åŠ è¿™é¡¹ä¾èµ–çš„è¡Œä¸º, å¹¶ä¸æ˜¯å•çº¯å®‰æŠš React è€Œå·², è¿™æ ·ä¿®æ”¹ä¹‹å, å½“ `query` å˜åŒ–çš„æƒ…å†µä¸‹, åº”ç”¨å°±ä¼šé‡æ–°è¯·æ±‚æ•°æ®. **`useEffect` çš„è®¾è®¡å¼ºåˆ¶è¦æ±‚å¼€å‘è€…å…³æ³¨åº”ç”¨ä¸­æ•°æ®æµçš„å˜åŒ–æƒ…å†µ, å¹¶æ®æ­¤é€‰æ‹©æˆ‘ä»¬çš„å‰¯ä½œç”¨å‡½æ•°åº”è¯¥å¦‚ä½•æ ¹æ®å˜åŒ–åšå‡ºå¯¹åº”çš„åŒæ­¥, è€Œä¸æ˜¯å¿½ç•¥æ•°æ®æµçš„å˜åŒ–, ç­‰åˆ°ç”¨æˆ·å‘ç° bug ä¹‹åæ‰å¼€å§‹å…³æ³¨ç›¸å…³çš„é€»è¾‘.**

å¼€å‘è€…åœ¨å¼€å‘è¿‡ç¨‹ä¸­å¯ä»¥ä½¿ç”¨ `eslint-plugin-react-hooks` æ’ä»¶, å¹¶å¼€å¯å¯¹åº”çš„ä»£ç è§„èŒƒæç¤ºè§„åˆ™: `exhaustive-deps`, è¿™ä¸ªæ’ä»¶ä¼š[åˆ†æä»£ç ä¸­çš„å‰¯ä½œç”¨å‡½æ•°](https://github.com/facebook/react/issues/14920), å¦‚æœå‰¯ä½œç”¨å‡½æ•°çš„å®ç°å­˜åœ¨ç¼ºé™·, æ’ä»¶å°±ä¼šæŠ›å‡ºå¯¹åº”çš„æç¤º. ä¹Ÿå°±æ˜¯è¯´, è¿™ä¸ªå·¥å…·ä¼šåœ¨æˆ‘ä»¬çš„ç»„ä»¶æ²¡æœ‰æ­£ç¡®å¤„ç†æ•°æ®æµçš„æƒ…å†µä¸‹ç»™æˆ‘ä»¬æç¤º.

![exhaustive-deps](/posts/images/exhaustive-deps.gif)

### æ— æ³•å°†å‡½æ•°ç§»å…¥å‰¯ä½œç”¨å†…éƒ¨çš„æƒ…å†µ

åœ¨æŸäº›æƒ…å†µä¸‹, æˆ‘ä»¬å¯èƒ½ä¸å¸Œæœ›å°†å‡½æ•°ç§»åŠ¨åˆ°å‰¯ä½œç”¨å‡½æ•°*å†…éƒ¨*. æ¯”å¦‚è¯´, åœ¨å¤šä¸ªå‰¯ä½œç”¨å‡½æ•°ä¸­éƒ½ç”¨åˆ°äº†åŒä¸€ä¸ªæ–¹æ³•, æ­¤æ—¶æˆ‘ä»¬ä¸å¸Œæœ›æ‹·è´ç²˜è´´ä¸€äº›é‡å¤çš„é€»è¾‘. åˆæˆ–è€…, è¿™ä¸ªå‡½æ•°æ˜¯é€šè¿‡ props ä¼ ä¸‹æ¥çš„.

è¿™æ—¶æˆ‘ä»¬è¦åœ¨ä¾èµ–å‚æ•°æ•°ç»„ä¸­å¿½ç•¥è¿™ä¸ªå‡½æ•°å—? å½“ç„¶ä¸. å†é‡ç”³ä¸€æ¬¡, **å‰¯ä½œç”¨å‡½æ•°å¯¹äºä¾èµ–é¡¹çš„å£°æ˜, ä¸€å®šè¦ä¿æŒè¯šå®.** æˆ‘ä»¬æ€»æ˜¯èƒ½å¤Ÿæ‰¾åˆ°æ›´å¥½çš„è§£å†³æ–¹æ¡ˆçš„. ä¸€ä¸ªæ™®éå­˜åœ¨çš„è¯¯è§£æ˜¯: "å‡½æ•°å§‹ç»ˆä¸ä¼šå˜åŒ–". ä½†æ˜¯è¿™ç¯‡æ–‡ç« é˜…è¯»ä¸‹æ¥ä¹‹åæˆ‘ä»¬ä¼šå‘ç°, äº‹å®å¹¶ä¸æ˜¯è¿™æ ·. çœŸå®æƒ…å†µæ˜¯, å®šä¹‰åœ¨ç»„ä»¶å†…éƒ¨çš„å‡½æ•°åœ¨æ¯ä¸€æ¬¡æ¸²æŸ“è¿‡ç¨‹ä¸­éƒ½ä¼šæœ‰å˜åŒ–.

**è¿™ç§ç°è±¡ä¹Ÿæ­ç¤ºäº†ä¸€ä¸ªé—®é¢˜.** å¦‚æœæˆ‘ä»¬ç°åœ¨æœ‰ä¸¤ä¸ªå‰¯ä½œç”¨å‡½æ•°, è°ƒç”¨äº† `getFetchUrl:`

```jsx
function SearchResults() {
  function getFetchUrl(query) {
    return "https://hn.algolia.com/api/v1/search?query=" + query
  }

  useEffect(() => {
    const url = getFetchUrl("react")
    // ... è¯·æ±‚æ•°æ®ç„¶åæ‰§è¡Œä¸€äº›å…¶ä»–æ“ä½œ
  }, []) // ğŸ”´ ç¼ºå°‘äº†ä¾èµ– getFetchUrl

  useEffect(() => {
    const url = getFetchUrl("redux")
    // ... è¯·æ±‚æ•°æ®ç„¶åæ‰§è¡Œä¸€äº›å…¶ä»–æ“ä½œ
  }, []) // ğŸ”´ ç¼ºå°‘äº†ä¾èµ– getFetchUrl

  // ...
}
```

åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­, æˆ‘ä»¬ä¸ä¼šå°† `getFetchUrl` æ–¹æ³•ç§»åŠ¨åˆ°å‰¯ä½œç”¨å‡½æ•°çš„å†…éƒ¨, å› ä¸ºå¦‚æœè¿™æ ·çš„è¯, å‰¯ä½œç”¨å‡½æ•°å°±æ— æ³•å…±äº« `getFetchUrl` æ–¹æ³•.

å¦ä¸€æ–¹é¢, å› ä¸ºæˆ‘ä»¬è¦å¯¹ä¾èµ–é¡¹æ•°ç»„å§‹ç»ˆä¿æŒè¯šå®, å°±ä¼šé‡åˆ°å¦ä¸€ä¸ªé—®é¢˜. ç”±äºæˆ‘ä»¬çš„ä¸¤ä¸ªå‰¯ä½œç”¨å‡½æ•°éƒ½ä¾èµ– `getFetchUrl` (**æ¯ä¸€æ¬¡æ¸²æŸ“éƒ½æœ‰æ‰€å·®å¼‚**), å¦‚æœä¼ é€’äº† `getFetchUrl`, ä¾èµ–é¡¹æ•°ç»„å°±åŸºæœ¬ä¸Šæ²¡ä»€ä¹ˆç”¨äº†: å› ä¸ºæ¯æ¬¡æ¸²æŸ“, å‰¯ä½œç”¨å‡½æ•°éƒ½ä¼šé‡æ–°æ‰§è¡Œ:

```jsx
function SearchResults() {
  // ğŸ”´ æ¯æ¬¡æ¸²æŸ“éƒ½ä¼šé‡æ–°è§¦å‘æ‰€æœ‰å‰¯ä½œç”¨å‡½æ•°çš„æ‰§è¡Œ
  function getFetchUrl(query) {
    return "https://hn.algolia.com/api/v1/search?query=" + query
  }

  useEffect(() => {
    const url = getFetchUrl("react")
    // ... è¯·æ±‚æ•°æ®ç„¶åæ‰§è¡Œä¸€äº›å…¶ä»–æ“ä½œ ...
  }, [getFetchUrl]) // ğŸš§ å‚æ•°ä¾èµ–å‡†ç¡®, ä½†æ˜¯æ”¹å˜å¾—å¤ªé¢‘ç¹äº†

  useEffect(() => {
    const url = getFetchUrl("redux")
    // ... è¯·æ±‚æ•°æ®ç„¶åæ‰§è¡Œä¸€äº›å…¶ä»–æ“ä½œ ...
  }, [getFetchUrl]) // ğŸš§ å‚æ•°ä¾èµ–å‡†ç¡®, ä½†æ˜¯æ”¹å˜å¾—å¤ªé¢‘ç¹äº†

  // ...
}
```

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜, å¯ä»¥è€ƒè™‘åœ¨ä¾èµ–é¡¹æ•°ç»„ä¸­ç›´æ¥çœç•¥ `getFetchUrl`. ä½†è¿™å¹¶ä¸æ˜¯ä¸€ä¸ªå¥½çš„è§£å†³æ–¹æ¡ˆ, å½“æˆ‘ä»¬è¦ä¿®æ”¹ç»„ä»¶ä¸­çš„æ•°æ®æµçš„æ—¶å€™, å¦‚æœå‰¯ä½œç”¨å‡½æ•°æ¶ˆè´¹äº†ç›¸å…³æ•°æ®, å°±ä¼šå¼•èµ·ä¸€äº›å¥‡å¥‡æ€ªæ€ªçš„é—®é¢˜. æ¯”å¦‚æˆ‘ä»¬å…ˆå‰ç¢°åˆ°çš„, é—´éš”(interval)å‡½æ•°ä¸æ›´æ–°çš„ bug.

å…¶å®è¿˜æœ‰å…¶ä»–æ›´ç®€å•çš„è§£å†³æ–¹æ¡ˆ.

**ç¬¬ä¸€ä¸ªæ–¹æ¡ˆæ˜¯, å¦‚æœä¸€ä¸ªå‡½æ•°æ²¡æœ‰æ¶ˆè´¹ç»„ä»¶ä½œç”¨åŸŸå†…çš„å€¼, å¯ä»¥å°†å‡½æ•°ç§»åˆ°ç»„ä»¶å¤–éƒ¨, ç”±äºç§»åˆ°å¤–éƒ¨çš„å‡½æ•°ä¸ä¼šå› ä¸ºæ¸²æŸ“äº§ç”Ÿå˜åŒ–, æˆ‘ä»¬å°±ä¸å¿…åœ¨å‰¯ä½œç”¨å‡½æ•°ä¸­å£°æ˜è¿™ä¸ªå‡½æ•°:**

```jsx
// highlight-start
// âœ… ä¸ä¼šè¢«æ•°æ®æµå½±å“
function getFetchUrl(query) {
  return "https://hn.algolia.com/api/v1/search?query=" + query
}
// highlight-end

function SearchResults() {
  useEffect(() => {
    const url = getFetchUrl("react")
    // ... è¯·æ±‚æ•°æ®ç„¶åæ‰§è¡Œä¸€äº›å…¶ä»–æ“ä½œ ...
  }, []) // âœ… ä¾èµ–å‚æ•°å£°æ˜å‡†ç¡®

  useEffect(() => {
    const url = getFetchUrl("redux")
    // ... è¯·æ±‚æ•°æ®ç„¶åæ‰§è¡Œä¸€äº›å…¶ä»–æ“ä½œ ...
  }, []) // âœ… ä¾èµ–å‚æ•°å£°æ˜å‡†ç¡®

  // ...
}
```

`getFetchUrl` å¹¶ä¸å­˜åœ¨äºæ¸²æŸ“é˜¶æ®µçš„ä½œç”¨åŸŸä¸­, ä¹Ÿä¸ä¼šè¢«ç»„ä»¶æ•°æ®æµçš„å˜åŒ–å½±å“, æˆ‘ä»¬å°±æ²¡æœ‰å¿…è¦åœ¨ä¾èµ–å‚æ•°ä¸­å£°æ˜å®ƒ: è¿™ä¸ªå‡½æ•°ä¸å¯èƒ½å› ä¸º props æˆ–è€… state çš„å˜åŒ–è€Œäº§ç”Ÿå˜åŒ–.

è¿˜æœ‰ä¸€ä¸ªæ–¹æ³•å°±æ˜¯, å°†å‡½æ•°ç”¨ [`useCallback` Hook](https://reactjs.org/docs/hooks-reference.html#usecallback) åŒ…è£¹èµ·æ¥:

```jsx
function SearchResults() {
  // âœ… ç¼“å­˜ getFetchUrl
  const getFetchUrl = useCallback(query => {
    return "https://hn.algolia.com/api/v1/search?query=" + query
  }, []) // âœ… Callback çš„ä¾èµ–å‚æ•°å‡†ç¡®

  useEffect(() => {
    const url = getFetchUrl("react")
    // ... è¯·æ±‚æ•°æ®ç„¶åæ‰§è¡Œä¸€äº›å…¶ä»–æ“ä½œ ...
  }, [getFetchUrl]) // âœ… Effect çš„ä¾èµ–å‚æ•°å‡†ç¡®

  useEffect(() => {
    const url = getFetchUrl("redux")
    // ... è¯·æ±‚æ•°æ®ç„¶åæ‰§è¡Œä¸€äº›å…¶ä»–æ“ä½œ ...
  }, [getFetchUrl]) // âœ… Effect çš„ä¾èµ–å‚æ•°å‡†ç¡®

  // ...
}
```

`useCallback` æ‰€åšçš„äº‹æƒ…, å°±åƒæ˜¯ç»™ä¾èµ–å‚æ•°æ£€æŸ¥åŠ äº†å¦ä¸€å±‚å±éšœ. ä»å¦ä¸€ä¸ªè§’åº¦å…¥æ‰‹è§£å†³äº†æˆ‘ä»¬ç›®å‰éœ€è¦è§£å†³çš„é—®é¢˜ -- **ä¸ä¿®æ”¹ä¾èµ–å‚æ•°çš„å£°æ˜, è€Œæ˜¯é’ˆå¯¹æ‰€ä¾èµ–çš„å€¼æœ¬èº«åšæ–‡ç« , ç¡®ä¿å®ƒåªåœ¨å¿…è¦çš„æ—¶å€™å‘ç”Ÿå˜åŒ–.**

ä¸ºä»€ä¹ˆè¿™æ ·çš„æ–¹å¼æ˜¯æœ‰ç”¨çš„å‘¢. ä¹‹å‰çš„ä¸¤ä¸ªä¾‹å­ä¸­å±•ç¤ºäº†é’ˆå¯¹ `'react'` å’Œ `'redux'` çš„ä¸¤ä¸ªæœç´¢ç»“æœ. å¦‚æœæˆ‘ä»¬ç°åœ¨å¸Œæœ›åŠ å…¥ä¸€ä¸ªè¾“å…¥æ¡†, ä»¥ä¾›ç”¨æˆ·è¾“å…¥ä»»æ„çš„ `query` å‚æ•°æ‰§è¡Œæœç´¢. è¿™æ ·ä¸€æ¥, `getFetchUrl` å°±éœ€è¦ä»ç»„ä»¶å†…éƒ¨çš„ä½œç”¨åŸŸ state ä¸­è¯»å–ä¸€äº›å€¼.

æ­¤æ—¶ä¾èµ–å‚æ•°çš„æ•°ç»„ä¸­, å°±åº”è¯¥åŠ ä¸Š `query`:

```jsx
function SearchResults() {
  const [query, setQuery] = useState("react")
  const getFetchUrl = useCallback(() => {
    // ä¸å­˜åœ¨ query å‚æ•°
    return "https://hn.algolia.com/api/v1/search?query=" + query
  }, []) // ğŸ”´ é—æ¼äº†ä¾èµ–é¡¹: query
  // ...
}
```

å¦‚æœæˆ‘ä¿®æ”¹ `useCallback` ä¾èµ–é¡¹æ•°ç»„, æ·»åŠ  `query`, å½“ `query` å˜åŒ–çš„æ—¶å€™, ä»»ä½•ä½¿ç”¨åˆ° `getFetchUrl` çš„å‰¯ä½œç”¨å‡½æ•°éƒ½ä¼šé‡æ–°æ‰§è¡Œ:

```jsx
function SearchResults() {
  const [query, setQuery] = useState("react")

  // âœ… ç¼“å­˜ getFetchUrl æ–¹æ³•, åªæœ‰ query å˜åŒ–çš„æ—¶å€™ getFetchUrl æ‰ä¼šå˜åŒ–
  const getFetchUrl = useCallback(() => {
    return "https://hn.algolia.com/api/v1/search?query=" + query
    $$
  }, [query]) // âœ… Callback çš„ä¾èµ–å‚æ•°å‡†ç¡®

  useEffect(() => {
    const url = getFetchUrl()
    // ... è¯·æ±‚æ•°æ®ç„¶åæ‰§è¡Œä¸€äº›å…¶ä»–æ“ä½œ ...
  }, [getFetchUrl]) // âœ… å‰¯ä½œç”¨å‡½æ•°çš„ä¾èµ–å‚æ•°å‡†ç¡®

  // ...
}
```

å› ä¸ºä½¿ç”¨äº† `useCallback`, å¦‚æœ `query` å‚æ•°å§‹ç»ˆä¿æŒä¸å˜çš„è¯, `getFetchUrl` ä¹Ÿå°±ä¸ä¼šæœ‰å˜åŒ–, é‚£ä¹ˆå‰¯ä½œç”¨å‡½æ•°ä¹Ÿå°±ä¸ä¼šé‡æ–°æ‰§è¡Œ. å¦‚æœ `query` å˜åŒ–äº†, `getFetchUrl` ä¹Ÿä¼šåŒæ—¶å‘ç”Ÿå˜åŒ–, ç„¶åé‡æ–°è¯·æ±‚æ•°æ®. è¿™å°±å¥½åƒæ˜¯å½“æˆ‘ä»¬ä¿®æ”¹ Excel ä¸­çš„æŸä¸ªå•å…ƒæ ¼ä¹‹å, å…¶ä»–å•å…ƒæ ¼ä¸­çš„æ•°æ®å¦‚æœä¾èµ–è¿™ä¸ªå•å…ƒæ ¼çš„æ•°æ®, å°±ä¼šæ ¹æ®æ–°çš„æ•°æ®é‡æ–°è®¡ç®—å¯¹åº”çš„ç»“æœ.

æ‹¥æŠ±äº†æ•°æ®æµå’ŒåŒæ­¥çš„å¿ƒæ™ºæ¨¡å‹ä¹‹å, å°±è‡ªç„¶ä¼šå¾—åˆ°è¿™æ ·çš„ç»“æœ. **åŒæ ·çš„è§£å†³æ–¹å¼å¯¹äºå‡½æ•°ç»„ä»¶çš„ props ä¹Ÿä¸€æ ·æœ‰æ•ˆ:**

```jsx
function Parent() {
  const [query, setQuery] = useState("react")

  // âœ… ç›´åˆ° query å˜åŒ–çš„æ—¶å€™, fetchData æ‰ä¼šå˜åŒ–
  const fetchData = useCallback(() => {
    const url = "https://hn.algolia.com/api/v1/search?query=" + query
    // ... è¯»å–æ•°æ®ç„¶åè¿”å›ç›¸åº”çš„æ•°æ® ...
  }, [query]) // âœ…  ä¾èµ–é¡¹å‡†ç¡®

  return <Child fetchData={fetchData} />
}

function Child({ fetchData }) {
  let [data, setData] = useState(null)

  useEffect(() => {
    fetchData().then(setData)
  }, [fetchData]) // âœ…  ä¾èµ–é¡¹å‡†ç¡®

  // ...
}
```

ç”±äº `fetchData` å­˜åœ¨äº `Parent` ç»„ä»¶å†…éƒ¨, åŒæ—¶åªæœ‰å½“ `query` å˜åŒ–çš„æ—¶å€™, `fetchData` æ‰ä¼šå˜åŒ–, å› æ­¤æˆ‘ä»¬çš„ `Child` ç»„ä»¶, åªæœ‰åœ¨éœ€è¦çš„æ—¶æœºæ‰ä¼šé‡æ–°è·å–æ•°æ®.

### å‡½æ•°æ˜¯æ•°æ®æµçš„ä¸€éƒ¨åˆ†å—

å¾ˆæœ‰æ„æ€çš„æ˜¯, è¿™ç§æ¨¡å¼åœ¨ç±»å¼ç»„ä»¶ä¸‹å°±å®Œå…¨ä¸é€‚ç”¨äº†, è¿™ä¹Ÿä»å¦ä¸€æ–¹é¢ä½“ç°å‡ºäº†å‰¯ä½œç”¨å‡½æ•°çš„å¿ƒæ™ºæ¨¡å‹å’Œç”Ÿå‘½å‘¨æœŸæ¨¡å¼å­˜åœ¨å·®å¼‚. æŸ¥çœ‹ä¸‹é¢çš„å¯¹åº”ç±»ç»„ä»¶ä»£ç :

```jsx
class Parent extends Component {
  state = {
    query: "react",
  }
  // highlight-start
  fetchData = () => {
    const url = "https://hn.algolia.com/api/v1/search?query=" + this.state.query
    // ... è¯·æ±‚æ•°æ®å¹¶ä¸”æ‰§è¡Œä¸€äº›å…¶ä»–æ“ä½œ ...
  }
  // highlight-end
  render() {
    return <Child fetchData={this.fetchData} />
  }
}

class Child extends Component {
  state = {
    data: null,
  }
  // highlight-start
  componentDidMount() {
    this.props.fetchData()
  }
  // highlight-end
  render() {
    // ...
  }
}
```

ä½ æˆ–è®¸ä¼šæƒ³: "æˆ‘ä»¬éƒ½å·²ç»çŸ¥é“: `useEffect` å°±åƒæ˜¯ `componentDidMount` å’Œ `componentDidUpdate` çš„ç»“åˆä½“, ä¸éœ€è¦æ—¶æ—¶åˆ»åˆ»é‡ç”³è¿™ä¸ªè§‚ç‚¹!" **ä½†æ˜¯å®é™…ä¸Š, è¿™ä¸ªè§‚ç‚¹æ˜¯é”™çš„, `useEffect` æ— æ³•å®Œå…¨æ¨¡æ‹Ÿ `componentDidUpdate` çš„è¡Œä¸º**:

```jsx
class Child extends Component {
  state = {
    data: null,
  }
  componentDidMount() {
    this.props.fetchData()
  }
  componentDidUpdate(prevProps) {
    // highlight-start
    // ğŸ”´ è¿™ç§æƒ…å†µæ°¸è¿œä¸ä¼šå‘ç”Ÿ
    if (this.props.fetchData !== prevProps.fetchData) {
      this.props.fetchData()
    }
  }
    // highlight-end
  render() {
    // ...
  }
}
```

å½“ç„¶äº†, `fetchData` æ˜¯ä¸€ä¸ªç±»æ–¹æ³•!(ä¹Ÿå¯ä»¥è¯´æ˜¯ç±»çš„å±æ€§ -- ä½†æ˜¯è¿™å¹¶ä¸èƒ½æ”¹å˜ä»€ä¹ˆ.) å³ä½¿ state äº§ç”Ÿå˜åŒ–, è¿™ä¸ªç±»æ–¹æ³•ä¹Ÿä¸ä¼šéšä¹‹å˜åŒ–. å› æ­¤ `this.props.fetchData` çš„å€¼å§‹ç»ˆä¸ `prevProps.fetchData` çš„å€¼ä¸€è‡´, å› æ­¤ä»¥ä¸Šä»£ç ä¸­çš„æƒ…å†µæ°¸è¿œä¸ä¼šå‘ç”Ÿ. é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ç›´æ¥ç§»é™¤è¿™ä¸ªæ¡ä»¶åˆ¤æ–­å—? å°†ä»£ç ä¿®æ”¹ä¸ºå¦‚ä¸‹è¿™æ ·:

```jsx
 componentDidUpdate(prevProps) {
    this.props.fetchData();
  }
```

å¹¶ä¸å¯ä»¥, å¦‚æœæˆ‘ä»¬è¿™æ ·ä¿®æ”¹ä»£ç çš„è¯, æ¯ä¸€æ¬¡é‡æ–°æ¸²æŸ“éƒ½ä¼šé‡æ–°è¯·æ±‚æ•°æ®. (åœ¨ç»„ä»¶æ ‘ä¸­æ·»åŠ ä¸€äº›åŠ¨ç”»èƒ½å¤Ÿæ›´ç›´è§‚åœ°è§‚å¯Ÿåˆ°è¿™ä¸ªå˜åŒ–.) é‚£ä¹ˆå¦‚æœå°† `fetchData` ç»‘å®šåˆ°ç‰¹å®šçš„ query ä¸­, ä¼šæ€ä¹ˆæ ·å‘¢?

```jsx
  render() {
    return <Child fetchData={this.fetchData.bind(this, this.state.query)} />;
  }
```

è¿™æ ·ä¿®æ”¹ä¹‹å, å³ä½¿ `query` æ²¡æœ‰å˜åŒ–, `this.props.fetchData !== prevProps.fetchData` çš„å€¼ä¹Ÿå§‹ç»ˆæ˜¯ `true`. å› æ­¤å§‹ç»ˆä¼šé‡æ–°è¯·æ±‚æ•°æ®.

å¯¹äºè¿™ä¸ªé—®é¢˜, å”¯ä¸€çš„è§£å†³æ–¹æ¡ˆæ˜¯å°† `query` å‚æ•°æœ¬èº«ä¼ é€’åˆ° `Child` ç»„ä»¶ä¸­. `Child` ç»„ä»¶å®é™…ä¸Šå¹¶ä¸ä¼šä½¿ç”¨ `query` å‚æ•°, ä½†æ˜¯åœ¨ `query` å˜åŒ–çš„æ—¶å€™,  `Child` ç»„ä»¶éœ€è¦é‡æ–°æ¸²æŸ“ä»¥å‘èµ·æ•°æ®çš„é‡æ–°è¯·æ±‚:

```jsx
class Parent extends Component {
  state = {
    query: "react",
  }
  fetchData = () => {
    const url = "https://hn.algolia.com/api/v1/search?query=" + this.state.query
    // ... è¯·æ±‚æ•°æ®ç„¶åè¿›è¡Œä¸€äº›å…¶ä»–æ“ä½œ...
  }
  render() {
    // highlight-next-line
    return <Child fetchData={this.fetchData} query={this.state.query} />
  }
}

class Child extends Component {
  state = {
    data: null,
  }
  componentDidMount() {
    this.props.fetchData()
  }
  componentDidUpdate(prevProps) {
    // highlight-start
    if (this.props.query !== prevProps.query) {
      this.props.fetchData()
    }
    // highlight-end
  }
  render() {
    // ...
  }
}
```

å¾ˆé•¿ä¸€æ®µæ—¶é—´, æˆ‘ä»¬ä½¿ç”¨çš„éƒ½æ˜¯ React ç±»ç»„ä»¶, æˆ‘å¾ˆä¹ æƒ¯å°†ä¸€äº›ä¸å¿…è¦çš„ props ä¼ é€’åˆ°ç»„ä»¶ä¸­, ä¹ æƒ¯ç ´åçˆ¶ç»„ä»¶çš„å°è£…. ç›´åˆ°ä¸€å‘¨å‰æˆ‘æ‰çŸ¥é“, ä¸ºä»€ä¹ˆæˆ‘ä»¬å¿…é¡»è¦è¿™æ ·åš.

**åœ¨ç±»ç»„ä»¶çš„åœºæ™¯ä¸‹, å‡½æ•°çš„ props æœ¬èº«å¹¶ä¸æ˜¯æ•°æ®æµçš„ä¸€éƒ¨åˆ†.** ç»„ä»¶çš„æ–¹æ³•åŒ…è£¹äº†å¯å˜çš„ `this`, å› æ­¤æˆ‘ä»¬ä¸èƒ½å¤Ÿå¤ªè¿‡ä¾èµ–æ–¹æ³•çš„ç­¾å. æ‰€ä»¥, å³ä½¿æˆ‘ä»¬éœ€è¦çš„åªæ˜¯ä¸€ä¸ªå‡½æ•°, ä¹Ÿå¾—åŒæ—¶ä¼ é€’ä¸€äº›å…¶ä»–æ•°æ®, è¿™æ · React æ‰èƒ½å¤Ÿæ–¹ä¾¿åœ°è¿›è¡Œ "diff" çš„æ“ä½œ. åŒæ—¶, æˆ‘ä»¬æ— æ³•çŸ¥é“ä»çˆ¶ç»„ä»¶ä¸­ä¼ é€’ä¸‹æ¥çš„ `this.props.fetchData` æœ¬èº«æ˜¯å¦ä¾èµ–äºæŸä¸ª state å€¼, è¿™ä¸ª state å€¼æ˜¯å¦å˜åŒ–è¿‡.

**ä½¿ç”¨ `useCallback` ä¹‹å, å‡½æ•°å°±èƒ½å¤Ÿå‚ä¸åˆ°æ•°æ®æµä¸­äº†.** å¦‚æœå‡½æ•°æ¥å—çš„å‚æ•°å˜åŒ–äº†, é‚£ä¹ˆå‡½æ•°æœ¬èº«ä¹Ÿä¼šå˜åŒ–, å¦åˆ™å°±ä¸ä¼šå˜åŒ–. ç”±äº `useCallback` çš„åŠŸèƒ½è¶³å¤Ÿå®Œå–„, å±æ€§çš„å˜åŒ–, å¦‚ `props.fetchData` ä¹Ÿä¼šä¼ é€’ä¸‹å».

ç±»ä¼¼åœ°, [`useMemo`](https://reactjs.org/docs/hooks-reference.html#usememo) ä¹Ÿæä¾›äº†ä¸ `useCallback` ç±»ä¼¼çš„åŠŸèƒ½, ä½¿å¾—æˆ‘ä»¬èƒ½å¤Ÿé’ˆå¯¹å¤æ‚çš„å¯¹è±¡åšå‡ºç±»ä¼¼çš„å¤„ç†:

```jsx
function ColorPicker() {
  // ä¸è¦ç ´å Child ç»„ä»¶é’ˆå¯¹å±æ€§æ£€æŸ¥çš„æµ…æ¯”è¾ƒ
  // é™¤é color çœŸæ­£å˜åŒ–äº†
  const [color, setColor] = useState("pink")
  const style = useMemo(() => ({ color }), [color])
  return <Child style={style} />
}
```

**æˆ‘æƒ³è¦é‡ç‚¹å£°æ˜çš„ä¸€ç‚¹æ˜¯, å¦‚æœå¯¹æ¯ä¸€ä¸ªå‡½æ•°éƒ½ç”¨ `useCallback` åŒ…è£¹, ä»£ç ä¼šæ˜¾å¾—ååˆ†ç¬¨é‡.** æœ‰ä¸€ç§æ–¹å¼å¯ä»¥é¿å…è¿™ç§å½¢å¼çš„ä»£ç , å½“ä¸€ä¸ªå‡½æ•°é€šè¿‡ props ä¼ é€’, å¹¶ä¸”åœ¨å­ç»„ä»¶å†…éƒ¨è¢«è°ƒç”¨çš„æ—¶å€™, è¿™æ ·çš„æ–¹å¼ä¼šå¾ˆæœ‰ç”¨. å½“ä½ å¸Œæœ›é¿å…ç ´åå­ç»„ä»¶çš„ç¼“å­˜çš„æ—¶å€™, è¿™ç§æ–¹å¼ä¹ŸåŒæ ·æœ‰ç”¨. <mark>But Hooks lend themselves better to avoiding passing callbacks down altogether.</mark>

åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­, æˆ‘æ›´åå‘äºå¸Œæœ› `fetchData` åœ¨æˆ‘çš„å‰¯ä½œç”¨å‡½æ•°ä¸­(æŠ½å‡ºä¸€ä¸ªè‡ªå®šä¹‰çš„ Hook)æˆ–è€…åœ¨é¡¶å±‚çš„ `import` ä¸­å£°æ˜. æˆ‘å¸Œæœ›å‰¯ä½œç”¨å‡½æ•°å°½å¯èƒ½ä¿æŒç®€å•, å†…éƒ¨å£°æ˜å¤ªå¤šå›è°ƒå‡½æ•°ä¼šå¢åŠ å‰¯ä½œç”¨å‡½æ•°çš„å¤æ‚æ€§. (â€œWhat if some `props.onComplete` callback changes while the request was in flight?â€) ä½ å¯ä»¥[æ¨¡æ‹Ÿç±»å¼ç»„ä»¶çš„è¡Œä¸º](https://overreacted.io/a-complete-guide-to-useeffect/#swimming-against-the-tide), ä½†æ˜¯è¿™å¹¶æ²¡æœ‰è§£å†³ç«é€Ÿåœºæ™¯çš„é—®é¢˜.
### ç«é€Ÿåœºæ™¯

ä»¥ä¸€ä¸ªå…¸å‹çš„æ•°æ®è¯·æ±‚åœºæ™¯ä½œä¸ºç¤ºä¾‹:

```jsx
class Article extends Component {
  state = {
    article: null,
  }
  componentDidMount() {
    this.fetchData(this.props.id)
  }
  async fetchData(id) {
    const article = await API.fetchArticle(id)
    this.setState({ article })
  }
  // ...
}
```

å¯ä»¥çœ‹å‡ºæ¥, ä»¥ä¸Šçš„ä»£ç å…¶å®æ˜¯æœ‰ bug çš„. å®ƒå¹¶æ²¡æœ‰å¤„ç†æ›´æ–°çš„æƒ…å†µ. ç°åœ¨æˆ‘ä»¬åŠ ä¸Šæ›´æ–°çš„é€»è¾‘:

```jsx
class Article extends Component {
  state = {
    article: null,
  }
  componentDidMount() {
    this.fetchData(this.props.id)
  }
  // highlight-start
  componentDidUpdate(prevProps) {
    if (prevProps.id !== this.props.id) {
      this.fetchData(this.props.id)
    }
  }
  // highlight-end
  async fetchData(id) {
    const article = await API.fetchArticle(id)
    this.setState({ article })
  }
  // ...
}
```

åé¢ä¸€æ®µä»£ç ç¤ºä¾‹åšå‡ºäº†ä¸€äº›ä¼˜åŒ–, ä½†æ˜¯ä¾ç„¶å­˜åœ¨é—®é¢˜: æ•°æ®è¯·æ±‚å¯èƒ½ä¼šå‡ºç°é¡ºåºé”™ä¹±çš„æƒ…å†µ. æ¯”å¦‚è¯´, å½“æˆ‘ç”¨ `{id: 10}` æ‰§è¡Œè¯·æ±‚çš„æ—¶å€™, id å˜æˆäº† 20, åœ¨å®é™…çš„è¯·æ±‚è¿‡ç¨‹ä¸­, æˆ‘ä»¬å¯èƒ½ä¼šå…ˆè·å–åˆ° `{id: 20}` çš„è¯·æ±‚ç»“æœ, è¿™æ ·çš„ç°è±¡å°±ä¼šå¯¼è‡´ state ä¸­å­˜å‚¨çš„ç»“æœå‡ºç°æ··ä¹±.

è¿™æ ·çš„ç°è±¡å«åš: ç«é€Ÿåœºæ™¯(Race Condition), åœ¨å­˜åœ¨ `async` / `await` å’Œæ•°æ®æµè‡ªä¸Šè€Œä¸‹ä¼ é€’çš„ä»£ç ä¸­, ç»å¸¸ä¼šå‘ç”Ÿè¿™ç§æƒ…å†µ(å®ƒå‡è®¾äº†æŸäº›å€¼ä¼šç­‰å¾…å¼‚æ­¥çš„ç»“æœ, ä½†æ˜¯ä»£ç æ‰§è¡Œåˆ°å¼‚æ­¥å‡½æ•°çš„ä¸­é—´æ—¶, props æˆ–è€… state å¯èƒ½ä¼šå‘ç”Ÿå˜åŒ–.)

è™½ç„¶åœ¨ä½ ä¼ é€’ `async` å‡½æ•°åˆ°å‰¯ä½œç”¨å‡½æ•°ä¸­æ—¶, ä¼šæŠ›å‡ºä¸€äº›è­¦å‘Šä¿¡æ¯, ä½†æ˜¯è¿™ä»…ä»…æ˜¯è­¦å‘Š, å‰¯ä½œç”¨å‡½æ•°å¹¶æ²¡æœ‰èƒ½åŠ›è§£å†³è¿™ä¸ªé—®é¢˜. (ä¹‹åæˆ‘ä»¬ä¼šæ”¹è¿›è¿™ä¸ªè­¦å‘Š, ä»¥æŠ«éœ²å‡ºæ›´å¤šæœ‰æ•ˆä¿¡æ¯, å‘Šè¯‰ç”¨æˆ·è¿™æ ·çš„ä½¿ç”¨æ–¹å¼ä¼šé‡åˆ°çš„é—®é¢˜.)

å¦‚æœä½ ä½¿ç”¨çš„å¼‚æ­¥æ–¹æ³•æ”¯æŒè¢«å–æ¶ˆçš„è¯, å¯ä»¥åœ¨æ¸…é™¤å‡½æ•°ä¸­å–æ¶ˆè¿™ä¸ªå¼‚æ­¥æ“ä½œ, æ¥è§£å†³ä»¥ä¸Šçš„é—®é¢˜.

é™¤äº†è¿™ç§æ–¹å¼ä¹‹å¤–, è¿˜æœ‰ä¸€ä¸ªç®€å•çš„æ–¹æ³•: æ·»åŠ ä¸€ä¸ªæ ‡å¿—æ¥è¿½è¸ªè¯·æ±‚æ˜¯å¦è¢«å–æ¶ˆ:

```jsx
function Article({ id }) {
  const [article, setArticle] = useState(null)

  useEffect(() => {
    // highlight-next-line
    let didCancel = false

    async function fetchData() {
      const article = await API.fetchArticle(id)
      // highlight-next-line
      if (!didCancel) {
        setArticle(article)
      }
    }

    fetchData()
    // highlight-start
    return () => {
      didCancel = true
    }
    // highlight-end
  }, [id])

  // ...
}
```

[è¿™ç¯‡æ–‡ç« ](https://www.robinwieruch.de/react-hooks-fetch-data)è¯¦ç»†é˜é‡Šäº†ä½ åº”è¯¥å¦‚ä½•å¤„ç†å¼‚å¸¸æƒ…å†µå’ŒåŠ è½½çš„çŠ¶æ€, ç®€å•æ¦‚æ‹¬å°±æ˜¯å°†è¿™éƒ¨åˆ†é€»è¾‘æå–åˆ°ä¸€ä¸ªè‡ªå®šä¹‰çš„ Hook ä¸­. å¦‚æœæƒ³è¦å­¦ä¹ æ›´å¤šæœ‰å…³äºå¦‚ä½•ä½¿ç”¨ Hook è¯·æ±‚æ•°æ®çš„å†…å®¹çš„è¯, å¯ä»¥é˜…è¯»è¿™ç¯‡æ–‡ç« .

### è¿›ä¸€æ­¥æ·±å…¥

åœ¨ç±»ç»„ä»¶(ç”Ÿå‘½å‘¨æœŸ)çš„å¿ƒæ™ºæ¨¡å‹ä¸‹, å‰¯ä½œç”¨å‡½æ•°çš„è¡Œä¸ºå’Œæ¸²æŸ“çš„ç»“æœæœ‰ä¸€å®šå·®å¼‚. UI çš„æ¸²æŸ“ç”± props å’Œ state çš„å˜åŒ–é©±åŠ¨, å¹¶ä¸”ä¼šç¡®ä¿æ¸²æŸ“ç»“æœä¸ä¸¤è€…çš„å˜åŒ–å§‹ç»ˆä¿æŒä¸€è‡´. ä½†æ˜¯åœ¨å‰¯ä½œç”¨çš„å¿ƒæ™ºæ¨¡å‹ä¸‹, æƒ…å†µå°±ä¸æ˜¯è¿™æ ·äº†. å¯¹ä¸¤è€…çš„æ··æ·†, ä¹Ÿç»å¸¸ä¼šå¼•èµ·ä¸€äº› bug.

åœ¨ `useEffect` çš„å¿ƒæ™ºæ¨¡å‹ä¸‹, é»˜è®¤æƒ…å†µä¸‹æ‰€æœ‰åœºæ™¯éƒ½æ˜¯åŒæ­¥çš„. å‰¯ä½œç”¨å‡½æ•°å˜æˆäº† React æ•°æ®æµçš„ä¸€éƒ¨åˆ†. å¦‚æœå¼€å‘è€…å¯¹äºæ¯ä¸€ä¸ª `useEffect` éƒ½æ­£ç¡®å¤„ç†çš„è¯, ç»„ä»¶ä¹Ÿèƒ½å¤Ÿæ›´å¥½åœ°å¤„ç†æç«¯æƒ…å†µ.

ç„¶è€Œ, å¤„ç†å¥½ `useEffect` çš„æˆæœ¬å¾ˆå¤§ä¹Ÿå¾ˆç¹ç. ç¼–å†™åŒæ­¥çš„ä»£ç , å¤„ç†æç«¯æƒ…å†µ, æ¯”å¤„ç†ä¸€æ¬¡æ€§çš„å‰¯ä½œç”¨(ä¸ä¸¥æ ¼ä¸æ¸²æŸ“çš„ç»“æœä¿æŒä¸€è‡´)éš¾åº¦å¤§ä¸Šå¾ˆå¤š.

å¦‚æœæˆ‘ä»¬åœ¨æ—¥å¸¸å¼€å‘ä¸­ç»å¸¸ç”¨åˆ° `useEffect` çš„è¯, æƒ…å†µå°±ä¼šå˜å¾—å¾ˆç¹ç. å¹¸è¿çš„æ˜¯, `useEffect` æ˜¯ä¸€ä¸ªè¾ƒä¸ºåº•å±‚çš„ API. å› ä¸ºç›®å‰å°šå¤„äº Hooks å‡ºç°çš„æ—©æœŸé˜¶æ®µ, å› æ­¤å¤§å®¶ä¼šæ¯”è¾ƒç»å¸¸ä½¿ç”¨å®ƒ, ç‰¹åˆ«æ˜¯åœ¨æŸäº›æ•™ç¨‹ä¸­. éšç€æ—¶é—´çš„å‘å±•, ç¤¾åŒºä¼šå‡ºç°æ›´å¤šé«˜é˜¶çš„ Hooks API, è¿™æ ·ä¸€æ¥, `useEffect` çš„ä½¿ç”¨åœºæ™¯å°±ä¼šå˜å°‘.

æ®æˆ‘äº†è§£, ç›®å‰å·²ç»æœ‰è®¸å¤šåº”ç”¨, å®ç°äº†ä¸€äº›è‡ªå·±çš„ Hooks, æ¯”å¦‚ `useFetch`, é™¤äº†åŸºæœ¬åŠŸèƒ½ä¹‹å¤–, è¿˜å°è£…äº†ä¸€äº›é‰´æƒé€»è¾‘. æ¯”å¦‚ `useTheme`, åˆ™æ˜¯åˆ©ç”¨ context å®ç°äº†åˆ‡æ¢ä¸»é¢˜çš„åŠŸèƒ½. ä¸€æ—¦æˆ‘ä»¬å°è£…äº†ç±»ä¼¼çš„è‡ªå®šä¹‰ Hooks, ç”¨åˆ° `useEffect` çš„åœºæ™¯, è‡ªç„¶ä¹Ÿå°±å˜å°‘äº†. å°½ç®¡ `useEffect` ä¸Šæ‰‹æ¯”è¾ƒå¤æ‚, ä½†æ˜¯å®ƒçš„èƒ½åŠ›ä¹Ÿä¸ºåŸºäºå®ƒå®ç°çš„ Hooks å¸¦æ¥äº†å¾ˆå¤šä¾¿åˆ©.

æˆªæ­¢ç›®å‰, `useEffect` çš„å¤§éƒ¨åˆ†ä½¿ç”¨åœºæ™¯éƒ½æ˜¯è¯·æ±‚æ•°æ®. ä½†æ˜¯å®é™…ä¸ŠåŒæ­¥çš„ç‰¹æ€§å¯¹æ•°æ®è¯·æ±‚çš„åœºæ™¯å¹¶æ²¡æœ‰ä»€ä¹ˆå¤§å½±å“, ç‰¹åˆ«æ˜¯å¤§éƒ¨åˆ†æ•°æ®è¯·æ±‚çš„åœºæ™¯ä¸‹, æˆ‘ä»¬çš„ä¾èµ–å‚æ•°ç»å¸¸æ˜¯ç©ºæ•°ç»„: `[]`, å°±æ›´ä¸ä¼šæœ‰å¤ªå¤§çš„å½±å“äº†. é‚£ä¹ˆåŒæ­¥çš„ç‰¹æ€§, ä¸»è¦æ˜¯ç”¨äºå½±å“ä»€ä¹ˆçš„å‘¢?

ä»é•¿è¿œè§’åº¦çœ‹, ä¸“é—¨ç”¨ä»¥è¯·æ±‚æ•°æ®çš„ [Suspense ç‰¹æ€§](https://reactjs.org/blog/2018/11/27/react-16-roadmap.html#react-16x-mid-2019-the-one-with-suspense-for-data-fetching) ä½¿å¾—ç¬¬ä¸‰æ–¹åº“èƒ½å¤Ÿç›´æ¥å‘Šè¯‰ React å»¶è¿Ÿæ¸²æŸ“çš„æµç¨‹, ç›´åˆ°æŸäº›å¼‚æ­¥çš„æµç¨‹ç»“æŸå†å¼€å§‹æ¸²æŸ“.

éšç€ Suspense é€æ¸è¦†ç›–è¶Šæ¥è¶Šå¤šçš„æ•°æ®è¯·æ±‚åœºæ™¯, æˆ‘çŒœæµ‹ `useEffect` ä¼šé€æ¸ç”¨äºå…¶ä»–éœ€è¦åŒæ­¥ props å’Œ state è‡³å‰¯ä½œç”¨å‡½æ•°ä¸­çš„åœºæ™¯. `useEffect` çš„è®¾è®¡åˆè¡·, ä¹Ÿæ˜¯å¤„ç†è¿™æ ·çš„åœºæ™¯, è€Œå¹¶éæ•°æ®è¯·æ±‚. åˆ°é‚£æ—¶å€™, ç±»ä¼¼[è¿™ç¯‡æ–‡ç« ](https://www.robinwieruch.de/react-hooks-fetch-data)ä¸­çš„è‡ªå®šä¹‰ Hooks, å°±ä¼šæ›´å¤šåœ°è¢«ç”¨äºæ•°æ®è¯·æ±‚.

### æ€»ç»“

æˆ‘å·²ç»å‘å¤§å®¶ä»‹ç»äº†æˆ‘æ‰€äº†è§£çš„å…³äº `useEffect` çš„çŸ¥è¯†ç‚¹å’Œä½¿ç”¨åœºæ™¯. ç°åœ¨å¯ä»¥å†å›çœ‹æ–‡ç« æœ€å¼€å§‹çš„[å¤ªé•¿ä¸çœ‹](https://overreacted.io/a-complete-guide-to-useeffect/#tldr)éƒ¨åˆ†çš„å†…å®¹. æ˜¯å¦å¯¹å®ƒä»¬æœ‰æ›´æ·±å…¥çš„ç†è§£äº†å‘¢?
