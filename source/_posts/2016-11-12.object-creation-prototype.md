---
title:  "åˆ›å»ºå¯¹è±¡ä¸åŸå‹ç»§æ‰¿"
date:   2016-11-12
permalink: object-creation-prototype
---

ç»§æ‰¿æŒ‡ä½¿æŸä¸ªå¯¹è±¡ **å…³è”** å¦ä¸€ä¸ªå¯¹è±¡çš„å±æ€§å’Œæ–¹æ³•. å¤§å¤šæ•°ç¼–ç¨‹è¯­è¨€ä¸­è¿ç”¨çš„ç»§æ‰¿ç±»å‹ä¸ºåŸºäºç±»çš„ç»§æ‰¿(Classical Inheritance), è€ŒJavaScriptä¸­çš„ç»§æ‰¿ç±»å‹ä¸ºåŸºäºåŸå‹çš„ç»§æ‰¿(Prototypal Inheritance).

<!-- more -->

## åŸå‹

å‡è®¾ç°åœ¨æœ‰ä¸€ä¸ªå¯¹è±¡obj, objæœ‰prop1å±æ€§, å¯ä»¥é€šè¿‡`.`æ“ä½œç¬¦è·å–è¿™ä¸ªå±æ€§å€¼: `obj.prop1`. åœ¨JavaScriptä¸­, æ‰€æœ‰å¯¹è±¡(åŒ…æ‹¬å‡½æ•°)éƒ½æœ‰ä¸€ä¸ªéšè—çš„å±æ€§(æ— æ³•ç›´æ¥è·å–çš„å±æ€§):åŸå‹å±æ€§.

åŸå‹å±æ€§çš„ä½œç”¨æ˜¯å…³è”åˆ°å¦ä¸€ä¸ªå¯¹è±¡`proto`(The property is simply a reference to another object `proto`). `proto`è¿˜èƒ½å…³è”å¦ä¸€ä¸ª`proto`. å½¢æˆäº†ä¸€ä¸ªåŸå‹é“¾(Prototype Chain)

![prototype-chain](/posts/images/prototype.jpg)

å¦‚ä¸Šå›¾æ‰€ç¤º, æˆ‘ä»¬æƒ³é€šè¿‡`obj.prop2`è·å–`prop2`çš„å€¼, ä½†`obj`æœ¬èº«å¹¶æ²¡æœ‰è¿™ä¸ªå±æ€§, é‚£ä¹ˆå°±ä¼šé€šè¿‡åŸå‹é“¾å¯»æ‰¾`proto`ä¸­æ˜¯å¦æœ‰éœ€è¦çš„å±æ€§.

å¦‚æœæœ‰å¦ä¸€ä¸ªå¯¹è±¡`obj2`, `obj2`å¯ä»¥ä¸`obj1`å…±äº«åŒä¸€ä¸ªåŸå‹å¯¹è±¡, ç”šè‡³åŒä¸€æ¡åŸå‹é“¾, å¦‚ä¸‹å›¾, å¦‚æœè°ƒç”¨`obj2.prop2`, è¿”å›çš„æ˜¯ä¸`obj1.prop2`åŒæ ·çš„å±æ€§å€¼, æŒ‡å‘çš„æ˜¯å†…å­˜ç©ºé—´çš„åŒä¸€ä½ç½®.

![prototype-prop](/posts/images/prototype-prop.jpg)

å¯ä»¥é€šè¿‡`__proto__`ä¸ºå¯¹è±¡è®¾ç½®åŸå‹å¯¹è±¡, ä½†åœ¨ **å®é™…åº”ç”¨ä¸­ä¸åº”è¯¥è¿™æ ·åš**,å¯¹æ€§èƒ½ä¸åˆ©.

```js
var person = {
  firstname : 'Default',
  lastname : 'Default',
  getFullName: function(){
    return this.firstname + ' ' + this.lastname;
  }
}

var john = {
  firstname: 'John',
  lastname: 'Doe'
}

// don't do this EVER! for demo purpose only!!!
john.__proto__ = person;
console.log(john.getFullName()); // John Doe

var jane = {
  firstname: 'Jane'
}

// share the same proto object
jane.__proto__ = person;
console.log(jane.getFullName()); // Jane Default
```

## ä¸€åˆ‡çš†å¯¹è±¡

åœ¨JavaScriptä¸­, ä¸€åˆ‡çš†å¯¹è±¡(æˆ–åŸå§‹ç±»å‹) Everything is an object(or a primitive). å®ƒä»¬éƒ½æœ‰åŸå‹å¯¹è±¡, é™¤äº†base object(å¯¹è±¡çš„åŸå‹å¯¹è±¡), ä¸‹ä¾‹ä¸­çš„`a.__proto__`.

```js
var a = {};
var b = function(){};
var c = [];

console.log(a.__proto__); // Object {}
console.log(a.__proto__.__proto__); // null
console.log(b.__proto__); // function () {}
console.log(b.__proto__.__proto__); // Object {}
console.log(c.__proto__); // [Symbol(Symbol.unscopables): Object]
console.log(c.__proto__.__proto__); // Object {}
```


## å¯¹è±¡çš„å†…çœ

Reflection: An object can look at itself, listing
and changing its properties and methods.

> **Reflection:** åœ¨ä¼ ç»Ÿçš„é¢å‘ç±»ç¯å¢ƒä¸­ï¼Œæ£€æŸ¥ä¸€ä¸ªå®ä¾‹ï¼ˆJavaScriptä¸­çš„å¯¹è±¡ï¼‰çš„ç»§æ‰¿ç¥–å…ˆï¼ˆJavaScriptä¸­çš„å§”æ‰˜å…³è”ï¼‰é€šå¸¸è¢«ç§°ä¸ºå†…çœï¼ˆæˆ–è€…åå°„ï¼‰ã€‚            -- [You Don't Know JS](https://github.com/getify/You-Dont-Know-JS/blob/31e1d4ff600d88cc2ce243903ab8a3a9d15cce15/this%20%26%20object%20prototypes/ch5.md#inspecting-class-relationships)


**for-in:** ä»¥ä»»æ„é¡ºåºè¿­ä»£å¯¹è±¡ä¸­çš„[å¯æšä¸¾å±æ€§](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Enumerability_and_ownership_of_properties).

`for-in`ä¸æ•°ç»„:

```js
Array.prototype.myCustomFeature = "cool";

var arr = ['John', 'Jane', 'Jim'];

for(var prop in arr){
  console.log(prop + ': ' + arr[prop]);
}
```

ä»ä¸Šè¿°ä»£ç çœ‹å‡º, æ•°ç»„çš„ç´¢å¼•å®é™…ä¸Šæ˜¯å±æ€§å, ä½†åœ¨åŸå‹å¯¹è±¡ä¸­åŠ å…¥è‡ªå·±å®šä¹‰çš„å±æ€§ä¹‹å, ç”¨`for-in`ä¹Ÿè¿­ä»£å‡ºäº†è¯¥å±æ€§, å› æ­¤ä¸è¦åœ¨æ•°ç»„ä¸­ä½¿ç”¨`for-in`, åº”è¯¥ç”¨ä¸€èˆ¬çš„forå¾ªç¯æˆ–`forEach`.

**hasOwnProperty:** ç”¨è¿™ä¸ªæ–¹æ³•åˆ¤æ–­å±æ€§æ˜¯å¦åªå­˜åœ¨äºå¯¹è±¡æœ¬èº«, è€Œä¸æ˜¯åœ¨åŸå‹é“¾çš„åŸå‹å¯¹è±¡ä¸­.

```js
var person = {
  firstname: 'Default',
  lastname: 'Default',
  getFullName: function(){
    return this.firstname + ' ' + this.lastname;
  }
}

var john = {
  firstname: 'John',
  lastname: 'Doe'
}

john.__proto__ = person;
john.getFullName(); // "John Doe"

for (var prop in john){
  console.log(prop + ': ' + john[prop]);
}

// firstname: John
// lastname: Doe
// getFullName: function(){
//   return this.firstname + ' ' + this.lastname;
// }

for (var prop in john){
  if(john.hasOwnProperty(prop)){ //è¿ç”¨`hasOwnProperty`æ–¹æ³•è·å–åªå­˜åœ¨äºå¯¹è±¡å†…çš„å±æ€§
    console.log(prop + ': ' + john[prop]);
  }
}
// firstname: John
// lastname: Doe
```


Underscoreåº“ä¸­çš„`extend`æ–¹æ³•(è¿ç”¨äº†å¯¹è±¡çš„å†…çœ), è§ä¸‹ä¾‹ğŸ‘‡, æ‰§è¡Œ`_.extend(john, jane, jim);`ä¹‹å, johnå°±æœ‰äº†janeå’Œjimçš„å±æ€§, é™¤äº†`exdend`æ–¹æ³•, è¿˜æœ‰`extendOwn`æ–¹æ³•:


```js
var person = {
  firstname: 'Default',
  lastname: 'Default',
  getFullName: function(){
    return this.firstname + ' ' + this.lastname;
  }
}

var john = {
  firstname: 'John',
  lastname: 'Doe'
}

var jane = {
  address: '111 Main St.',
  getFormalFullName: function(){
    return this.lastname + ', ' + this.firstname;
  }
}

jane.__proto__ = person;

var jim = {
  getFirstName: function(){
    return firstname;
  }
}

_.extend(john, jane, jim);
// _.extendOwn(john, jane, jim);

for (var prop in john){
   console.log(prop + ': ' + john[prop]);
}
```

```js
// extend
firstname: Default
lastname: Default
address: 111 Main St.
getFormalFullName: function (){
  return this.lastname + ', ' + this.firstname;
}
getFullName: function (){
  return this.firstname + ' ' + this.lastname;
}
getFirstName: function (){
  return firstname;
}
// extendOwn
firstname: John
lastname: Doe
address: 111 Main St.
getFormalFullName: function (){
  return this.lastname + ', ' + this.firstname;
}
getFirstName: function (){
  return firstname;
}
```
`extend`æ–¹æ³•ä¸­é¦–ä¸ªå‚æ•°å¯¹è±¡æ¥å—å…¶åå‚æ•°å¯¹è±¡çš„å±æ€§, åŒ…æ‹¬åé¢çš„å¯¹è±¡çš„åŸå‹å±æ€§, è€Œä¸”å¦‚æœæœ‰ç›¸åŒå±æ€§, åé¢å¯¹è±¡çš„å±æ€§ä¼šè¦†ç›–ç¬¬ä¸€ä¸ªå‚æ•°å¯¹è±¡å±æ€§.

`extendOwn`ä¸`extend`ç›¸ä¼¼, ä½†ä¸åŒ…æ‹¬åé¢å¯¹è±¡çš„åŸå‹å±æ€§.


```js
// An internal function for creating assigner functions.
var createAssigner = function(keysFunc, undefinedOnly) {
  return function(obj) {
    var length = arguments.length;
    if (length < 2 || obj == null) return obj;
    for (var index = 1; index < length; index++) {
      var source = arguments[index],
          keys = keysFunc(source),
          l = keys.length;
      for (var i = 0; i < l; i++) {
        var key = keys[i];
        if (!undefinedOnly || obj[key] === void 0) obj[key] = source[key];
      }
    }
    return obj;
  };
};

// Extend a given object with all the properties in passed-in object(s).
_.extend = createAssigner(_.allKeys);

// Assigns a given object with all the own properties in the passed-in object(s)
_.extendOwn = _.assign = createAssigner(_.keys);
```

## åˆ›å»ºå¯¹è±¡

### æ„é€ å™¨å‡½æ•°ä¸newæ“ä½œç¬¦


```js
function Person(){
  this.firstname = 'John';
  this.lastname = 'Doe';
}
var john = new Person();
console.log(john)
```

1. `new` åˆ›å»ºä¸€ä¸ªç©ºå¯¹è±¡
1. è°ƒç”¨`Person`å‡½æ•°, æ–°çš„æ‰§è¡Œç¯å¢ƒè¢«åˆ›å»º
1. å°† `this` æŒ‡å‘æ‰€åˆ›å»ºçš„ç©ºå¯¹è±¡
1. `Person`å†…å®šä¹‰çš„firstnameå’Œlastnameæˆä¸ºæ–°åˆ›å»ºå¯¹è±¡çš„å±æ€§
1. å¦‚æœåœ¨æ„é€ å™¨å‡½æ•°ä¸­æ²¡æœ‰å£°æ˜è¿”å›çš„å€¼, è¿”å›çš„å°±æ˜¯æ–°åˆ›å»ºçš„å¯¹è±¡

```js
function Person(firstname, lastname){
  this.firstname = firstname;
  this.lastname = lastname;
}
var john = new Person('John', 'Doe');
console.log(john);

var jane = new Person('Jane', 'Doe');
console.log(jane);
```

åˆ©ç”¨æ„é€ å™¨å‡½æ•°(Function Constructor)å’Œ`new`åˆ›å»ºå¯¹è±¡æ—¶, ä¼šç»™åˆ›å»ºå‡ºçš„å¯¹è±¡è‡ªåŠ¨å…³è”ä¸€ä¸ªåŸå‹å¯¹è±¡, ä¸Šè¿°å¯¹è±¡çš„åŸå‹å¯¹è±¡æ˜¯constructorä¸ºğŸ‘‡çš„`Object{}`:
```js
function Person(){
  this.firstname = 'John';
  this.lastname = 'Doe';
}
```

### `__proto__`ä¸`prototype`


```js
function Person(firstname,lastname){
  this.firstname = firstname;
  this.lastname = lastname;
}

var john = new Person('John','Doe');
var jane = new Person('Jane','Doe');

console.log(john.__proto__ === Person.prototype); // true

// å› ä¸ºä¸Šè¿°å£°æ˜æˆç«‹, æ‰€ä»¥å¯ä»¥é€šè¿‡ä¸‹é¢ğŸ‘‡çš„æ–¹æ³•ç»™johnçš„åŸå‹å¯¹è±¡å®šä¹‰å±æ€§

Person.prototype.greet = function(){
  console.log('Hello, '+ this.firstname + ' ' + this.lastname);
};


john.greet();

console.log(john.__proto__);
```

ä¸€èˆ¬åˆ©ç”¨`.prototype`ç»™å¯¹è±¡å®šä¹‰æ–¹æ³•, åœ¨æ„é€ å™¨å‡½æ•°ä¸­å®šä¹‰å±æ€§, å…¶å®ä¹Ÿå¯ä»¥ç›´æ¥åœ¨æ„é€ å™¨å‡½æ•°ä¸­å®šä¹‰æ–¹æ³•, ä½†å› ä¸ºåœ¨JavaScriptä¸­, å‡½æ•°æ˜¯å¯¹è±¡, ä¼šå ç”¨å†…å­˜ç©ºé—´, è§ä¸Šä¾‹, å¦‚æœåœ¨æ„é€ å™¨å†…å®šä¹‰`greet`æ–¹æ³•, é‚£ä¹ˆç”±è¿™ä¸ªæ„é€ å™¨æ‰€åˆ›å»ºå‡ºçš„æ¯ä¸ªå¯¹è±¡ä¸­éƒ½å«æœ‰`greet`æ–¹æ³•çš„æ‹·è´, è¿™æ ·å°±å ç”¨æ›´å¤šçš„å†…å­˜ç©ºé—´. è€Œå¦‚æœåœ¨`.prototype`å†…å®šä¹‰æ–¹æ³•, ä¸ç®¡åˆ›å»ºå‡ºå¤šå°‘ä¸ªå¯¹è±¡, è¿™ä¸ªæ–¹æ³•åœ¨å†…å­˜ç©ºé—´åªå­˜åœ¨ä¸€æ¬¡.

### å†…ç½®æ„é€ å™¨å‡½æ•°

```js
var a = new Number(3);
console.log(a); // Number {[[PrimitiveValue]]: 3}

var b = new String('john');
console.log(b);
// String {0: "j", 1: "o", 2: "h", 3: "n", length: 4, [[PrimitiveValue]]: "john"}
```

åˆ©ç”¨å†…ç½®æ„é€ å™¨å‡½æ•°åˆ›å»ºå‡ºçš„å˜é‡a, bæ˜¯å½¢å¼ä¸ºåŸå§‹ç±»å‹çš„å¯¹è±¡, ä¸åŒçš„ç±»å‹æœ‰ä¸åŒçš„å†…ç½®å±æ€§å’Œæ–¹æ³•, ä¹Ÿå¯ä»¥è‡ªå·±å®šä¹‰å±æ€§å’Œæ–¹æ³•:

```js
String.prototype.isLengthGreaterThan = function(limit){
  return this.length > limit;
};

console.log('John'.isLengthGreaterThan(3)); // true

// JavaScriptä¼šè‡ªåŠ¨å°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºå¯¹è±¡, å› æ­¤ä¸Šè¿°å£°æ˜æˆç«‹, ä½†ä¸ä¼šè‡ªåŠ¨è½¬æ¢æ•°å­—
Number.prototype.isPositive = function(){
  return this > 0;
};

// console.log(3.isPositive()); // SyntaxError

// é™¤éå¿…è¦, å¦åˆ™ä¸è¦ç”¨æ„é€ å™¨å‡½æ•°åˆ›å»ºåŸå§‹ç±»å‹

var a = Number(3);
console.log(a.isPositive()); // true

var b = 3;

console.log(a == b); // false
console.log(a === b); // true
```

### Object.createä¸åŸå‹ç»§æ‰¿

ç”¨æ„é€ å™¨å‡½æ•°æ‰€å®ç°çš„ç»§æ‰¿æ˜¯æ¨¡ä»¿å…¶ä»–è¯­è¨€ä¸­çš„ç±»å¼ç»§æ‰¿, è€Œç”¨`Object.create`å®ç°çš„æ˜¯çœŸæ­£çš„åŸå‹ç»§æ‰¿.

```js
var person = {
  firstname: 'Default',
  lastname: 'Default',
  greet: function(){
    return 'Hi ' + this.firstname + ' ' + this.lastname;
  }
}

var john = Object.create(person);

console.log(john); // Object {}

john.firstname = 'John';
john.lastname = 'Doe';

console.log(john); // Object {firstname: "John", lastname: "Doe"}
```

**polyfill:** å¯¹äºä¸æ”¯æŒæŸäº›ç‰¹æ€§çš„æµè§ˆå™¨, ä½¿ç”¨polyfillæ¥å®ç°åŒæ ·çš„åŠŸèƒ½. (Code that adds a feature which the engine may lack.)

`Object.create`çš„polyfillç®€åŒ–ç‰ˆ:

```js
if(!Object.create){
  Object.create = function (o){
    if(arguments.length > 1){
      throw new Error('Object.create implementation only accepts the firstparameter');
    }
    function F() {};
    F.prototype = o;
    return new F();
  };
}
```


---
**å‚è€ƒ**

- [JavaScript: Understanding the Weird Parts](https://www.udemy.com/understand-javascript/)
