<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="google-site-verification" content="IDYUPnBNhdnU8o9LRNKZ1RSt14tIxTI0rLeMrBtswXw"><title> 闭包 · Fish</title><meta name="description" content="闭包 - Fish"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/posts/favicon.png"><link rel="stylesheet" href="/posts/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://icyfish.github.io/posts/atom.xml" title="Fish"><meta name="generator" content="Hexo 7.0.0-rc1"></head><body><div class="wrap"><header><a href="/posts/" class="logo-link"><img src="/posts/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/posts/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/posts/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/posts/about/" target="_self" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="http://twitter.com/icyfish_" target="_blank" class="nav-list-link">TWITTER</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">闭包</h1><div class="post-info">Nov 15, 2016</div><div class="post-content"><p>闭包的概念以及相关应用.</p>
<a id="more"></a>
<h2 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">greet</span>(<span class="params">whattosay</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">name</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(whattosay + <span class="string">' '</span> + name);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// greet('Hi')('Joe');</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> sayHi = greet(<span class="string">'Hi'</span>);</span><br><span class="line">sayHi(<span class="string">'Joe'</span>);</span><br></pre></td></tr></table></figure>
<p>调用<code>sayHi</code>函数时,<code>greet</code>函数已执行完成,跳出执行栈(execution stack),但<code>greet</code>函数内定义的<code>whattosay</code>变量的值依然能被<code>sayHi</code>函数获取, 这样的情况可能发生是因为 JavaScript中存在 <strong>闭包</strong>.</p>
<p>代码开始执行时创建了一个全局执行环境, 当执行到<code>var sayHi = greet(&#39;Hi&#39;)</code>时, 调用<code>greet()</code>函数, 新的执行环境被创建, 传给greet函数的<code>whattosay</code>变量处于<code>greet()</code>执行环境中, 一边执行一边创建了所返回的函数, 函数返回之后, <code>greet()</code>函数跳出执行栈,这个执行环境不再存在, 但存储变量的内存空间以及变量依然存在.  </p>
<p>当调用<code>sayHi()</code>时,又创建了一个新的执行环境, 但这个执行环境中没有<code>whattosay</code>变量,于是JavaScript引擎通过作用域链在<code>sayHi</code>函数外部寻找该变量.</p>
<p><img src="/posts/images/closure1.jpg" alt="closure1"><br><img src="/posts/images/closure2.jpg" alt="closure2"><br><img src="/posts/images/closure3.jpg" alt="closure3"></p>
<p>闭包定义: The phenomenon of closing in all the variables that it is supposed to have access to is called a closure.</p>
<p><img src="/posts/images/closure-def.jpg" alt="closure-def"></p>
<p>闭包是JavaScript语言本身的特性.</p>
<h2 id="应用"><a href="#应用" class="headerlink" title="应用"></a>应用</h2><h3 id="闭包与for循环"><a href="#闭包与for循环" class="headerlink" title="闭包与for循环"></a>闭包与for循环</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">buildFunctions</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="keyword">var</span> arr = [];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++)&#123;</span><br><span class="line">    arr.push(</span><br><span class="line">      <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(i);</span><br><span class="line">      &#125;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> arr;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> fs = buildFunctions(); <span class="comment">// &#123;1&#125;</span></span><br><span class="line"></span><br><span class="line">fs[<span class="number">0</span>](); <span class="comment">// 3</span></span><br><span class="line">fs[<span class="number">1</span>](); <span class="comment">// 3</span></span><br><span class="line">fs[<span class="number">2</span>](); <span class="comment">// 3</span></span><br></pre></td></tr></table></figure>
<p>代码执行到行{1}时, <code>buildFunctions</code>被调用, 执行环境被创建, 执行之后赋值给fs, fs是个数组, 其中包含3个元素的均为函数<code>function(){ console.log(i) }</code>. 当调用数组中的函数时, 由于闭包, i值从函数定义时的外部获取, 即在<code>buildFunctions</code>中, 因为循环到i=3时结束, 所以i=3被保存于内存空间, 因此三次调用数组内函数的结果均为输出3.</p>
<p><img src="/posts/images/closure-loop1.jpg" alt="closure-loop1"></p>
<p><img src="/posts/images/closure-loop2.jpg" alt="closure-loop2"></p>
<p>如何让函数输出预期的结果:</p>
<p><strong>1. ES6的解决方式</strong></p>
<p>for循环执行时,因为let关键字创建了块级作用域,i在每次循环中都是内存中的一个新变量.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">buildFunctions2</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="keyword">var</span> arr = [];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>;i++)&#123;</span><br><span class="line">    arr.push(</span><br><span class="line">      <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(i);</span><br><span class="line">      &#125;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> arr;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> fs2 = buildFunctions2();</span><br><span class="line"></span><br><span class="line">fs2[<span class="number">0</span>](); <span class="comment">// 0</span></span><br><span class="line">fs2[<span class="number">1</span>](); <span class="comment">// 1</span></span><br><span class="line">fs2[<span class="number">2</span>](); <span class="comment">// 2</span></span><br></pre></td></tr></table></figure>
<p><strong>2. ES5的解决方式</strong></p>
<p>运用IIFE使函数在创建的时候执行, 这样每次执行都会创建新的执行环境, 于是每个被push到数组中的函数执行时都处于不同的执行环境, 因此数组中的函数每次执行时都会输出预期的不同值, j值从所创建的闭包中获取, 而不是再外一层的循环中.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">buildFunctions2</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="keyword">var</span> arr = [];</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>;i++)&#123;</span><br><span class="line">    arr.push(</span><br><span class="line">      (<span class="function"><span class="keyword">function</span>(<span class="params">j</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">          <span class="built_in">console</span>.log(j);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;(i))</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> arr;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> fs2 = buildFunctions2();</span><br><span class="line"></span><br><span class="line">fs2[<span class="number">0</span>](); <span class="comment">// 0</span></span><br><span class="line">fs2[<span class="number">1</span>](); <span class="comment">// 1</span></span><br><span class="line">fs2[<span class="number">2</span>](); <span class="comment">// 2</span></span><br></pre></td></tr></table></figure>
<h3 id="利用闭包创造工厂函数"><a href="#利用闭包创造工厂函数" class="headerlink" title="利用闭包创造工厂函数"></a>利用闭包创造工厂函数</h3><p><strong>工厂函数 Function Factories</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">makeGreeting</span>(<span class="params">language</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">firstname,lastname</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (language === <span class="string">'en'</span>)&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'Hello '</span> +　firstname + <span class="string">' '</span> + lastname);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (language === <span class="string">'es'</span>)&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'Hola '</span> +　firstname + <span class="string">' '</span> + lastname);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> greetEnglish = makeGreeting(<span class="string">'en'</span>);</span><br><span class="line"><span class="keyword">var</span> greetSpanish = makeGreeting(<span class="string">'es'</span>);</span><br><span class="line"></span><br><span class="line">greetEnglish(<span class="string">'John'</span>,<span class="string">'Doe'</span>);</span><br><span class="line">greetSpanish(<span class="string">'Jane'</span>,<span class="string">'Doe'</span>)</span><br></pre></td></tr></table></figure>
<p>传入外层函数, 在内层函数返回, 尽管在内层函数执行时makeGreeting函数已经跳出执行栈, 但language变量依然存在于内存空间. 调用不同的language, 创造的是不同的执行环境, 因此变量存在于不同的内存空间.</p>
<p><img src="/posts/images/closure-factory.jpg" alt="closure-factory"></p>
<h3 id="闭包与回调函数"><a href="#闭包与回调函数" class="headerlink" title="闭包与回调函数"></a>闭包与回调函数</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sayHiLater</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="keyword">var</span> greeting = <span class="string">'Hi'</span>;</span><br><span class="line"></span><br><span class="line">  setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(greeting);</span><br><span class="line">  &#125;,<span class="number">3000</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sayHiLater();</span><br></pre></td></tr></table></figure>
<p>在JavaScript中, 函数是一等公民并且可以即时创建函数表达式 所以可以将函数<code>function(){ console.log(greeting); }</code>作为参数传入<code>setTimeout</code>函数, 又因为闭包, <code>greeting</code>的值从<code>sayHiLater</code>执行时保存在内存空间的<code>greeting</code>变量中获取. 因此上述代码成立. 这里的函数<code>function(){ console.log(greeting); }</code>是回调函数.</p>
</div></article></div></main><footer><div class="paginator"><a href="/posts/2016/11/20/event-emitter/" class="prev">PREV</a><a href="/posts/2016/11/12/object-creation-prototype/" class="next">NEXT</a></div><div class="copyright"><p>© 2019 - 2023 <a href="https://icyfish.github.io/posts">Fish</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>