<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="google-site-verification" content="IDYUPnBNhdnU8o9LRNKZ1RSt14tIxTI0rLeMrBtswXw"><title> 实现一个事件委托 hook · Fish</title><meta name="description" content="实现一个事件委托 hook - Fish"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/posts/favicon.png"><link rel="stylesheet" href="/posts/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://icyfish.github.io/posts/atom.xml" title="Fish"><meta name="generator" content="Hexo 7.0.0-rc1"></head><body><div class="wrap"><header><a href="/posts/" class="logo-link"><img src="/posts/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/posts/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/posts/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/posts/about/" target="_self" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="http://twitter.com/icyfish_" target="_blank" class="nav-list-link">TWITTER</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">实现一个事件委托 hook</h1><div class="post-info">Apr 19, 2021</div><div class="post-content"><h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>我们的业务场景是一个页面搭建平台, 平台中存在许多固定模板用以搭建页面. 其中有一个比较特殊的模板叫做自定义代码模板, 通过这个模板, 用户能够在后台录入一些 html 以供前端页面读取, 并渲染对应的内容. 关于这个模板的主要功能逻辑, 在这篇文章中已经做出了介绍: <a href="http://icyfish.github.io/blog/posts/ssr-render-html-string/">在 React 组件中渲染接口下发的 html</a></p>
<p>对于这个模板的功能, 我们还需要做出一些优化. 在正常情况下, 运营编写自定义代码的最主要诉求为以下两类:</p>
<ol>
<li>添加花哨的页面动效, 以营造营销活动的氛围(这部分主要依赖外部 JavaScript 的引入, 在主要功能介绍的文章中, 我们针对这个诉求已经做出了一些特殊的处理 .</li>
<li>第二点则是针对自定义代码中的某些元素添加点击事件, 跳转到二级页面, 以达到引流的目的.</li>
</ol>
<p>但是由于我们的页面需要适应不同的平台, H5, App, 微信小程序等, 因此点击方法的实现也需要根据平台有所差异, 用户不可能也没有必要去实现这些差异化的处理. 针对这部分内容, 我们也在程序中实现了特殊的处理. </p>
<p>首先我们和用户约定, 在需要添加点击事件的 DOM 元素中, 用户要给这个元素添加一个特殊的类名, 我们约定为 <code>.moreLink</code> , 同时在这个 DOM 元素上还需要添加点击的目标 URL. URL 是区分平台的, 因此约定了三个属性: <code>data-url</code> , <code>data-appurl</code> , <code>data-miniprogramurl</code> .</p>
<p>这样的话, 我们接受到的自定义 html 字符串就可能是如下这样的:</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> codeBlock = <span class="string">`</span></span><br><span class="line"><span class="string">&lt;div data-url="https://m.ctrip.com" class="moreLink"&gt;&lt;h1&gt;outer&lt;/h1&gt;&lt;/div&gt;</span></span><br><span class="line"><span class="string">&lt;div&gt;&lt;h1 data-url="https://m.ctrip.com" class="moreLink"&gt;inner&lt;/h1&gt;&lt;/div&gt;</span></span><br><span class="line"><span class="string">`</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> &#123; codeBlock &#125;;</span><br></pre></td></tr></table></figure>
<h2 id="功能实现"><a href="#功能实现" class="headerlink" title="功能实现"></a>功能实现</h2><h3 id="target-和-currentTarget"><a href="#target-和-currentTarget" class="headerlink" title="target 和 currentTarget"></a>target 和 currentTarget</h3><p>在开始处理这个需求之前, 我们先确定一下事件处理器相关的两个概念, <code>event.target</code> 和 <code>event.currentTarget</code>.  其中 <code>target</code> 表示触发点击事件的元素, <code>currentTarget</code> 表示绑定了事件处理器的元素. 这样看来, 在我们的场景下, <code>target</code> 才是有意义的.</p>
<p>那么是不是直接针对 <code>target</code> 绑定点击事件就可以了呢? 实际情况并不是这样. 根据背景中给出的示例 html, 以下是对应的 DOM 元素和点击所输出的内容.</p>
<p><img src="/posts/images/log.png" alt="log"></p>
<p>生成的 DOM 元素</p>
<p><img src="/posts/images/html.png" alt="dom"></p>
<p>点击输出的内容</p>
<p>会发现, inner 的点击结果是我们所预期的, 但是 outer 的结果, 并不是. 令人难过的是, outer 的场景, 在实际情况下出现的概率很高. 因此我们不能简单地使用 <code>target</code> 来实现这个需求.</p>
<h3 id="找到约定的目标元素"><a href="#找到约定的目标元素" class="headerlink" title="找到约定的目标元素"></a>找到约定的目标元素</h3><p>从以上例子中可以看出来, 通过 <code>.moreLink</code> 找到所有需要被绑定点击事件的元素(后面称之为 <code>.moreLink</code> 元素)之后, 我们要对比<code>.moreLink</code>元素与 <code>event.target</code> 的关系, 如果两者一致, 或者<code>.moreLink</code>元素是 <code>event.target</code> 的父元素, 那么我们就给这个 <code>.moreLink</code> 绑定上事件处理器.</p>
<p>接下来开始实现, 由于我们做的事情跟事件委托很相似, 因此我们把实现这部分功能的 hook 命名为: <code>useDelegateEvent</code> </p>
<h3 id="useDelegateEvent"><a href="#useDelegateEvent" class="headerlink" title="useDelegateEvent"></a>useDelegateEvent</h3><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; useEffect, useRef &#125; <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> useDelegateEvent = <span class="function">(<span class="params">type, selector, handler</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> ref = useRef();</span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> element = ref.current;</span><br><span class="line">    <span class="keyword">if</span> (!element) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">let</span> handleEvent = <span class="function"><span class="params">event</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">let</span> targetNode = getTargetNode(element, event.target, selector);</span><br><span class="line">      <span class="keyword">if</span> (targetNode) handler(event, targetNode);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    element.addEventListener(type, handleEvent, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      element.removeEventListener(type, handleEvent, <span class="literal">false</span>);</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;, [type, selector, handler]);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> ref;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> useDelegateEvent;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> getTargetNode = <span class="function">(<span class="params">container, target, selector</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> elemList = container.querySelectorAll(selector);</span><br><span class="line">  <span class="keyword">let</span> targetNode = <span class="built_in">Array</span>.from(elemList).find(<span class="function"><span class="params">elem</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> isDescendant(elem, target);</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">return</span> targetNode;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> isDescendant = <span class="function">(<span class="params">parent, child</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (parent === child) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  <span class="keyword">let</span> node = child.parentNode;</span><br><span class="line">  <span class="keyword">while</span> (node != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (node === parent) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    node = node.parentNode;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><code>CustomCode</code> 组件:</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; useMemo &#125; <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">import</span> useAttachScript <span class="keyword">from</span> <span class="string">"../hooks/useAttachScript"</span>;</span><br><span class="line"><span class="keyword">import</span> useDelegateEvent <span class="keyword">from</span> <span class="string">"../hooks/useDelegateEvent"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; separateScript &#125; <span class="keyword">from</span> <span class="string">"../utils"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 由于客户端渲染的情况下使用  dangerouslySetInnerHTML 渲染的 script 标签中的代码无法执行</span></span><br><span class="line"><span class="comment"> * 因此需要分离 html 与 script</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">CustomCode</span>(<span class="params">props</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; codeBlock &#125; = props;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> [scriptStrList, markup] = useMemo(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> separateScript(codeBlock);</span><br><span class="line">  &#125;, [codeBlock]);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> eventType = <span class="string">"click"</span>;</span><br><span class="line">  <span class="keyword">let</span> selector = <span class="string">".moreLink"</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> ref = useDelegateEvent(eventType, selector, (e, targetNode) =&gt; &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> clickLinkHttp = targetNode.getAttribute(<span class="string">"data-url"</span>);</span><br><span class="line">    <span class="keyword">let</span> clickLinkApp = targetNode.getAttribute(<span class="string">"data-appurl"</span>);</span><br><span class="line">    <span class="keyword">let</span> clickLinkMiniProgram = targetNode.getAttribute(<span class="string">"data-miniprogramurl"</span>);</span><br><span class="line"></span><br><span class="line">    handleClick(&#123;</span><br><span class="line">      clickLinkHttp,</span><br><span class="line">      clickLinkApp,</span><br><span class="line">      clickLinkMiniProgram</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  useAttachScript(scriptStrList);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">dangerouslySetInnerHTML</span>=<span class="string">&#123;&#123;</span> <span class="attr">__html:</span> <span class="attr">markup</span> &#125;&#125; <span class="attr">ref</span>=<span class="string">&#123;ref&#125;</span> /&gt;</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> handleClick = <span class="function"><span class="params">options</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 针对多个链接区分平台的点击处理, 这里不展开</span></span><br><span class="line">  <span class="built_in">console</span>.log(options);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>最终代码示例: <a href="https://github.com/icyfish/react-app/blob/master/src/hooks/useDelegateEvent.js" target="_blank" rel="noopener">Github Repo</a></p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="https://stackoverflow.com/questions/10086427/what-is-the-exact-difference-between-currenttarget-property-and-target-property" target="_blank" rel="noopener">What is the exact difference between currentTarget property and target property in javascript</a></li>
<li><a href="https://zh.javascript.info/event-delegation" target="_blank" rel="noopener">事件委托</a></li>
</ul>
</div></article></div></main><footer><div class="paginator"><a href="/posts/2021/06/07/before-you-memo/" class="prev">PREV</a><a href="/posts/2021/04/19/ssr-render-html-string/" class="next">NEXT</a></div><div class="copyright"><p>© 2019 - 2023 <a href="https://icyfish.github.io/posts">Fish</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>